\hypertarget{kmp__barrier_8cpp}{\section{kmp\-\_\-barrier.\-cpp File Reference}
\label{kmp__barrier_8cpp}\index{kmp\-\_\-barrier.\-cpp@{kmp\-\_\-barrier.\-cpp}}
}
{\ttfamily \#include \char`\"{}kmp.\-h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}kmp\-\_\-wait\-\_\-release.\-h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}kmp\-\_\-stats.\-h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}kmp\-\_\-itt.\-h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}kmp\-\_\-os.\-h\char`\"{}}\\*
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{kmp__barrier_8cpp_a041fcfa491f1f402a50d53fb23c915bb}{ngo\-\_\-load}(src)~((\hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void})0)
\item 
\#define \hyperlink{kmp__barrier_8cpp_a12530abe295809b23e5f414fa302448b}{ngo\-\_\-store\-\_\-icvs}(dst, src)~\hyperlink{kmp_8h_a87574bd68566bdaab6ba1cd63223ab46}{copy\-\_\-icvs}((dst), (src))
\item 
\#define \hyperlink{kmp__barrier_8cpp_a25d24e5f9e2808df3b1cb08d2850704c}{ngo\-\_\-store\-\_\-go}(dst, src)~\hyperlink{kmp__safe__c__api_8h_ab63a75e8bb537bb3ae55c05d0a3b7ca0}{K\-M\-P\-\_\-\-M\-E\-M\-C\-P\-Y}((dst), (src), \hyperlink{kmp__os_8h_a86194c659a2d795e5f5949d293ae4661}{C\-A\-C\-H\-E\-\_\-\-L\-I\-N\-E})
\item 
\#define \hyperlink{kmp__barrier_8cpp_a303ca33adc792fd05f7da5d34b75aa4c}{ngo\-\_\-sync}()~((\hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void})0)
\item 
\#define \hyperlink{kmp__barrier_8cpp_a19045921b49a4718ce57065c5cbfd087}{K\-M\-P\-\_\-\-R\-E\-V\-E\-R\-S\-E\-\_\-\-H\-Y\-P\-E\-R\-\_\-\-B\-A\-R}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} \hyperlink{kmp__barrier_8cpp_a8c4e5bfa41738c5f588746983ee491a9}{\-\_\-\-\_\-kmp\-\_\-print\-\_\-structure} (\hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void})
\item 
static \hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} \hyperlink{kmp__barrier_8cpp_a86dab93f80bfcc456e2cd2c5608962f6}{\-\_\-\-\_\-kmp\-\_\-linear\-\_\-barrier\-\_\-gather} (enum \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cf}{barrier\-\_\-type} bt, \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\-\_\-info\-\_\-t} $\ast$this\-\_\-thr, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} gtid, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} tid, \hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void}($\ast$reduce)(\hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} $\ast$, \hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} $\ast$) \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{U\-S\-E\-\_\-\-I\-T\-T\-\_\-\-B\-U\-I\-L\-D\-\_\-\-A\-R\-G}(\hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} $\ast$itt\-\_\-sync\-\_\-obj))
\item 
static \hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} \hyperlink{kmp__barrier_8cpp_afccbeffe4e07fbe7ccf6b622b5bea2f4}{\-\_\-\-\_\-kmp\-\_\-linear\-\_\-barrier\-\_\-release} (enum \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cf}{barrier\-\_\-type} bt, \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\-\_\-info\-\_\-t} $\ast$this\-\_\-thr, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} gtid, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} tid, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} propagate\-\_\-icvs \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{U\-S\-E\-\_\-\-I\-T\-T\-\_\-\-B\-U\-I\-L\-D\-\_\-\-A\-R\-G}(\hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} $\ast$itt\-\_\-sync\-\_\-obj))
\item 
static \hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} \hyperlink{kmp__barrier_8cpp_a7055b9bc973e4cab4e2b3144d0da2e6d}{\-\_\-\-\_\-kmp\-\_\-tree\-\_\-barrier\-\_\-gather} (enum \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cf}{barrier\-\_\-type} bt, \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\-\_\-info\-\_\-t} $\ast$this\-\_\-thr, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} gtid, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} tid, \hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void}($\ast$reduce)(\hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} $\ast$, \hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} $\ast$) \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{U\-S\-E\-\_\-\-I\-T\-T\-\_\-\-B\-U\-I\-L\-D\-\_\-\-A\-R\-G}(\hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} $\ast$itt\-\_\-sync\-\_\-obj))
\item 
static \hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} \hyperlink{kmp__barrier_8cpp_a077185278bc81fb20a160dbeb7419e8c}{\-\_\-\-\_\-kmp\-\_\-tree\-\_\-barrier\-\_\-release} (enum \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cf}{barrier\-\_\-type} bt, \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\-\_\-info\-\_\-t} $\ast$this\-\_\-thr, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} gtid, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} tid, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} propagate\-\_\-icvs \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{U\-S\-E\-\_\-\-I\-T\-T\-\_\-\-B\-U\-I\-L\-D\-\_\-\-A\-R\-G}(\hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} $\ast$itt\-\_\-sync\-\_\-obj))
\item 
static \hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} \hyperlink{kmp__barrier_8cpp_a53561cb5f3b4a1b71eb128e83ac2a4b0}{\-\_\-\-\_\-kmp\-\_\-hyper\-\_\-barrier\-\_\-gather} (enum \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cf}{barrier\-\_\-type} bt, \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\-\_\-info\-\_\-t} $\ast$this\-\_\-thr, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} gtid, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} tid, \hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void}($\ast$reduce)(\hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} $\ast$, \hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} $\ast$) \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{U\-S\-E\-\_\-\-I\-T\-T\-\_\-\-B\-U\-I\-L\-D\-\_\-\-A\-R\-G}(\hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} $\ast$itt\-\_\-sync\-\_\-obj))
\item 
static \hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} \hyperlink{kmp__barrier_8cpp_a9bfd86466cb84b77a7bff00f0f1015b6}{\-\_\-\-\_\-kmp\-\_\-hyper\-\_\-barrier\-\_\-release} (enum \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cf}{barrier\-\_\-type} bt, \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\-\_\-info\-\_\-t} $\ast$this\-\_\-thr, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} gtid, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} tid, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} propagate\-\_\-icvs \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{U\-S\-E\-\_\-\-I\-T\-T\-\_\-\-B\-U\-I\-L\-D\-\_\-\-A\-R\-G}(\hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} $\ast$itt\-\_\-sync\-\_\-obj))
\item 
static bool \hyperlink{kmp__barrier_8cpp_ade2d153827dde70455637c2763ff361b}{\-\_\-\-\_\-kmp\-\_\-init\-\_\-hierarchical\-\_\-barrier\-\_\-thread} (enum \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cf}{barrier\-\_\-type} bt, \hyperlink{kmp_8h_a1493aa680c299d09746e1edfc9116b24}{kmp\-\_\-bstate\-\_\-t} $\ast$thr\-\_\-bar, kmp\-\_\-uint32 nproc, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} gtid, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} tid, \hyperlink{kmp_8h_a95f7a64bda9b774add6c27c4a7b2a143}{kmp\-\_\-team\-\_\-t} $\ast$team)
\item 
static \hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} \hyperlink{kmp__barrier_8cpp_af7a9e6ac2476553d1fb94039fde53b75}{\-\_\-\-\_\-kmp\-\_\-hierarchical\-\_\-barrier\-\_\-gather} (enum \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cf}{barrier\-\_\-type} bt, \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\-\_\-info\-\_\-t} $\ast$this\-\_\-thr, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} gtid, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} tid, \hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void}($\ast$reduce)(\hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} $\ast$, \hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} $\ast$) \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{U\-S\-E\-\_\-\-I\-T\-T\-\_\-\-B\-U\-I\-L\-D\-\_\-\-A\-R\-G}(\hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} $\ast$itt\-\_\-sync\-\_\-obj))
\item 
static \hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} \hyperlink{kmp__barrier_8cpp_acdc8b64228a7351beeac26310c0316d6}{\-\_\-\-\_\-kmp\-\_\-hierarchical\-\_\-barrier\-\_\-release} (enum \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cf}{barrier\-\_\-type} bt, \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\-\_\-info\-\_\-t} $\ast$this\-\_\-thr, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} gtid, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} tid, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} propagate\-\_\-icvs \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{U\-S\-E\-\_\-\-I\-T\-T\-\_\-\-B\-U\-I\-L\-D\-\_\-\-A\-R\-G}(\hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} $\ast$itt\-\_\-sync\-\_\-obj))
\item 
\hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} \hyperlink{kmp__barrier_8cpp_a2db240b744f3af1eb8413df50dbe6118}{\-\_\-\-\_\-kmp\-\_\-barrier} (enum \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cf}{barrier\-\_\-type} bt, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} gtid, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} is\-\_\-split, size\-\_\-t reduce\-\_\-size, \hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} $\ast$reduce\-\_\-data, \hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void}($\ast$reduce)(\hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} $\ast$, \hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} $\ast$))
\item 
\hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} \hyperlink{kmp__barrier_8cpp_a792560d2e886584b5e616ee68d1c5f8a}{\-\_\-\-\_\-kmp\-\_\-end\-\_\-split\-\_\-barrier} (enum \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cf}{barrier\-\_\-type} bt, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} gtid)
\item 
\hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} \hyperlink{kmp__barrier_8cpp_a5e8f7c63d5e652f73e8998922edf14a4}{\-\_\-\-\_\-kmp\-\_\-join\-\_\-barrier} (\hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} gtid)
\item 
\hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} \hyperlink{kmp__barrier_8cpp_aea1108b093169cef205a6766bdfa5a40}{\-\_\-\-\_\-kmp\-\_\-fork\-\_\-barrier} (\hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} gtid, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} tid)
\item 
\hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void} \hyperlink{kmp__barrier_8cpp_a3cb36a9e9ab38ef825b47442b4f78bc7}{\-\_\-\-\_\-kmp\-\_\-setup\-\_\-icv\-\_\-copy} (\hyperlink{kmp_8h_a95f7a64bda9b774add6c27c4a7b2a143}{kmp\-\_\-team\-\_\-t} $\ast$team, \hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int} new\-\_\-nproc, \hyperlink{kmp_8h_aeee976c9503b72fe3e38d18d88b305cf}{kmp\-\_\-internal\-\_\-control\-\_\-t} $\ast$new\-\_\-icvs, \hyperlink{group__BASIC__TYPES_ga690fda6b92f039a72db263c6b4394ddb}{ident\-\_\-t} $\ast$loc)
\end{DoxyCompactItemize}


\subsection{Macro Definition Documentation}
\hypertarget{kmp__barrier_8cpp_a19045921b49a4718ce57065c5cbfd087}{\index{kmp\-\_\-barrier.\-cpp@{kmp\-\_\-barrier.\-cpp}!K\-M\-P\-\_\-\-R\-E\-V\-E\-R\-S\-E\-\_\-\-H\-Y\-P\-E\-R\-\_\-\-B\-A\-R@{K\-M\-P\-\_\-\-R\-E\-V\-E\-R\-S\-E\-\_\-\-H\-Y\-P\-E\-R\-\_\-\-B\-A\-R}}
\index{K\-M\-P\-\_\-\-R\-E\-V\-E\-R\-S\-E\-\_\-\-H\-Y\-P\-E\-R\-\_\-\-B\-A\-R@{K\-M\-P\-\_\-\-R\-E\-V\-E\-R\-S\-E\-\_\-\-H\-Y\-P\-E\-R\-\_\-\-B\-A\-R}!kmp_barrier.cpp@{kmp\-\_\-barrier.\-cpp}}
\subsubsection[{K\-M\-P\-\_\-\-R\-E\-V\-E\-R\-S\-E\-\_\-\-H\-Y\-P\-E\-R\-\_\-\-B\-A\-R}]{\setlength{\rightskip}{0pt plus 5cm}\#define K\-M\-P\-\_\-\-R\-E\-V\-E\-R\-S\-E\-\_\-\-H\-Y\-P\-E\-R\-\_\-\-B\-A\-R}}\label{kmp__barrier_8cpp_a19045921b49a4718ce57065c5cbfd087}


Definition at line 521 of file kmp\-\_\-barrier.\-cpp.

\hypertarget{kmp__barrier_8cpp_a041fcfa491f1f402a50d53fb23c915bb}{\index{kmp\-\_\-barrier.\-cpp@{kmp\-\_\-barrier.\-cpp}!ngo\-\_\-load@{ngo\-\_\-load}}
\index{ngo\-\_\-load@{ngo\-\_\-load}!kmp_barrier.cpp@{kmp\-\_\-barrier.\-cpp}}
\subsubsection[{ngo\-\_\-load}]{\setlength{\rightskip}{0pt plus 5cm}\#define ngo\-\_\-load(
\begin{DoxyParamCaption}
\item[{}]{src}
\end{DoxyParamCaption}
)~(({\bf void})0)}}\label{kmp__barrier_8cpp_a041fcfa491f1f402a50d53fb23c915bb}


Definition at line 35 of file kmp\-\_\-barrier.\-cpp.



Referenced by \-\_\-\-\_\-kmp\-\_\-hierarchical\-\_\-barrier\-\_\-release(), \-\_\-\-\_\-kmp\-\_\-linear\-\_\-barrier\-\_\-release(), and \-\_\-\-\_\-kmp\-\_\-setup\-\_\-icv\-\_\-copy().

\hypertarget{kmp__barrier_8cpp_a25d24e5f9e2808df3b1cb08d2850704c}{\index{kmp\-\_\-barrier.\-cpp@{kmp\-\_\-barrier.\-cpp}!ngo\-\_\-store\-\_\-go@{ngo\-\_\-store\-\_\-go}}
\index{ngo\-\_\-store\-\_\-go@{ngo\-\_\-store\-\_\-go}!kmp_barrier.cpp@{kmp\-\_\-barrier.\-cpp}}
\subsubsection[{ngo\-\_\-store\-\_\-go}]{\setlength{\rightskip}{0pt plus 5cm}\#define ngo\-\_\-store\-\_\-go(
\begin{DoxyParamCaption}
\item[{}]{dst, }
\item[{}]{src}
\end{DoxyParamCaption}
)~{\bf K\-M\-P\-\_\-\-M\-E\-M\-C\-P\-Y}((dst), (src), {\bf C\-A\-C\-H\-E\-\_\-\-L\-I\-N\-E})}}\label{kmp__barrier_8cpp_a25d24e5f9e2808df3b1cb08d2850704c}


Definition at line 37 of file kmp\-\_\-barrier.\-cpp.



Referenced by \-\_\-\-\_\-kmp\-\_\-hierarchical\-\_\-barrier\-\_\-release().

\hypertarget{kmp__barrier_8cpp_a12530abe295809b23e5f414fa302448b}{\index{kmp\-\_\-barrier.\-cpp@{kmp\-\_\-barrier.\-cpp}!ngo\-\_\-store\-\_\-icvs@{ngo\-\_\-store\-\_\-icvs}}
\index{ngo\-\_\-store\-\_\-icvs@{ngo\-\_\-store\-\_\-icvs}!kmp_barrier.cpp@{kmp\-\_\-barrier.\-cpp}}
\subsubsection[{ngo\-\_\-store\-\_\-icvs}]{\setlength{\rightskip}{0pt plus 5cm}\#define ngo\-\_\-store\-\_\-icvs(
\begin{DoxyParamCaption}
\item[{}]{dst, }
\item[{}]{src}
\end{DoxyParamCaption}
)~{\bf copy\-\_\-icvs}((dst), (src))}}\label{kmp__barrier_8cpp_a12530abe295809b23e5f414fa302448b}


Definition at line 36 of file kmp\-\_\-barrier.\-cpp.



Referenced by \-\_\-\-\_\-kmp\-\_\-linear\-\_\-barrier\-\_\-release(), and \-\_\-\-\_\-kmp\-\_\-setup\-\_\-icv\-\_\-copy().

\hypertarget{kmp__barrier_8cpp_a303ca33adc792fd05f7da5d34b75aa4c}{\index{kmp\-\_\-barrier.\-cpp@{kmp\-\_\-barrier.\-cpp}!ngo\-\_\-sync@{ngo\-\_\-sync}}
\index{ngo\-\_\-sync@{ngo\-\_\-sync}!kmp_barrier.cpp@{kmp\-\_\-barrier.\-cpp}}
\subsubsection[{ngo\-\_\-sync}]{\setlength{\rightskip}{0pt plus 5cm}\#define ngo\-\_\-sync(
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)~(({\bf void})0)}}\label{kmp__barrier_8cpp_a303ca33adc792fd05f7da5d34b75aa4c}


Definition at line 38 of file kmp\-\_\-barrier.\-cpp.



Referenced by \-\_\-\-\_\-kmp\-\_\-hierarchical\-\_\-barrier\-\_\-release(), \-\_\-\-\_\-kmp\-\_\-linear\-\_\-barrier\-\_\-release(), and \-\_\-\-\_\-kmp\-\_\-setup\-\_\-icv\-\_\-copy().



\subsection{Function Documentation}
\hypertarget{kmp__barrier_8cpp_a2db240b744f3af1eb8413df50dbe6118}{\index{kmp\-\_\-barrier.\-cpp@{kmp\-\_\-barrier.\-cpp}!\-\_\-\-\_\-kmp\-\_\-barrier@{\-\_\-\-\_\-kmp\-\_\-barrier}}
\index{\-\_\-\-\_\-kmp\-\_\-barrier@{\-\_\-\-\_\-kmp\-\_\-barrier}!kmp_barrier.cpp@{kmp\-\_\-barrier.\-cpp}}
\subsubsection[{\-\_\-\-\_\-kmp\-\_\-barrier}]{\setlength{\rightskip}{0pt plus 5cm}{\bf int} \-\_\-\-\_\-kmp\-\_\-barrier (
\begin{DoxyParamCaption}
\item[{enum {\bf barrier\-\_\-type}}]{bt, }
\item[{{\bf int}}]{gtid, }
\item[{{\bf int}}]{is\-\_\-split, }
\item[{size\-\_\-t}]{reduce\-\_\-size, }
\item[{{\bf void} $\ast$}]{reduce\-\_\-data, }
\item[{{\bf void}($\ast$)({\bf void} $\ast$, {\bf void} $\ast$)}]{reduce}
\end{DoxyParamCaption}
)}}\label{kmp__barrier_8cpp_a2db240b744f3af1eb8413df50dbe6118}


Definition at line 1047 of file kmp\-\_\-barrier.\-cpp.



Referenced by \-\_\-\-\_\-kmpc\-\_\-barrier(), \-\_\-\-\_\-kmpc\-\_\-barrier\-\_\-master(), \-\_\-\-\_\-kmpc\-\_\-barrier\-\_\-master\-\_\-nowait(), \-\_\-\-\_\-kmpc\-\_\-copyprivate(), \-\_\-\-\_\-kmpc\-\_\-end\-\_\-reduce(), \-\_\-\-\_\-kmpc\-\_\-end\-\_\-taskq(), \-\_\-\-\_\-kmpc\-\_\-reduce(), \-\_\-\-\_\-kmpc\-\_\-reduce\-\_\-nowait(), \-\_\-\-\_\-kmpc\-\_\-taskq(), K\-M\-P\-\_\-\-A\-P\-I\-\_\-\-N\-A\-M\-E\-\_\-\-G\-O\-M\-P\-\_\-\-L\-O\-O\-P\-\_\-\-E\-N\-D(), K\-M\-P\-\_\-\-A\-P\-I\-\_\-\-N\-A\-M\-E\-\_\-\-G\-O\-M\-P\-\_\-\-S\-E\-C\-T\-I\-O\-N\-S\-\_\-\-E\-N\-D(), K\-M\-P\-\_\-\-A\-P\-I\-\_\-\-N\-A\-M\-E\-\_\-\-G\-O\-M\-P\-\_\-\-S\-I\-N\-G\-L\-E\-\_\-\-C\-O\-P\-Y\-\_\-\-E\-N\-D(), and K\-M\-P\-\_\-\-A\-P\-I\-\_\-\-N\-A\-M\-E\-\_\-\-G\-O\-M\-P\-\_\-\-S\-I\-N\-G\-L\-E\-\_\-\-C\-O\-P\-Y\-\_\-\-S\-T\-A\-R\-T().


\begin{DoxyCode}
1049 \{
1050     \hyperlink{kmp__stats_8h_a340afca3214165ed1920481f0e8fa67c}{KMP\_TIME\_DEVELOPER\_BLOCK}(KMP\_barrier);
1051     \textcolor{keyword}{register} \textcolor{keywordtype}{int} tid = \hyperlink{kmp_8h_afb8f84fff9682417eb1c484ffbfdc6ee}{\_\_kmp\_tid\_from\_gtid}(gtid);
1052     \textcolor{keyword}{register} \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\_info\_t} *this\_thr = \hyperlink{kmp_8h_a8ba907eb5a2568ff55a49a1504cd3624}{\_\_kmp\_threads}[gtid];
1053     \textcolor{keyword}{register} \hyperlink{unionkmp__team}{kmp\_team\_t} *team = this\_thr->th.th\_team;
1054     \textcolor{keyword}{register} \textcolor{keywordtype}{int} \hyperlink{kmp__i18n_8c_a43c2a109a79fef7e46a0836cdac679ff}{status} = 0;
1055     \hyperlink{structident}{ident\_t} *loc = \hyperlink{kmp_8h_a8ba907eb5a2568ff55a49a1504cd3624}{\_\_kmp\_threads}[gtid]->th.th\_ident;
1056 \textcolor{preprocessor}{#if OMPT\_SUPPORT}
1057 \textcolor{preprocessor}{}    ompt\_task\_id\_t my\_task\_id;
1058     ompt\_parallel\_id\_t my\_parallel\_id;
1059 \textcolor{preprocessor}{#endif}
1060 \textcolor{preprocessor}{}
1061     \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(15, (\textcolor{stringliteral}{"\_\_kmp\_barrier: T#%d(%d:%d) has arrived\(\backslash\)n"},
1062                   gtid, \hyperlink{kmp_8h_a44712b8a86bcc5e3bd49981e5bb3ce6c}{\_\_kmp\_team\_from\_gtid}(gtid)->t.t\_id, 
      \hyperlink{kmp_8h_afb8f84fff9682417eb1c484ffbfdc6ee}{\_\_kmp\_tid\_from\_gtid}(gtid)));
1063 
1064 \textcolor{preprocessor}{#if OMPT\_SUPPORT}
1065 \textcolor{preprocessor}{}    \textcolor{keywordflow}{if} (\hyperlink{ompt-general_8c_a966b31b6d05f79f5495f8d8e71732f68}{ompt\_enabled}) \{
1066 \textcolor{preprocessor}{#if OMPT\_BLAME}
1067 \textcolor{preprocessor}{}        my\_task\_id = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_implicit\_task\_taskdata[tid].ompt\_task\_info.task\_id;
1068         my\_parallel\_id = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.ompt\_team\_info.parallel\_id;
1069 
1070 \textcolor{preprocessor}{#if OMPT\_TRACE}
1071 \textcolor{preprocessor}{}        \textcolor{keywordflow}{if} (this\_thr->th.ompt\_thread\_info.state == ompt\_state\_wait\_single) \{
1072             \textcolor{keywordflow}{if} (\hyperlink{ompt-general_8c_a84a29d89cef82c7c38e1ee1f70ec994f}{ompt\_callbacks}.ompt\_callback(ompt\_event\_single\_others\_end)) \{
1073                 \hyperlink{ompt-general_8c_a84a29d89cef82c7c38e1ee1f70ec994f}{ompt\_callbacks}.ompt\_callback(ompt\_event\_single\_others\_end)(
1074                     my\_parallel\_id, my\_task\_id);
1075             \}
1076         \}
1077 \textcolor{preprocessor}{#endif}
1078 \textcolor{preprocessor}{}        \textcolor{keywordflow}{if} (\hyperlink{ompt-general_8c_a84a29d89cef82c7c38e1ee1f70ec994f}{ompt\_callbacks}.ompt\_callback(ompt\_event\_barrier\_begin)) \{
1079             \hyperlink{ompt-general_8c_a84a29d89cef82c7c38e1ee1f70ec994f}{ompt\_callbacks}.ompt\_callback(ompt\_event\_barrier\_begin)(
1080                 my\_parallel\_id, my\_task\_id);
1081         \}
1082 \textcolor{preprocessor}{#endif}
1083 \textcolor{preprocessor}{}        \textcolor{comment}{// It is OK to report the barrier state after the barrier begin callback.}
1084         \textcolor{comment}{// According to the OMPT specification, a compliant implementation may}
1085         \textcolor{comment}{// even delay reporting this state until the barrier begins to wait.}
1086         this\_thr->th.ompt\_thread\_info.state = ompt\_state\_wait\_barrier;
1087     \}
1088 \textcolor{preprocessor}{#endif}
1089 \textcolor{preprocessor}{}
1090     \textcolor{keywordflow}{if} (! team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_serialized) \{
1091 \textcolor{preprocessor}{#if USE\_ITT\_BUILD}
1092 \textcolor{preprocessor}{}        \textcolor{comment}{// This value will be used in itt notify events below.}
1093         \textcolor{keywordtype}{void} *itt\_sync\_obj = NULL;
1094 \textcolor{preprocessor}{# if USE\_ITT\_NOTIFY}
1095 \textcolor{preprocessor}{}        \textcolor{keywordflow}{if} (\hyperlink{group__sync_gab7f1ba7abf5c98e0e0e0ea53d0e34661}{\_\_itt\_sync\_create\_ptr} || KMP\_ITT\_DEBUG)
1096             itt\_sync\_obj = \_\_kmp\_itt\_barrier\_object(gtid, bt, 1);
1097 \textcolor{preprocessor}{# endif}
1098 \textcolor{preprocessor}{}\textcolor{preprocessor}{#endif }\textcolor{comment}{/* USE\_ITT\_BUILD */}\textcolor{preprocessor}{}
1099 \textcolor{preprocessor}{}        \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a39e87c52fb75a615c2564a822a013a5a}{\_\_kmp\_tasking\_mode} == \hyperlink{kmp_8h_aad1bdfbfac136cfd92611bcee79ca3f2a001d1f241bf760fd902d3fccc21918d3}{tskm\_extra\_barrier}) \{
1100             \hyperlink{kmp_8h_aaada49301d2ae62b774b7d55dd220b5a}{\_\_kmp\_tasking\_barrier}(team, this\_thr, gtid);
1101             \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(15, (\textcolor{stringliteral}{"\_\_kmp\_barrier: T#%d(%d:%d) past tasking barrier\(\backslash\)n"},
1102                           gtid, \hyperlink{kmp_8h_a44712b8a86bcc5e3bd49981e5bb3ce6c}{\_\_kmp\_team\_from\_gtid}(gtid)->t.t\_id, 
      \hyperlink{kmp_8h_afb8f84fff9682417eb1c484ffbfdc6ee}{\_\_kmp\_tid\_from\_gtid}(gtid)));
1103         \}
1104 
1105         \textcolor{comment}{/* Copy the blocktime info to the thread, where \_\_kmp\_wait\_template() can access it when}
1106 \textcolor{comment}{           the team struct is not guaranteed to exist. */}
1107         \textcolor{comment}{// See note about the corresponding code in \_\_kmp\_join\_barrier() being performance-critical.}
1108         \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a3b56e2e90e1539c0b794e4137724bc1c}{\_\_kmp\_dflt\_blocktime} != \hyperlink{kmp_8h_a1ca6c6ce04115f143dc5df627de57958}{KMP\_MAX\_BLOCKTIME}) \{
1109             this\_thr->th.th\_team\_bt\_intervals = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_implicit\_task\_taskdata[tid].td\_icvs.bt\_intervals
      ;
1110             this\_thr->th.th\_team\_bt\_set = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_implicit\_task\_taskdata[tid].td\_icvs.bt\_set;
1111         \}
1112 
1113 \textcolor{preprocessor}{#if USE\_ITT\_BUILD}
1114 \textcolor{preprocessor}{}        \textcolor{keywordflow}{if} (\hyperlink{group__sync_gab7f1ba7abf5c98e0e0e0ea53d0e34661}{\_\_itt\_sync\_create\_ptr} || KMP\_ITT\_DEBUG)
1115             \_\_kmp\_itt\_barrier\_starting(gtid, itt\_sync\_obj);
1116 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* USE\_ITT\_BUILD */}\textcolor{preprocessor}{}
1117 \textcolor{preprocessor}{}\textcolor{preprocessor}{#if USE\_DEBUGGER}
1118 \textcolor{preprocessor}{}        \textcolor{comment}{// Let the debugger know: the thread arrived to the barrier and waiting.}
1119         \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a7a4e2494d803bbee99f23af2117f6dd8}{KMP\_MASTER\_TID}(tid)) \{ \textcolor{comment}{// Master counter is stored in team structure.}
1120             team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_bar[bt].b\_master\_arrived += 1;
1121         \} \textcolor{keywordflow}{else} \{
1122             this\_thr->th.th\_bar[bt].bb.b\_worker\_arrived += 1;
1123         \} \textcolor{comment}{// if}
1124 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* USE\_DEBUGGER */}\textcolor{preprocessor}{}
1125 \textcolor{preprocessor}{}        \textcolor{keywordflow}{if} (reduce != NULL) \{
1126             \textcolor{comment}{//KMP\_DEBUG\_ASSERT( is\_split == TRUE );  // #C69956}
1127             this\_thr->th.th\_local.reduce\_data = reduce\_data;
1128         \}
1129 
1130         \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a7a4e2494d803bbee99f23af2117f6dd8}{KMP\_MASTER\_TID}(tid) && \hyperlink{kmp_8h_a39e87c52fb75a615c2564a822a013a5a}{\_\_kmp\_tasking\_mode} != 
      \hyperlink{kmp_8h_aad1bdfbfac136cfd92611bcee79ca3f2af827998cf4eb3f61723edc4943b86c98}{tskm\_immediate\_exec})
1131             \hyperlink{kmp_8h_af98fb3c3ffb814bf6a38fc90dbe07fcc}{\_\_kmp\_task\_team\_setup}(this\_thr, team, 0); \textcolor{comment}{// use 0 to only setup the
       current team if nthreads > 1}
1132 
1133         \textcolor{keywordflow}{switch} (\hyperlink{kmp_8h_a3919081570d178345aff3877da7dbd8a}{\_\_kmp\_barrier\_gather\_pattern}[bt]) \{
1134         \textcolor{keywordflow}{case} \hyperlink{kmp_8h_afa95b644d435d20b66b1b5a7302dd86aad01aaab58a5ceeebbf8f9d5a170afa33}{bp\_hyper\_bar}: \{
1135             \hyperlink{kmp__debug_8h_a5323a368e8ba273b17c46906dd9ec78c}{KMP\_ASSERT}(\hyperlink{kmp_8h_ac686c46b38f93904467b30f15ec1c15e}{\_\_kmp\_barrier\_gather\_branch\_bits}[bt]); \textcolor{comment}{//
       don't set branch bits to 0; use linear}
1136             \hyperlink{kmp__barrier_8cpp_a53561cb5f3b4a1b71eb128e83ac2a4b0}{\_\_kmp\_hyper\_barrier\_gather}(bt, this\_thr, gtid, tid, reduce
1137                                        \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
1138             \textcolor{keywordflow}{break};
1139         \}
1140         \textcolor{keywordflow}{case} \hyperlink{kmp_8h_afa95b644d435d20b66b1b5a7302dd86aab0183e6c51993f58d4f0af1fb6298c82}{bp\_hierarchical\_bar}: \{
1141             \hyperlink{kmp__barrier_8cpp_af7a9e6ac2476553d1fb94039fde53b75}{\_\_kmp\_hierarchical\_barrier\_gather}(bt, this\_thr, gtid, tid, 
      reduce
1142                                               \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj));
1143             \textcolor{keywordflow}{break};
1144         \}
1145         \textcolor{keywordflow}{case} \hyperlink{kmp_8h_afa95b644d435d20b66b1b5a7302dd86aa64f2941fea2d51b943240075d1db0d64}{bp\_tree\_bar}: \{
1146             \hyperlink{kmp__debug_8h_a5323a368e8ba273b17c46906dd9ec78c}{KMP\_ASSERT}(\hyperlink{kmp_8h_ac686c46b38f93904467b30f15ec1c15e}{\_\_kmp\_barrier\_gather\_branch\_bits}[bt]); \textcolor{comment}{//
       don't set branch bits to 0; use linear}
1147             \hyperlink{kmp__barrier_8cpp_a7055b9bc973e4cab4e2b3144d0da2e6d}{\_\_kmp\_tree\_barrier\_gather}(bt, this\_thr, gtid, tid, reduce
1148                                       \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
1149             \textcolor{keywordflow}{break};
1150         \}
1151         \textcolor{keywordflow}{default}: \{
1152             \hyperlink{kmp__barrier_8cpp_a86dab93f80bfcc456e2cd2c5608962f6}{\_\_kmp\_linear\_barrier\_gather}(bt, this\_thr, gtid, tid, reduce
1153                                         \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
1154         \}
1155         \}
1156 
1157         \hyperlink{kmp__os_8h_ab19ae0836bf2f1ac24e5cfc97c6d7d41}{KMP\_MB}();
1158 
1159         \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a7a4e2494d803bbee99f23af2117f6dd8}{KMP\_MASTER\_TID}(tid)) \{
1160             status = 0;
1161             \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a39e87c52fb75a615c2564a822a013a5a}{\_\_kmp\_tasking\_mode} != \hyperlink{kmp_8h_aad1bdfbfac136cfd92611bcee79ca3f2af827998cf4eb3f61723edc4943b86c98}{tskm\_immediate\_exec}) \{
1162                 \hyperlink{kmp_8h_afd36f17a7257b41ac1c0ac640225e292}{\_\_kmp\_task\_team\_wait}(this\_thr, team
1163                                      \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
1164             \}
1165 \textcolor{preprocessor}{#if USE\_DEBUGGER}
1166 \textcolor{preprocessor}{}            \textcolor{comment}{// Let the debugger know: All threads are arrived and starting leaving the barrier.}
1167             team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_bar[bt].b\_team\_arrived += 1;
1168 \textcolor{preprocessor}{#endif}
1169 \textcolor{preprocessor}{}
1170 \textcolor{preprocessor}{#if USE\_ITT\_BUILD}
1171 \textcolor{preprocessor}{}            \textcolor{comment}{/* TODO: In case of split reduction barrier, master thread may send acquired event early,}
1172 \textcolor{comment}{               before the final summation into the shared variable is done (final summation can be a}
1173 \textcolor{comment}{               long operation for array reductions).  */}
1174             \textcolor{keywordflow}{if} (\hyperlink{group__sync_gab7f1ba7abf5c98e0e0e0ea53d0e34661}{\_\_itt\_sync\_create\_ptr} || KMP\_ITT\_DEBUG)
1175                 \_\_kmp\_itt\_barrier\_middle(gtid, itt\_sync\_obj);
1176 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* USE\_ITT\_BUILD */}\textcolor{preprocessor}{}
1177 \textcolor{preprocessor}{}\textcolor{preprocessor}{#if USE\_ITT\_BUILD && USE\_ITT\_NOTIFY}
1178 \textcolor{preprocessor}{}            \textcolor{comment}{// Barrier - report frame end (only if active\_level == 1)}
1179             \textcolor{keywordflow}{if} ((\_\_itt\_frame\_submit\_v3\_ptr || KMP\_ITT\_DEBUG) && \_\_kmp\_forkjoin\_frames\_mode &&
1180 #\textcolor{keywordflow}{if} OMP\_40\_ENABLED
1181                 this\_thr->th.th\_teams\_microtask == NULL &&
1182 #endif
1183                 team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_active\_level == 1)
1184             \{
1185                 kmp\_uint64 cur\_time = \_\_itt\_get\_timestamp();
1186                 \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\_info\_t} **other\_threads = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads;
1187                 \textcolor{keywordtype}{int} nproc = this\_thr->th.th\_team\_nproc;
1188                 \textcolor{keywordtype}{int} \hyperlink{kmp__stub_8c_a08582ce460e3d5e1cf0b7fea017d608e}{i};
1189                 \textcolor{keywordflow}{switch}(\_\_kmp\_forkjoin\_frames\_mode) \{
1190                 \textcolor{keywordflow}{case} 1:
1191                     \_\_kmp\_itt\_frame\_submit(gtid, this\_thr->th.th\_frame\_time, cur\_time, 0, loc, nproc);
1192                     this\_thr->th.th\_frame\_time = cur\_time;
1193                     \textcolor{keywordflow}{break};
1194                 \textcolor{keywordflow}{case} 2: \textcolor{comment}{// AC 2015-01-19: currently does not work for hierarchical (to be fixed)}
1195                     \_\_kmp\_itt\_frame\_submit(gtid, this\_thr->th.th\_bar\_min\_time, cur\_time, 1, loc, nproc);
1196                     \textcolor{keywordflow}{break};
1197                 \textcolor{keywordflow}{case} 3:
1198                     \textcolor{keywordflow}{if}( \_\_itt\_metadata\_add\_ptr ) \{
1199                         \textcolor{comment}{// Initialize with master's wait time}
1200                         kmp\_uint64 delta = cur\_time - this\_thr->th.th\_bar\_arrive\_time;
1201                         \textcolor{keywordflow}{for} (i=1; i<nproc; ++\hyperlink{kmp__stub_8c_a08582ce460e3d5e1cf0b7fea017d608e}{i}) \{
1202                             delta += ( cur\_time - other\_threads[\hyperlink{kmp__stub_8c_a08582ce460e3d5e1cf0b7fea017d608e}{i}]->th.th\_bar\_arrive\_time );
1203                         \}
1204                         \_\_kmp\_itt\_metadata\_imbalance(gtid, this\_thr->th.th\_frame\_time, cur\_time, delta, (
      kmp\_uint64)( reduce != NULL));
1205                     \}
1206                     \_\_kmp\_itt\_frame\_submit(gtid, this\_thr->th.th\_frame\_time, cur\_time, 0, loc, nproc);
1207                     this\_thr->th.th\_frame\_time = cur\_time;
1208                     \textcolor{keywordflow}{break};
1209                 \}
1210             \}
1211 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* USE\_ITT\_BUILD */}\textcolor{preprocessor}{}
1212 \textcolor{preprocessor}{}        \} \textcolor{keywordflow}{else} \{
1213             status = 1;
1214 \textcolor{preprocessor}{#if USE\_ITT\_BUILD}
1215 \textcolor{preprocessor}{}            \textcolor{keywordflow}{if} (\hyperlink{group__sync_gab7f1ba7abf5c98e0e0e0ea53d0e34661}{\_\_itt\_sync\_create\_ptr} || KMP\_ITT\_DEBUG)
1216                 \_\_kmp\_itt\_barrier\_middle(gtid, itt\_sync\_obj);
1217 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* USE\_ITT\_BUILD */}\textcolor{preprocessor}{}
1218 \textcolor{preprocessor}{}        \}
1219         \textcolor{keywordflow}{if} (status == 1 || ! is\_split) \{
1220             \textcolor{keywordflow}{switch} (\hyperlink{kmp_8h_af980683a0ac054a7630c0a49fddd9202}{\_\_kmp\_barrier\_release\_pattern}[bt]) \{
1221             \textcolor{keywordflow}{case} \hyperlink{kmp_8h_afa95b644d435d20b66b1b5a7302dd86aad01aaab58a5ceeebbf8f9d5a170afa33}{bp\_hyper\_bar}: \{
1222                 \hyperlink{kmp__debug_8h_a5323a368e8ba273b17c46906dd9ec78c}{KMP\_ASSERT}(\hyperlink{kmp_8h_a80498c680499eb06d890901bada7c2ca}{\_\_kmp\_barrier\_release\_branch\_bits}[bt]
      );
1223                 \hyperlink{kmp__barrier_8cpp_a9bfd86466cb84b77a7bff00f0f1015b6}{\_\_kmp\_hyper\_barrier\_release}(bt, this\_thr, gtid, tid, 
      \hyperlink{kmp_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE}
1224                                             \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
1225                 \textcolor{keywordflow}{break};
1226             \}
1227             \textcolor{keywordflow}{case} \hyperlink{kmp_8h_afa95b644d435d20b66b1b5a7302dd86aab0183e6c51993f58d4f0af1fb6298c82}{bp\_hierarchical\_bar}: \{
1228                 \hyperlink{kmp__barrier_8cpp_acdc8b64228a7351beeac26310c0316d6}{\_\_kmp\_hierarchical\_barrier\_release}(bt, this\_thr, gtid, 
      tid, \hyperlink{kmp_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE}
1229                                                    \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
1230                 \textcolor{keywordflow}{break};
1231             \}
1232             \textcolor{keywordflow}{case} \hyperlink{kmp_8h_afa95b644d435d20b66b1b5a7302dd86aa64f2941fea2d51b943240075d1db0d64}{bp\_tree\_bar}: \{
1233                 \hyperlink{kmp__debug_8h_a5323a368e8ba273b17c46906dd9ec78c}{KMP\_ASSERT}(\hyperlink{kmp_8h_a80498c680499eb06d890901bada7c2ca}{\_\_kmp\_barrier\_release\_branch\_bits}[bt]
      );
1234                 \hyperlink{kmp__barrier_8cpp_a077185278bc81fb20a160dbeb7419e8c}{\_\_kmp\_tree\_barrier\_release}(bt, this\_thr, gtid, tid, 
      \hyperlink{kmp_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE}
1235                                            \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
1236                 \textcolor{keywordflow}{break};
1237             \}
1238             \textcolor{keywordflow}{default}: \{
1239                 \hyperlink{kmp__barrier_8cpp_afccbeffe4e07fbe7ccf6b622b5bea2f4}{\_\_kmp\_linear\_barrier\_release}(bt, this\_thr, gtid, tid, 
      \hyperlink{kmp_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE}
1240                                              \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
1241             \}
1242             \}
1243             \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a39e87c52fb75a615c2564a822a013a5a}{\_\_kmp\_tasking\_mode} != \hyperlink{kmp_8h_aad1bdfbfac136cfd92611bcee79ca3f2af827998cf4eb3f61723edc4943b86c98}{tskm\_immediate\_exec}) \{
1244                 \hyperlink{kmp_8h_a2c905b30d1208bb65979ea579f9b64f1}{\_\_kmp\_task\_team\_sync}(this\_thr, team);
1245             \}
1246         \}
1247 
1248 \textcolor{preprocessor}{#if USE\_ITT\_BUILD}
1249 \textcolor{preprocessor}{}        \textcolor{comment}{/* GEH: TODO: Move this under if-condition above and also include in}
1250 \textcolor{comment}{           \_\_kmp\_end\_split\_barrier(). This will more accurately represent the actual release time}
1251 \textcolor{comment}{           of the threads for split barriers.  */}
1252         \textcolor{keywordflow}{if} (\hyperlink{group__sync_gab7f1ba7abf5c98e0e0e0ea53d0e34661}{\_\_itt\_sync\_create\_ptr} || KMP\_ITT\_DEBUG)
1253             \_\_kmp\_itt\_barrier\_finished(gtid, itt\_sync\_obj);
1254 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* USE\_ITT\_BUILD */}\textcolor{preprocessor}{}
1255 \textcolor{preprocessor}{}    \} \textcolor{keywordflow}{else} \{ \textcolor{comment}{// Team is serialized.}
1256         status = 0;
1257         \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a39e87c52fb75a615c2564a822a013a5a}{\_\_kmp\_tasking\_mode} != \hyperlink{kmp_8h_aad1bdfbfac136cfd92611bcee79ca3f2af827998cf4eb3f61723edc4943b86c98}{tskm\_immediate\_exec}) \{
1258 \textcolor{preprocessor}{#if OMP\_41\_ENABLED}
1259 \textcolor{preprocessor}{}            \textcolor{keywordflow}{if} ( this\_thr->th.th\_task\_team != NULL ) \{
1260                 \textcolor{keywordtype}{void} *itt\_sync\_obj = NULL;
1261 \textcolor{preprocessor}{#if USE\_ITT\_NOTIFY}
1262 \textcolor{preprocessor}{}                \textcolor{keywordflow}{if} (\hyperlink{group__sync_gab7f1ba7abf5c98e0e0e0ea53d0e34661}{\_\_itt\_sync\_create\_ptr} || KMP\_ITT\_DEBUG) \{
1263                     itt\_sync\_obj = \_\_kmp\_itt\_barrier\_object(gtid, bt, 1);
1264                     \_\_kmp\_itt\_barrier\_starting(gtid, itt\_sync\_obj);
1265                 \}
1266 \textcolor{preprocessor}{#endif}
1267 \textcolor{preprocessor}{}
1268                 \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(this\_thr->th.th\_task\_team->tt.tt\_found\_proxy\_tasks == 
      \hyperlink{kmp_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE});
1269                 \hyperlink{kmp_8h_afd36f17a7257b41ac1c0ac640225e292}{\_\_kmp\_task\_team\_wait}(this\_thr, team
1270                                                \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj));
1271                 \hyperlink{kmp_8h_af98fb3c3ffb814bf6a38fc90dbe07fcc}{\_\_kmp\_task\_team\_setup}(this\_thr, team, 0);
1272 
1273 \textcolor{preprocessor}{#if USE\_ITT\_BUILD}
1274 \textcolor{preprocessor}{}                \textcolor{keywordflow}{if} (\hyperlink{group__sync_gab7f1ba7abf5c98e0e0e0ea53d0e34661}{\_\_itt\_sync\_create\_ptr} || KMP\_ITT\_DEBUG)
1275                     \_\_kmp\_itt\_barrier\_finished(gtid, itt\_sync\_obj);
1276 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* USE\_ITT\_BUILD */}\textcolor{preprocessor}{}
1277 \textcolor{preprocessor}{}            \}
1278 \textcolor{preprocessor}{#else}
1279 \textcolor{preprocessor}{}            \textcolor{comment}{// The task team should be NULL for serialized code (tasks will be executed immediately)}
1280             \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_task\_team[this\_thr->th.th\_task\_state] == NULL);
1281             \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(this\_thr->th.th\_task\_team == NULL);
1282 \textcolor{preprocessor}{#endif}
1283 \textcolor{preprocessor}{}        \}
1284     \}
1285     \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(15, (\textcolor{stringliteral}{"\_\_kmp\_barrier: T#%d(%d:%d) is leaving with return value %d\(\backslash\)n"},
1286                   gtid, \hyperlink{kmp_8h_a44712b8a86bcc5e3bd49981e5bb3ce6c}{\_\_kmp\_team\_from\_gtid}(gtid)->t.t\_id, 
      \hyperlink{kmp_8h_afb8f84fff9682417eb1c484ffbfdc6ee}{\_\_kmp\_tid\_from\_gtid}(gtid), status));
1287 
1288 \textcolor{preprocessor}{#if OMPT\_SUPPORT}
1289 \textcolor{preprocessor}{}    \textcolor{keywordflow}{if} (\hyperlink{ompt-general_8c_a966b31b6d05f79f5495f8d8e71732f68}{ompt\_enabled}) \{
1290 \textcolor{preprocessor}{#if OMPT\_BLAME}
1291 \textcolor{preprocessor}{}        \textcolor{keywordflow}{if} (\hyperlink{ompt-general_8c_a84a29d89cef82c7c38e1ee1f70ec994f}{ompt\_callbacks}.ompt\_callback(ompt\_event\_barrier\_end)) \{
1292             \hyperlink{ompt-general_8c_a84a29d89cef82c7c38e1ee1f70ec994f}{ompt\_callbacks}.ompt\_callback(ompt\_event\_barrier\_end)(
1293                 my\_parallel\_id, my\_task\_id);
1294         \}
1295 \textcolor{preprocessor}{#endif}
1296 \textcolor{preprocessor}{}        this\_thr->th.ompt\_thread\_info.state = ompt\_state\_work\_parallel;
1297     \}
1298 \textcolor{preprocessor}{#endif}
1299 \textcolor{preprocessor}{}
1300     \textcolor{keywordflow}{return} \hyperlink{kmp__i18n_8c_a43c2a109a79fef7e46a0836cdac679ff}{status};
1301 \}
\end{DoxyCode}
\hypertarget{kmp__barrier_8cpp_a792560d2e886584b5e616ee68d1c5f8a}{\index{kmp\-\_\-barrier.\-cpp@{kmp\-\_\-barrier.\-cpp}!\-\_\-\-\_\-kmp\-\_\-end\-\_\-split\-\_\-barrier@{\-\_\-\-\_\-kmp\-\_\-end\-\_\-split\-\_\-barrier}}
\index{\-\_\-\-\_\-kmp\-\_\-end\-\_\-split\-\_\-barrier@{\-\_\-\-\_\-kmp\-\_\-end\-\_\-split\-\_\-barrier}!kmp_barrier.cpp@{kmp\-\_\-barrier.\-cpp}}
\subsubsection[{\-\_\-\-\_\-kmp\-\_\-end\-\_\-split\-\_\-barrier}]{\setlength{\rightskip}{0pt plus 5cm}{\bf void} \-\_\-\-\_\-kmp\-\_\-end\-\_\-split\-\_\-barrier (
\begin{DoxyParamCaption}
\item[{enum {\bf barrier\-\_\-type}}]{bt, }
\item[{{\bf int}}]{gtid}
\end{DoxyParamCaption}
)}}\label{kmp__barrier_8cpp_a792560d2e886584b5e616ee68d1c5f8a}


Definition at line 1305 of file kmp\-\_\-barrier.\-cpp.



Referenced by \-\_\-\-\_\-kmpc\-\_\-end\-\_\-barrier\-\_\-master(), \-\_\-\-\_\-kmpc\-\_\-end\-\_\-reduce(), and \-\_\-\-\_\-kmpc\-\_\-end\-\_\-taskq().


\begin{DoxyCode}
1306 \{
1307     \hyperlink{kmp__stats_8h_a340afca3214165ed1920481f0e8fa67c}{KMP\_TIME\_DEVELOPER\_BLOCK}(KMP\_end\_split\_barrier);
1308     \textcolor{keywordtype}{int} tid = \hyperlink{kmp_8h_afb8f84fff9682417eb1c484ffbfdc6ee}{\_\_kmp\_tid\_from\_gtid}(gtid);
1309     \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\_info\_t} *this\_thr = \hyperlink{kmp_8h_a8ba907eb5a2568ff55a49a1504cd3624}{\_\_kmp\_threads}[gtid];
1310     \hyperlink{unionkmp__team}{kmp\_team\_t} *team = this\_thr->th.th\_team;
1311 
1312     \textcolor{keywordflow}{if} (!team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_serialized) \{
1313         \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a996fe75425730b06ff88477bf72b8134}{KMP\_MASTER\_GTID}(gtid)) \{
1314             \textcolor{keywordflow}{switch} (\hyperlink{kmp_8h_af980683a0ac054a7630c0a49fddd9202}{\_\_kmp\_barrier\_release\_pattern}[bt]) \{
1315             \textcolor{keywordflow}{case} \hyperlink{kmp_8h_afa95b644d435d20b66b1b5a7302dd86aad01aaab58a5ceeebbf8f9d5a170afa33}{bp\_hyper\_bar}: \{
1316                 \hyperlink{kmp__debug_8h_a5323a368e8ba273b17c46906dd9ec78c}{KMP\_ASSERT}(\hyperlink{kmp_8h_a80498c680499eb06d890901bada7c2ca}{\_\_kmp\_barrier\_release\_branch\_bits}[bt]
      );
1317                 \hyperlink{kmp__barrier_8cpp_a9bfd86466cb84b77a7bff00f0f1015b6}{\_\_kmp\_hyper\_barrier\_release}(bt, this\_thr, gtid, tid, 
      \hyperlink{kmp_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE}
1318                                             \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(NULL) );
1319                 \textcolor{keywordflow}{break};
1320             \}
1321             \textcolor{keywordflow}{case} \hyperlink{kmp_8h_afa95b644d435d20b66b1b5a7302dd86aab0183e6c51993f58d4f0af1fb6298c82}{bp\_hierarchical\_bar}: \{
1322                 \hyperlink{kmp__barrier_8cpp_acdc8b64228a7351beeac26310c0316d6}{\_\_kmp\_hierarchical\_barrier\_release}(bt, this\_thr, gtid, 
      tid, \hyperlink{kmp_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE}
1323                                                    \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(NULL));
1324                 \textcolor{keywordflow}{break};
1325             \}
1326             \textcolor{keywordflow}{case} \hyperlink{kmp_8h_afa95b644d435d20b66b1b5a7302dd86aa64f2941fea2d51b943240075d1db0d64}{bp\_tree\_bar}: \{
1327                 \hyperlink{kmp__debug_8h_a5323a368e8ba273b17c46906dd9ec78c}{KMP\_ASSERT}(\hyperlink{kmp_8h_a80498c680499eb06d890901bada7c2ca}{\_\_kmp\_barrier\_release\_branch\_bits}[bt]
      );
1328                 \hyperlink{kmp__barrier_8cpp_a077185278bc81fb20a160dbeb7419e8c}{\_\_kmp\_tree\_barrier\_release}(bt, this\_thr, gtid, tid, 
      \hyperlink{kmp_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE}
1329                                            \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(NULL) );
1330                 \textcolor{keywordflow}{break};
1331             \}
1332             \textcolor{keywordflow}{default}: \{
1333                 \hyperlink{kmp__barrier_8cpp_afccbeffe4e07fbe7ccf6b622b5bea2f4}{\_\_kmp\_linear\_barrier\_release}(bt, this\_thr, gtid, tid, 
      \hyperlink{kmp_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE}
1334                                              \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(NULL) );
1335             \}
1336             \}
1337             \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a39e87c52fb75a615c2564a822a013a5a}{\_\_kmp\_tasking\_mode} != \hyperlink{kmp_8h_aad1bdfbfac136cfd92611bcee79ca3f2af827998cf4eb3f61723edc4943b86c98}{tskm\_immediate\_exec}) \{
1338                 \hyperlink{kmp_8h_a2c905b30d1208bb65979ea579f9b64f1}{\_\_kmp\_task\_team\_sync}(this\_thr, team);
1339             \} \textcolor{comment}{// if}
1340         \}
1341     \}
1342 \}
\end{DoxyCode}
\hypertarget{kmp__barrier_8cpp_aea1108b093169cef205a6766bdfa5a40}{\index{kmp\-\_\-barrier.\-cpp@{kmp\-\_\-barrier.\-cpp}!\-\_\-\-\_\-kmp\-\_\-fork\-\_\-barrier@{\-\_\-\-\_\-kmp\-\_\-fork\-\_\-barrier}}
\index{\-\_\-\-\_\-kmp\-\_\-fork\-\_\-barrier@{\-\_\-\-\_\-kmp\-\_\-fork\-\_\-barrier}!kmp_barrier.cpp@{kmp\-\_\-barrier.\-cpp}}
\subsubsection[{\-\_\-\-\_\-kmp\-\_\-fork\-\_\-barrier}]{\setlength{\rightskip}{0pt plus 5cm}{\bf void} \-\_\-\-\_\-kmp\-\_\-fork\-\_\-barrier (
\begin{DoxyParamCaption}
\item[{{\bf int}}]{gtid, }
\item[{{\bf int}}]{tid}
\end{DoxyParamCaption}
)}}\label{kmp__barrier_8cpp_aea1108b093169cef205a6766bdfa5a40}


Definition at line 1541 of file kmp\-\_\-barrier.\-cpp.



Referenced by \-\_\-\-\_\-kmp\-\_\-internal\-\_\-fork(), and \-\_\-\-\_\-kmp\-\_\-launch\-\_\-thread().


\begin{DoxyCode}
1542 \{
1543     \hyperlink{kmp__stats_8h_a340afca3214165ed1920481f0e8fa67c}{KMP\_TIME\_DEVELOPER\_BLOCK}(KMP\_fork\_barrier);
1544     \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\_info\_t} *this\_thr = \hyperlink{kmp_8h_a8ba907eb5a2568ff55a49a1504cd3624}{\_\_kmp\_threads}[gtid];
1545     \hyperlink{unionkmp__team}{kmp\_team\_t} *team = (tid == 0) ? this\_thr->th.th\_team : NULL;
1546 #\textcolor{keywordflow}{if} USE\_ITT\_BUILD
1547     \textcolor{keywordtype}{void} * itt\_sync\_obj = NULL;
1548 #endif \textcolor{comment}{/* USE\_ITT\_BUILD */}
1549 
1550     \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(10, (\textcolor{stringliteral}{"\_\_kmp\_fork\_barrier: T#%d(%d:%d) has arrived\(\backslash\)n"},
1551                   gtid, (team != NULL) ? team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id : -1, tid));
1552 
1553     \textcolor{comment}{// th\_team pointer only valid for master thread here}
1554     \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a7a4e2494d803bbee99f23af2117f6dd8}{KMP\_MASTER\_TID}(tid)) \{
1555 \textcolor{preprocessor}{#if USE\_ITT\_BUILD && USE\_ITT\_NOTIFY}
1556 \textcolor{preprocessor}{}        \textcolor{keywordflow}{if} (\hyperlink{group__sync_gab7f1ba7abf5c98e0e0e0ea53d0e34661}{\_\_itt\_sync\_create\_ptr} || KMP\_ITT\_DEBUG) \{
1557             \textcolor{comment}{// Create itt barrier object}
1558             itt\_sync\_obj  = \_\_kmp\_itt\_barrier\_object(gtid, \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cfab7dbfe1300085e4a7825c809112aaf7c}{bs\_forkjoin\_barrier}, 1);
1559             \_\_kmp\_itt\_barrier\_middle(gtid, itt\_sync\_obj);  \textcolor{comment}{// Call acquired/releasing}
1560         \}
1561 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* USE\_ITT\_BUILD && USE\_ITT\_NOTIFY */}\textcolor{preprocessor}{}
1562 \textcolor{preprocessor}{}
1563 \textcolor{preprocessor}{#ifdef KMP\_DEBUG}
1564 \textcolor{preprocessor}{}        \textcolor{keyword}{register} \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\_info\_t} **other\_threads = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads;
1565         \textcolor{keyword}{register} \textcolor{keywordtype}{int} \hyperlink{kmp__stub_8c_a08582ce460e3d5e1cf0b7fea017d608e}{i};
1566 
1567         \textcolor{comment}{// Verify state}
1568         \hyperlink{kmp__os_8h_ab19ae0836bf2f1ac24e5cfc97c6d7d41}{KMP\_MB}();
1569 
1570         \textcolor{keywordflow}{for}(i=1; i<team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_nproc; ++\hyperlink{kmp__stub_8c_a08582ce460e3d5e1cf0b7fea017d608e}{i}) \{
1571             \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(500, (\textcolor{stringliteral}{"\_\_kmp\_fork\_barrier: T#%d(%d:0) checking T#%d(%d:%d) fork go == %u.\(\backslash\)n"},
1572                            gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, other\_threads[i]->th.th\_info.ds.ds\_gtid,
1573                            team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, other\_threads[i]->th.th\_info.ds.ds\_tid,
1574                            other\_threads[i]->th.th\_bar[\hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cfab7dbfe1300085e4a7825c809112aaf7c}{bs\_forkjoin\_barrier}].bb.b\_go));
1575             \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}((\hyperlink{kmp__os_8h_acd6256e4afba32d90997235fc0a38a74}{TCR\_4}(other\_threads[i]->th.th\_bar[
      \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cfab7dbfe1300085e4a7825c809112aaf7c}{bs\_forkjoin\_barrier}].bb.b\_go)
1576                               & ~(\hyperlink{kmp_8h_a5aea6667969b3c0ec527b73b22aa71e2}{KMP\_BARRIER\_SLEEP\_STATE}))
1577                              == \hyperlink{kmp_8h_abf682c7f66b0baa7f7184ac388224569}{KMP\_INIT\_BARRIER\_STATE});
1578             \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(other\_threads[i]->th.th\_team == team);
1579         \}
1580 \textcolor{preprocessor}{#endif}
1581 \textcolor{preprocessor}{}
1582         \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a39e87c52fb75a615c2564a822a013a5a}{\_\_kmp\_tasking\_mode} != \hyperlink{kmp_8h_aad1bdfbfac136cfd92611bcee79ca3f2af827998cf4eb3f61723edc4943b86c98}{tskm\_immediate\_exec}) \{
1583             \hyperlink{kmp_8h_af98fb3c3ffb814bf6a38fc90dbe07fcc}{\_\_kmp\_task\_team\_setup}(this\_thr, team, 0);  \textcolor{comment}{// 0 indicates setup current
       task team if nthreads > 1}
1584         \}
1585 
1586         \textcolor{comment}{//hash: what is block time? why is the code below performance critical. Is it relevant?}
1587 
1588         \textcolor{comment}{/* The master thread may have changed its blocktime between the join barrier and the}
1589 \textcolor{comment}{           fork barrier. Copy the blocktime info to the thread, where \_\_kmp\_wait\_template() can}
1590 \textcolor{comment}{           access it when the team struct is not guaranteed to exist. */}
1591         \textcolor{comment}{// See note about the corresponding code in \_\_kmp\_join\_barrier() being performance-critical}
1592         \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a3b56e2e90e1539c0b794e4137724bc1c}{\_\_kmp\_dflt\_blocktime} != \hyperlink{kmp_8h_a1ca6c6ce04115f143dc5df627de57958}{KMP\_MAX\_BLOCKTIME}) \{
1593             this\_thr->th.th\_team\_bt\_intervals = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_implicit\_task\_taskdata[tid].td\_icvs.bt\_intervals
      ;
1594             this\_thr->th.th\_team\_bt\_set = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_implicit\_task\_taskdata[tid].td\_icvs.bt\_set;
1595         \}
1596     \} \textcolor{comment}{// master}
1597 
1598     \textcolor{keywordflow}{switch} (\hyperlink{kmp_8h_af980683a0ac054a7630c0a49fddd9202}{\_\_kmp\_barrier\_release\_pattern}[
      \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cfab7dbfe1300085e4a7825c809112aaf7c}{bs\_forkjoin\_barrier}]) \{
1599     \textcolor{keywordflow}{case} \hyperlink{kmp_8h_afa95b644d435d20b66b1b5a7302dd86aad01aaab58a5ceeebbf8f9d5a170afa33}{bp\_hyper\_bar}: \{
1600         \hyperlink{kmp__debug_8h_a5323a368e8ba273b17c46906dd9ec78c}{KMP\_ASSERT}(\hyperlink{kmp_8h_a80498c680499eb06d890901bada7c2ca}{\_\_kmp\_barrier\_release\_branch\_bits}[
      bs\_forkjoin\_barrier]);
1601         \hyperlink{kmp__barrier_8cpp_a9bfd86466cb84b77a7bff00f0f1015b6}{\_\_kmp\_hyper\_barrier\_release}(bs\_forkjoin\_barrier, this\_thr, gtid, tid, 
      \hyperlink{kmp_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE}
1602                                     \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
1603         \textcolor{keywordflow}{break};
1604     \}
1605     \textcolor{keywordflow}{case} \hyperlink{kmp_8h_afa95b644d435d20b66b1b5a7302dd86aab0183e6c51993f58d4f0af1fb6298c82}{bp\_hierarchical\_bar}: \{
1606         \hyperlink{kmp__barrier_8cpp_acdc8b64228a7351beeac26310c0316d6}{\_\_kmp\_hierarchical\_barrier\_release}(bs\_forkjoin\_barrier, this\_thr,
       gtid, tid, \hyperlink{kmp_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE}
1607                                            \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
1608         \textcolor{keywordflow}{break};
1609     \}
1610     \textcolor{keywordflow}{case} \hyperlink{kmp_8h_afa95b644d435d20b66b1b5a7302dd86aa64f2941fea2d51b943240075d1db0d64}{bp\_tree\_bar}: \{
1611         \hyperlink{kmp__debug_8h_a5323a368e8ba273b17c46906dd9ec78c}{KMP\_ASSERT}(\hyperlink{kmp_8h_a80498c680499eb06d890901bada7c2ca}{\_\_kmp\_barrier\_release\_branch\_bits}[
      bs\_forkjoin\_barrier]);
1612         \hyperlink{kmp__barrier_8cpp_a077185278bc81fb20a160dbeb7419e8c}{\_\_kmp\_tree\_barrier\_release}(bs\_forkjoin\_barrier, this\_thr, gtid, tid, 
      \hyperlink{kmp_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE}
1613                                    \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
1614         \textcolor{keywordflow}{break};
1615     \}
1616     \textcolor{keywordflow}{default}: \{
1617         \hyperlink{kmp__barrier_8cpp_afccbeffe4e07fbe7ccf6b622b5bea2f4}{\_\_kmp\_linear\_barrier\_release}(bs\_forkjoin\_barrier, this\_thr, gtid, tid, 
      \hyperlink{kmp_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE}
1618                                      \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
1619     \}
1620     \}
1621 
1622     \textcolor{comment}{// Early exit for reaping threads releasing forkjoin barrier}
1623     \textcolor{keywordflow}{if} (\hyperlink{kmp__os_8h_acd6256e4afba32d90997235fc0a38a74}{TCR\_4}(\hyperlink{kmp_8h_a11b71922a4df46ff9e8dbc68693e8d67}{\_\_kmp\_global}.g.g\_done)) \{
1624         this\_thr->th.th\_task\_team = NULL;
1625 
1626 \textcolor{preprocessor}{#if USE\_ITT\_BUILD && USE\_ITT\_NOTIFY}
1627 \textcolor{preprocessor}{}        \textcolor{keywordflow}{if} (\hyperlink{group__sync_gab7f1ba7abf5c98e0e0e0ea53d0e34661}{\_\_itt\_sync\_create\_ptr} || KMP\_ITT\_DEBUG) \{
1628             \textcolor{keywordflow}{if} (!\hyperlink{kmp_8h_a7a4e2494d803bbee99f23af2117f6dd8}{KMP\_MASTER\_TID}(tid)) \{
1629                 itt\_sync\_obj = \_\_kmp\_itt\_barrier\_object(gtid, bs\_forkjoin\_barrier);
1630                 \textcolor{keywordflow}{if} (itt\_sync\_obj)
1631                     \_\_kmp\_itt\_barrier\_finished(gtid, itt\_sync\_obj);
1632             \}
1633         \}
1634 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* USE\_ITT\_BUILD && USE\_ITT\_NOTIFY */}\textcolor{preprocessor}{}
1635 \textcolor{preprocessor}{}        \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(10, (\textcolor{stringliteral}{"\_\_kmp\_fork\_barrier: T#%d is leaving early\(\backslash\)n"}, gtid));
1636         \textcolor{keywordflow}{return};
1637     \}
1638 
1639     \textcolor{comment}{// hash: is barrier release just passing of the team strucutre from the master to the worker threads.
       Cant be: called per thread created}
1640 
1641     \textcolor{comment}{/* We can now assume that a valid team structure has been allocated by the master and}
1642 \textcolor{comment}{       propagated to all worker threads. The current thread, however, may not be part of the}
1643 \textcolor{comment}{       team, so we can't blindly assume that the team pointer is non-null.  */}
1644     team = (\hyperlink{unionkmp__team}{kmp\_team\_t} *)\hyperlink{kmp__os_8h_a6e40f65c18c7b47fb612607b9bf8fdfc}{TCR\_PTR}(this\_thr->th.th\_team);
1645     \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(team != NULL);
1646     tid = \hyperlink{kmp_8h_afb8f84fff9682417eb1c484ffbfdc6ee}{\_\_kmp\_tid\_from\_gtid}(gtid);
1647 
1648 
1649 \textcolor{preprocessor}{#if KMP\_BARRIER\_ICV\_PULL}
1650 \textcolor{preprocessor}{}    \textcolor{comment}{/* Master thread's copy of the ICVs was set up on the implicit taskdata in}
1651 \textcolor{comment}{       \_\_kmp\_reinitialize\_team. \_\_kmp\_fork\_call() assumes the master thread's implicit task has}
1652 \textcolor{comment}{       this data before this function is called. We cannot modify \_\_kmp\_fork\_call() to look at}
1653 \textcolor{comment}{       the fixed ICVs in the master's thread struct, because it is not always the case that the}
1654 \textcolor{comment}{       threads arrays have been allocated when \_\_kmp\_fork\_call() is executed. */}
1655     \{
1656         \hyperlink{kmp__stats_8h_a340afca3214165ed1920481f0e8fa67c}{KMP\_TIME\_DEVELOPER\_BLOCK}(USER\_icv\_copy);
1657         \textcolor{keywordflow}{if} (!\hyperlink{kmp_8h_a7a4e2494d803bbee99f23af2117f6dd8}{KMP\_MASTER\_TID}(tid)) \{  \textcolor{comment}{// master thread already has ICVs}
1658             \textcolor{comment}{// Copy the initial ICVs from the master's thread struct to the implicit task for this tid.}
1659             \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(10, (\textcolor{stringliteral}{"\_\_kmp\_fork\_barrier: T#%d(%d) is PULLing ICVs\(\backslash\)n"}, gtid, tid));
1660             \hyperlink{kmp_8h_a8387c1b95f3b497a14fc3916515ad4c3}{\_\_kmp\_init\_implicit\_task}(team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_ident, team->
      \hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads[tid], team, tid, \hyperlink{kmp_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE});
1661             \hyperlink{kmp_8h_a87574bd68566bdaab6ba1cd63223ab46}{copy\_icvs}(&team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_implicit\_task\_taskdata[tid].td\_icvs,
1662                       &team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads[0]->th.th\_bar[bs\_forkjoin\_barrier].bb.th\_fixed\_icvs);
1663         \}
1664     \}
1665 \textcolor{preprocessor}{#endif // KMP\_BARRIER\_ICV\_PULL}
1666 \textcolor{preprocessor}{}
1667     \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a39e87c52fb75a615c2564a822a013a5a}{\_\_kmp\_tasking\_mode} != \hyperlink{kmp_8h_aad1bdfbfac136cfd92611bcee79ca3f2af827998cf4eb3f61723edc4943b86c98}{tskm\_immediate\_exec}) \{
1668         \hyperlink{kmp_8h_a2c905b30d1208bb65979ea579f9b64f1}{\_\_kmp\_task\_team\_sync}(this\_thr, team);
1669     \}
1670 
1671 \textcolor{preprocessor}{#if OMP\_40\_ENABLED && KMP\_AFFINITY\_SUPPORTED}
1672 \textcolor{preprocessor}{}    \hyperlink{kmp_8h_ae587debf3f0331e4f824daa05f47a241}{kmp\_proc\_bind\_t} proc\_bind = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_proc\_bind;
1673     \textcolor{keywordflow}{if} (proc\_bind == \hyperlink{kmp_8h_ae587debf3f0331e4f824daa05f47a241a7f6ed2a956308322c1e76ba19ebf2a75}{proc\_bind\_intel}) \{
1674 \textcolor{preprocessor}{#endif}
1675 \textcolor{preprocessor}{}\textcolor{preprocessor}{#if KMP\_AFFINITY\_SUPPORTED}
1676 \textcolor{preprocessor}{}        \textcolor{comment}{// Call dynamic affinity settings}
1677         \textcolor{keywordflow}{if}(\_\_kmp\_affinity\_type == affinity\_balanced && team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_size\_changed) \{
1678             \_\_kmp\_balanced\_affinity(tid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_nproc);
1679         \}
1680 \textcolor{preprocessor}{#endif // KMP\_AFFINITY\_SUPPORTED}
1681 \textcolor{preprocessor}{}\textcolor{preprocessor}{#if OMP\_40\_ENABLED && KMP\_AFFINITY\_SUPPORTED}
1682 \textcolor{preprocessor}{}    \}
1683     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (proc\_bind != \hyperlink{kmp_8h_ae587debf3f0331e4f824daa05f47a241a26efad2e13ae31e934f83c4d9a6ceb99}{proc\_bind\_false}) \{
1684         \textcolor{keywordflow}{if} (this\_thr->th.th\_new\_place == this\_thr->th.th\_current\_place) \{
1685             \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(100, (\textcolor{stringliteral}{"\_\_kmp\_fork\_barrier: T#%d already in correct place %d\(\backslash\)n"},
1686                            \hyperlink{kmp_8h_a31d799169fae2285dc2703faf7f7c258}{\_\_kmp\_gtid\_from\_thread}(this\_thr), this\_thr->th.
      th\_current\_place));
1687         \}
1688         \textcolor{keywordflow}{else} \{
1689             \_\_kmp\_affinity\_set\_place(gtid);
1690         \}
1691     \}
1692 \textcolor{preprocessor}{#endif}
1693 \textcolor{preprocessor}{}
1694 \textcolor{preprocessor}{#if USE\_ITT\_BUILD && USE\_ITT\_NOTIFY}
1695 \textcolor{preprocessor}{}    \textcolor{keywordflow}{if} (\hyperlink{group__sync_gab7f1ba7abf5c98e0e0e0ea53d0e34661}{\_\_itt\_sync\_create\_ptr} || KMP\_ITT\_DEBUG) \{
1696         \textcolor{keywordflow}{if} (!\hyperlink{kmp_8h_a7a4e2494d803bbee99f23af2117f6dd8}{KMP\_MASTER\_TID}(tid)) \{
1697             \textcolor{comment}{// Get correct barrier object}
1698             itt\_sync\_obj = \_\_kmp\_itt\_barrier\_object(gtid, bs\_forkjoin\_barrier);
1699             \_\_kmp\_itt\_barrier\_finished(gtid, itt\_sync\_obj);  \textcolor{comment}{// Workers call acquired}
1700         \} \textcolor{comment}{// (prepare called inside barrier\_release)}
1701     \}
1702 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* USE\_ITT\_BUILD && USE\_ITT\_NOTIFY */}\textcolor{preprocessor}{}
1703 \textcolor{preprocessor}{}    \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(10, (\textcolor{stringliteral}{"\_\_kmp\_fork\_barrier: T#%d(%d:%d) is leaving\(\backslash\)n"}, gtid, team->
      \hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid));
1704 \}
\end{DoxyCode}
\hypertarget{kmp__barrier_8cpp_af7a9e6ac2476553d1fb94039fde53b75}{\index{kmp\-\_\-barrier.\-cpp@{kmp\-\_\-barrier.\-cpp}!\-\_\-\-\_\-kmp\-\_\-hierarchical\-\_\-barrier\-\_\-gather@{\-\_\-\-\_\-kmp\-\_\-hierarchical\-\_\-barrier\-\_\-gather}}
\index{\-\_\-\-\_\-kmp\-\_\-hierarchical\-\_\-barrier\-\_\-gather@{\-\_\-\-\_\-kmp\-\_\-hierarchical\-\_\-barrier\-\_\-gather}!kmp_barrier.cpp@{kmp\-\_\-barrier.\-cpp}}
\subsubsection[{\-\_\-\-\_\-kmp\-\_\-hierarchical\-\_\-barrier\-\_\-gather}]{\setlength{\rightskip}{0pt plus 5cm}static {\bf void} \-\_\-\-\_\-kmp\-\_\-hierarchical\-\_\-barrier\-\_\-gather (
\begin{DoxyParamCaption}
\item[{enum {\bf barrier\-\_\-type}}]{bt, }
\item[{{\bf kmp\-\_\-info\-\_\-t} $\ast$}]{this\-\_\-thr, }
\item[{{\bf int}}]{gtid, }
\item[{{\bf int}}]{tid, }
\item[{{\bf void}($\ast$)({\bf void} $\ast$, {\bf void} $\ast$) {\bf U\-S\-E\-\_\-\-I\-T\-T\-\_\-\-B\-U\-I\-L\-D\-\_\-\-A\-R\-G} reduce({\bf void} $\ast$itt\-\_\-sync\-\_\-obj)}]{}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{kmp__barrier_8cpp_af7a9e6ac2476553d1fb94039fde53b75}


Definition at line 730 of file kmp\-\_\-barrier.\-cpp.



Referenced by \-\_\-\-\_\-kmp\-\_\-barrier(), and \-\_\-\-\_\-kmp\-\_\-join\-\_\-barrier().


\begin{DoxyCode}
733 \{
734     \hyperlink{kmp__stats_8h_a340afca3214165ed1920481f0e8fa67c}{KMP\_TIME\_DEVELOPER\_BLOCK}(KMP\_hier\_gather);
735     \textcolor{keyword}{register} \hyperlink{unionkmp__team}{kmp\_team\_t} *team = this\_thr->th.th\_team;
736     \textcolor{keyword}{register} \hyperlink{kmp_8h_a1493aa680c299d09746e1edfc9116b24}{kmp\_bstate\_t} *thr\_bar = & this\_thr->th.th\_bar[bt].bb;
737     \textcolor{keyword}{register} kmp\_uint32 nproc = this\_thr->th.th\_team\_nproc;
738     \textcolor{keyword}{register} \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\_info\_t} **other\_threads = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads;
739     \textcolor{keyword}{register} kmp\_uint64 new\_state;
740 
741     \textcolor{keywordtype}{int} level = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_level;
742 \textcolor{preprocessor}{#if OMP\_40\_ENABLED}
743 \textcolor{preprocessor}{}    \textcolor{keywordflow}{if} (other\_threads[0]->th.th\_teams\_microtask)    \textcolor{comment}{// are we inside the teams construct?}
744         \textcolor{keywordflow}{if} (this\_thr->th.th\_teams\_size.nteams > 1)
745             ++level; \textcolor{comment}{// level was not increased in teams construct for team\_of\_masters}
746 \textcolor{preprocessor}{#endif}
747 \textcolor{preprocessor}{}    \textcolor{keywordflow}{if} (level == 1) thr\_bar->use\_oncore\_barrier = 1;
748     \textcolor{keywordflow}{else} thr\_bar->use\_oncore\_barrier = 0; \textcolor{comment}{// Do not use oncore barrier when nested}
749 
750     \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_hierarchical\_barrier\_gather: T#%d(%d:%d) enter for barrier type %d\(\backslash\)n"},
751                   gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, bt));
752     \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(this\_thr == other\_threads[this\_thr->th.th\_info.ds.ds\_tid]);
753 
754 \textcolor{preprocessor}{#if USE\_ITT\_BUILD && USE\_ITT\_NOTIFY}
755 \textcolor{preprocessor}{}    \textcolor{comment}{// Barrier imbalance - save arrive time to the thread}
756     \textcolor{keywordflow}{if}(\_\_kmp\_forkjoin\_frames\_mode == 3 || \_\_kmp\_forkjoin\_frames\_mode == 2) \{
757         this\_thr->th.th\_bar\_arrive\_time = \_\_itt\_get\_timestamp();
758     \}
759 \textcolor{preprocessor}{#endif}
760 \textcolor{preprocessor}{}
761     (\hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void})\hyperlink{kmp__barrier_8cpp_ade2d153827dde70455637c2763ff361b}{\_\_kmp\_init\_hierarchical\_barrier\_thread}(bt, thr\_bar, 
      nproc, gtid, tid, team);
762 
763     \textcolor{keywordflow}{if} (thr\_bar->my\_level) \{ \textcolor{comment}{// not a leaf (my\_level==0 means leaf)}
764         \textcolor{keyword}{register} kmp\_int32 child\_tid;
765         new\_state = (kmp\_uint64)team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_bar[bt].b\_arrived + 
      \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP};
766         if (\hyperlink{kmp_8h_a3b56e2e90e1539c0b794e4137724bc1c}{\_\_kmp\_dflt\_blocktime} == \hyperlink{kmp_8h_a1ca6c6ce04115f143dc5df627de57958}{KMP\_MAX\_BLOCKTIME} && thr\_bar->
      use\_oncore\_barrier) \{
767             \textcolor{keywordflow}{if} (thr\_bar->leaf\_kids) \{ \textcolor{comment}{// First, wait for leaf children to check-in on my b\_arrived flag}
768                 kmp\_uint64 leaf\_state = \hyperlink{kmp_8h_a7a4e2494d803bbee99f23af2117f6dd8}{KMP\_MASTER\_TID}(tid) ? thr\_bar->b\_arrived | thr\_bar->
      leaf\_state : team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_bar[bt].b\_arrived | thr\_bar->leaf\_state;
769                 \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_hierarchical\_barrier\_gather: T#%d(%d:%d) waiting for leaf kids
      \(\backslash\)n"},
770                               gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid));
771                 \hyperlink{classkmp__flag__64}{kmp\_flag\_64} flag(&thr\_bar->b\_arrived, leaf\_state);
772                 flag.wait(this\_thr, \hyperlink{kmp_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE}
773                           \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
774                 \textcolor{keywordflow}{if} (reduce) \{
775                     \textcolor{keywordflow}{for} (child\_tid=tid+1; child\_tid<=tid+thr\_bar->leaf\_kids; ++child\_tid) \{
776                         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(100, (\textcolor{stringliteral}{"\_\_kmp\_hierarchical\_barrier\_gather: T#%d(%d:%d) +=
       T#%d(%d:%d)\(\backslash\)n"},
777                                        gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, 
      \hyperlink{kmp_8h_a66d8a210d86c996e250ea9971fe3cd3a}{\_\_kmp\_gtid\_from\_tid}(child\_tid, team),
778                                        team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, child\_tid));
779                         (*reduce)(this\_thr->th.th\_local.reduce\_data, other\_threads[child\_tid]->th.th\_local.
      reduce\_data);
780                     \}
781                 \}
782                 (\hyperlink{ittnotify__static_8h_af941d56e55e3c5465135b60c4d6343ed}{void}) \hyperlink{kmp__os_8h_a57b958c796eb825adfa4e4df2f25b06c}{KMP\_TEST\_THEN\_AND64}((\textcolor{keyword}{volatile} kmp\_int64 *)&thr\_bar->b\_arrived
      , ~(thr\_bar->leaf\_state)); \textcolor{comment}{// clear leaf\_state bits}
783             \}
784             \textcolor{comment}{// Next, wait for higher level children on each child's b\_arrived flag}
785             \textcolor{keywordflow}{for} (kmp\_uint32 \hyperlink{ittnotify__static_8h_a6b8793c3e5dd8bb67b04141713a65d2d}{d}=1; \hyperlink{ittnotify__static_8h_a6b8793c3e5dd8bb67b04141713a65d2d}{d}<thr\_bar->my\_level; ++\hyperlink{ittnotify__static_8h_a6b8793c3e5dd8bb67b04141713a65d2d}{d}) \{ \textcolor{comment}{// gather lowest level threads first, but
       skip 0}
786                 kmp\_uint32 last = tid+thr\_bar->skip\_per\_level[\hyperlink{ittnotify__static_8h_a6b8793c3e5dd8bb67b04141713a65d2d}{d}+1], skip = thr\_bar->skip\_per\_level[
      \hyperlink{ittnotify__static_8h_a6b8793c3e5dd8bb67b04141713a65d2d}{d}];
787                 \textcolor{keywordflow}{if} (last > nproc) last = nproc;
788                 \textcolor{keywordflow}{for} (child\_tid=tid+skip; child\_tid<(\hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int})last; child\_tid+=skip) \{
789                     \textcolor{keyword}{register} \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\_info\_t} *child\_thr = other\_threads[child\_tid];
790                     \textcolor{keyword}{register} \hyperlink{kmp_8h_a1493aa680c299d09746e1edfc9116b24}{kmp\_bstate\_t} *child\_bar = &child\_thr->th.th\_bar[bt].bb;
791                     \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_hierarchical\_barrier\_gather: T#%d(%d:%d) wait T#%d(%d:%d) 
      "}
792                                   \textcolor{stringliteral}{"arrived(%p) == %llu\(\backslash\)n"},
793                                   gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, \hyperlink{kmp_8h_a66d8a210d86c996e250ea9971fe3cd3a}{\_\_kmp\_gtid\_from\_tid}(
      child\_tid, team),
794                                   team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, child\_tid, &child\_bar->b\_arrived, new\_state));
795                     \hyperlink{classkmp__flag__64}{kmp\_flag\_64} flag(&child\_bar->b\_arrived, new\_state);
796                     flag.wait(this\_thr, \hyperlink{kmp_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE}
797                               \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
798                     \textcolor{keywordflow}{if} (reduce) \{
799                         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(100, (\textcolor{stringliteral}{"\_\_kmp\_hierarchical\_barrier\_gather: T#%d(%d:%d) +=
       T#%d(%d:%d)\(\backslash\)n"},
800                                        gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, 
      \hyperlink{kmp_8h_a66d8a210d86c996e250ea9971fe3cd3a}{\_\_kmp\_gtid\_from\_tid}(child\_tid, team),
801                                        team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, child\_tid));
802                         (*reduce)(this\_thr->th.th\_local.reduce\_data, child\_thr->th.th\_local.reduce\_data);
803                     \}
804                 \}
805             \}
806         \}
807         \textcolor{keywordflow}{else} \{ \textcolor{comment}{// Blocktime is not infinite}
808             \textcolor{keywordflow}{for} (kmp\_uint32 \hyperlink{ittnotify__static_8h_a6b8793c3e5dd8bb67b04141713a65d2d}{d}=0; \hyperlink{ittnotify__static_8h_a6b8793c3e5dd8bb67b04141713a65d2d}{d}<thr\_bar->my\_level; ++\hyperlink{ittnotify__static_8h_a6b8793c3e5dd8bb67b04141713a65d2d}{d}) \{ \textcolor{comment}{// Gather lowest level threads first}
809                 kmp\_uint32 last = tid+thr\_bar->skip\_per\_level[\hyperlink{ittnotify__static_8h_a6b8793c3e5dd8bb67b04141713a65d2d}{d}+1], skip = thr\_bar->skip\_per\_level[
      \hyperlink{ittnotify__static_8h_a6b8793c3e5dd8bb67b04141713a65d2d}{d}];
810                 \textcolor{keywordflow}{if} (last > nproc) last = nproc;
811                 \textcolor{keywordflow}{for} (child\_tid=tid+skip; child\_tid<(\hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int})last; child\_tid+=skip) \{
812                     \textcolor{keyword}{register} \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\_info\_t} *child\_thr = other\_threads[child\_tid];
813                     \textcolor{keyword}{register} \hyperlink{kmp_8h_a1493aa680c299d09746e1edfc9116b24}{kmp\_bstate\_t} *child\_bar = &child\_thr->th.th\_bar[bt].bb;
814                     \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_hierarchical\_barrier\_gather: T#%d(%d:%d) wait T#%d(%d:%d) 
      "}
815                                   \textcolor{stringliteral}{"arrived(%p) == %llu\(\backslash\)n"},
816                                   gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, \hyperlink{kmp_8h_a66d8a210d86c996e250ea9971fe3cd3a}{\_\_kmp\_gtid\_from\_tid}(
      child\_tid, team),
817                                   team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, child\_tid, &child\_bar->b\_arrived, new\_state));
818                     \hyperlink{classkmp__flag__64}{kmp\_flag\_64} flag(&child\_bar->b\_arrived, new\_state);
819                     flag.wait(this\_thr, \hyperlink{kmp_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE}
820                               \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
821                     \textcolor{keywordflow}{if} (reduce) \{
822                         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(100, (\textcolor{stringliteral}{"\_\_kmp\_hierarchical\_barrier\_gather: T#%d(%d:%d) +=
       T#%d(%d:%d)\(\backslash\)n"},
823                                        gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, 
      \hyperlink{kmp_8h_a66d8a210d86c996e250ea9971fe3cd3a}{\_\_kmp\_gtid\_from\_tid}(child\_tid, team),
824                                        team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, child\_tid));
825                         (*reduce)(this\_thr->th.th\_local.reduce\_data, child\_thr->th.th\_local.reduce\_data);
826                     \}
827                 \}
828             \}
829         \}
830     \}
831     \textcolor{comment}{// All subordinates are gathered; now release parent if not master thread}
832 
833     \textcolor{keywordflow}{if} (!\hyperlink{kmp_8h_a7a4e2494d803bbee99f23af2117f6dd8}{KMP\_MASTER\_TID}(tid)) \{ \textcolor{comment}{// worker threads release parent in hierarchy}
834         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_hierarchical\_barrier\_gather: T#%d(%d:%d) releasing T#%d(%d:%d) "}
835                       \textcolor{stringliteral}{"arrived(%p): %llu => %llu\(\backslash\)n"}, gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid,
836                       \hyperlink{kmp_8h_a66d8a210d86c996e250ea9971fe3cd3a}{\_\_kmp\_gtid\_from\_tid}(thr\_bar->parent\_tid, team), team->
      \hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, thr\_bar->parent\_tid,
837                       &thr\_bar->b\_arrived, thr\_bar->b\_arrived, thr\_bar->b\_arrived+
      \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP}));
838         \textcolor{comment}{/* Mark arrival to parent: After performing this write, a worker thread may not assume that}
839 \textcolor{comment}{           the team is valid any more - it could be deallocated by the master thread at any time. */}
840         \textcolor{keywordflow}{if} (thr\_bar->my\_level || \hyperlink{kmp_8h_a3b56e2e90e1539c0b794e4137724bc1c}{\_\_kmp\_dflt\_blocktime} != 
      \hyperlink{kmp_8h_a1ca6c6ce04115f143dc5df627de57958}{KMP\_MAX\_BLOCKTIME}
841             || !thr\_bar->use\_oncore\_barrier) \{ \textcolor{comment}{// Parent is waiting on my b\_arrived flag; release it}
842             \hyperlink{classkmp__flag__64}{kmp\_flag\_64} flag(&thr\_bar->b\_arrived, other\_threads[thr\_bar->parent\_tid]);
843             flag.release();
844         \}
845         \textcolor{keywordflow}{else} \{ \textcolor{comment}{// Leaf does special release on the "offset" bits of parent's b\_arrived flag}
846             thr\_bar->b\_arrived = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_bar[bt].b\_arrived + 
      \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP};
847             \hyperlink{classkmp__flag__oncore}{kmp\_flag\_oncore} flag(&thr\_bar->parent\_bar->b\_arrived, thr\_bar->offset);
848             flag.set\_waiter(other\_threads[thr\_bar->parent\_tid]);
849             flag.release();
850         \}
851     \} \textcolor{keywordflow}{else} \{ \textcolor{comment}{// Master thread needs to update the team's b\_arrived value}
852         team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_bar[bt].b\_arrived = new\_state;
853         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_hierarchical\_barrier\_gather: T#%d(%d:%d) set team %d arrived(%p) =
       %llu\(\backslash\)n"},
854                       gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, &team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_bar[bt].b\_arrived, team->
      \hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_bar[bt].b\_arrived));
855     \}
856     \textcolor{comment}{// Is the team access below unsafe or just technically invalid?}
857     \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_hierarchical\_barrier\_gather: T#%d(%d:%d) exit for barrier type %d\(\backslash\)n"},
858                   gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, bt));
859 \}
\end{DoxyCode}
\hypertarget{kmp__barrier_8cpp_acdc8b64228a7351beeac26310c0316d6}{\index{kmp\-\_\-barrier.\-cpp@{kmp\-\_\-barrier.\-cpp}!\-\_\-\-\_\-kmp\-\_\-hierarchical\-\_\-barrier\-\_\-release@{\-\_\-\-\_\-kmp\-\_\-hierarchical\-\_\-barrier\-\_\-release}}
\index{\-\_\-\-\_\-kmp\-\_\-hierarchical\-\_\-barrier\-\_\-release@{\-\_\-\-\_\-kmp\-\_\-hierarchical\-\_\-barrier\-\_\-release}!kmp_barrier.cpp@{kmp\-\_\-barrier.\-cpp}}
\subsubsection[{\-\_\-\-\_\-kmp\-\_\-hierarchical\-\_\-barrier\-\_\-release}]{\setlength{\rightskip}{0pt plus 5cm}static {\bf void} \-\_\-\-\_\-kmp\-\_\-hierarchical\-\_\-barrier\-\_\-release (
\begin{DoxyParamCaption}
\item[{enum {\bf barrier\-\_\-type}}]{bt, }
\item[{{\bf kmp\-\_\-info\-\_\-t} $\ast$}]{this\-\_\-thr, }
\item[{{\bf int}}]{gtid, }
\item[{{\bf int}}]{tid, }
\item[{{\bf int} propagate\-\_\-icvs }]{U\-S\-E\-\_\-\-I\-T\-T\-\_\-\-B\-U\-I\-L\-D\-\_\-\-A\-R\-Gvoid $\ast$itt\-\_\-sync\-\_\-obj}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{kmp__barrier_8cpp_acdc8b64228a7351beeac26310c0316d6}


Definition at line 862 of file kmp\-\_\-barrier.\-cpp.



Referenced by \-\_\-\-\_\-kmp\-\_\-barrier(), \-\_\-\-\_\-kmp\-\_\-end\-\_\-split\-\_\-barrier(), and \-\_\-\-\_\-kmp\-\_\-fork\-\_\-barrier().


\begin{DoxyCode}
865 \{
866     \hyperlink{kmp__stats_8h_a340afca3214165ed1920481f0e8fa67c}{KMP\_TIME\_DEVELOPER\_BLOCK}(KMP\_hier\_release);
867     \textcolor{keyword}{register} \hyperlink{unionkmp__team}{kmp\_team\_t} *team;
868     \textcolor{keyword}{register} \hyperlink{kmp_8h_a1493aa680c299d09746e1edfc9116b24}{kmp\_bstate\_t} *thr\_bar = &this\_thr->th.th\_bar[bt].bb;
869     \textcolor{keyword}{register} kmp\_uint32 nproc;
870     \textcolor{keywordtype}{bool} team\_change = \textcolor{keyword}{false}; \textcolor{comment}{// indicates on-core barrier shouldn't be used}
871 
872     \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a7a4e2494d803bbee99f23af2117f6dd8}{KMP\_MASTER\_TID}(tid)) \{
873         team = \hyperlink{kmp_8h_a8ba907eb5a2568ff55a49a1504cd3624}{\_\_kmp\_threads}[gtid]->th.th\_team;
874         \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(team != NULL);
875         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_hierarchical\_barrier\_release: T#%d(%d:%d) master entered barrier type
       %d\(\backslash\)n"},
876                       gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, bt));
877     \}
878     \textcolor{keywordflow}{else} \{ \textcolor{comment}{// Worker threads}
879         \textcolor{comment}{// Wait for parent thread to release me}
880         \textcolor{keywordflow}{if} (!thr\_bar->use\_oncore\_barrier || \hyperlink{kmp_8h_a3b56e2e90e1539c0b794e4137724bc1c}{\_\_kmp\_dflt\_blocktime} != 
      \hyperlink{kmp_8h_a1ca6c6ce04115f143dc5df627de57958}{KMP\_MAX\_BLOCKTIME}
881             || thr\_bar->my\_level != 0 || thr\_bar->team == NULL) \{
882             \textcolor{comment}{// Use traditional method of waiting on my own b\_go flag}
883             thr\_bar->wait\_flag = \hyperlink{kmp_8h_a8093389a1c4afc4ad0f26ff4d61cddfa}{KMP\_BARRIER\_OWN\_FLAG};
884             \hyperlink{classkmp__flag__64}{kmp\_flag\_64} flag(&thr\_bar->b\_go, \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP});
885             flag.wait(this\_thr, \hyperlink{kmp_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE}
886                       \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
887             \hyperlink{kmp__os_8h_a087c18a4f2ad54d4d1ab3105b2deebbf}{TCW\_8}(thr\_bar->b\_go, \hyperlink{kmp_8h_abf682c7f66b0baa7f7184ac388224569}{KMP\_INIT\_BARRIER\_STATE}); \textcolor{comment}{// Reset my b\_go flag
       for next time}
888         \}
889         \textcolor{keywordflow}{else} \{ \textcolor{comment}{// Thread barrier data is initialized, this is a leaf, blocktime is infinite, not nested}
890             \textcolor{comment}{// Wait on my "offset" bits on parent's b\_go flag}
891             thr\_bar->wait\_flag = \hyperlink{kmp_8h_a8d57cc4e79ac9ca2aec875d9293382e8}{KMP\_BARRIER\_PARENT\_FLAG};
892             \hyperlink{classkmp__flag__oncore}{kmp\_flag\_oncore} flag(&thr\_bar->parent\_bar->b\_go, 
      \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP}, thr\_bar->offset,
893                                  bt, this\_thr
894                                  \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
895             flag.wait(this\_thr, \hyperlink{kmp_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE});
896             \textcolor{keywordflow}{if} (thr\_bar->wait\_flag == \hyperlink{kmp_8h_acedd6aebda7239401f52e069df7f0fc3}{KMP\_BARRIER\_SWITCHING}) \{ \textcolor{comment}{// Thread was switched
       to own b\_go}
897                 \hyperlink{kmp__os_8h_a087c18a4f2ad54d4d1ab3105b2deebbf}{TCW\_8}(thr\_bar->b\_go, \hyperlink{kmp_8h_abf682c7f66b0baa7f7184ac388224569}{KMP\_INIT\_BARRIER\_STATE}); \textcolor{comment}{// Reset my b\_go
       flag for next time}
898             \}
899             \textcolor{keywordflow}{else} \{ \textcolor{comment}{// Reset my bits on parent's b\_go flag}
900                 ((\textcolor{keywordtype}{char}*)&(thr\_bar->parent\_bar->b\_go))[thr\_bar->offset] = 0;
901             \}
902         \}
903         thr\_bar->wait\_flag = \hyperlink{kmp_8h_ac784262f4d5effc56b1cf3a205a7c8c1}{KMP\_BARRIER\_NOT\_WAITING};
904         \textcolor{comment}{// Early exit for reaping threads releasing forkjoin barrier}
905         \textcolor{keywordflow}{if} (bt == \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cfab7dbfe1300085e4a7825c809112aaf7c}{bs\_forkjoin\_barrier} && \hyperlink{kmp__os_8h_acd6256e4afba32d90997235fc0a38a74}{TCR\_4}(
      \hyperlink{kmp_8h_a11b71922a4df46ff9e8dbc68693e8d67}{\_\_kmp\_global}.g.g\_done))
906             \textcolor{keywordflow}{return};
907         \textcolor{comment}{// The worker thread may now assume that the team is valid.}
908         team = \hyperlink{kmp_8h_a8ba907eb5a2568ff55a49a1504cd3624}{\_\_kmp\_threads}[gtid]->th.th\_team;
909         \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(team != NULL);
910         tid = \hyperlink{kmp_8h_afb8f84fff9682417eb1c484ffbfdc6ee}{\_\_kmp\_tid\_from\_gtid}(gtid);
911 
912         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_hierarchical\_barrier\_release: T#%d(%d:%d) set go(%p) = %u\(\backslash\)n"},
913                       gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, &thr\_bar->b\_go, 
      \hyperlink{kmp_8h_abf682c7f66b0baa7f7184ac388224569}{KMP\_INIT\_BARRIER\_STATE}));
914         \hyperlink{kmp__os_8h_ab19ae0836bf2f1ac24e5cfc97c6d7d41}{KMP\_MB}();  \textcolor{comment}{// Flush all pending memory write invalidates.}
915     \}
916 
917     nproc = this\_thr->th.th\_team\_nproc;
918     \textcolor{keywordtype}{int} level = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_level;
919 \textcolor{preprocessor}{#if OMP\_40\_ENABLED}
920 \textcolor{preprocessor}{}    \textcolor{keywordflow}{if} (team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads[0]->th.th\_teams\_microtask ) \{    \textcolor{comment}{// are we inside the teams construct?}
921         \textcolor{keywordflow}{if} (team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_pkfn != (\hyperlink{kmp__os_8h_a390eabec74d95ed005fb6979992598c8}{microtask\_t})\hyperlink{kmp_8h_a1693973bc1f13f7210d814c81815f602}{\_\_kmp\_teams\_master} && this\_thr->th
      .th\_teams\_level == level)
922             ++level; \textcolor{comment}{// level was not increased in teams construct for team\_of\_workers}
923         \textcolor{keywordflow}{if}( this\_thr->th.th\_teams\_size.nteams > 1 )
924             ++level; \textcolor{comment}{// level was not increased in teams construct for team\_of\_masters}
925     \}
926 \textcolor{preprocessor}{#endif}
927 \textcolor{preprocessor}{}    \textcolor{keywordflow}{if} (level == 1) thr\_bar->use\_oncore\_barrier = 1;
928     \textcolor{keywordflow}{else} thr\_bar->use\_oncore\_barrier = 0; \textcolor{comment}{// Do not use oncore barrier when nested}
929 
930     \textcolor{comment}{// If the team size has increased, we still communicate with old leaves via oncore barrier.}
931     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} \textcolor{keywordtype}{int} old\_leaf\_kids = thr\_bar->leaf\_kids;
932     kmp\_uint64 old\_leaf\_state = thr\_bar->leaf\_state;
933     team\_change = \hyperlink{kmp__barrier_8cpp_ade2d153827dde70455637c2763ff361b}{\_\_kmp\_init\_hierarchical\_barrier\_thread}(bt, thr\_bar,
       nproc, gtid, tid, team);
934     \textcolor{comment}{// But if the entire team changes, we won't use oncore barrier at all}
935     \textcolor{keywordflow}{if} (team\_change) old\_leaf\_kids = 0;
936 
937 \textcolor{preprocessor}{#if KMP\_BARRIER\_ICV\_PUSH}
938 \textcolor{preprocessor}{}    \textcolor{keywordflow}{if} (propagate\_icvs) \{
939         \hyperlink{kmp_8h_a8387c1b95f3b497a14fc3916515ad4c3}{\_\_kmp\_init\_implicit\_task}(team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_ident, team->
      \hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads[tid], team, tid, \hyperlink{kmp_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE});
940         \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a7a4e2494d803bbee99f23af2117f6dd8}{KMP\_MASTER\_TID}(tid)) \{ \textcolor{comment}{// master already has copy in final destination; copy}
941             \hyperlink{kmp_8h_a87574bd68566bdaab6ba1cd63223ab46}{copy\_icvs}(&thr\_bar->th\_fixed\_icvs, &team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_implicit\_task\_taskdata[tid].td\_icvs);
942         \}
943         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a3b56e2e90e1539c0b794e4137724bc1c}{\_\_kmp\_dflt\_blocktime} == \hyperlink{kmp_8h_a1ca6c6ce04115f143dc5df627de57958}{KMP\_MAX\_BLOCKTIME} && thr\_bar
      ->use\_oncore\_barrier) \{ \textcolor{comment}{// optimization for inf blocktime}
944             \textcolor{keywordflow}{if} (!thr\_bar->my\_level) \textcolor{comment}{// I'm a leaf in the hierarchy (my\_level==0)}
945                 \textcolor{comment}{// leaves (on-core children) pull parent's fixed ICVs directly to local ICV store}
946                 \hyperlink{kmp_8h_a87574bd68566bdaab6ba1cd63223ab46}{copy\_icvs}(&team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_implicit\_task\_taskdata[tid].td\_icvs,
947                           &thr\_bar->parent\_bar->th\_fixed\_icvs);
948             \textcolor{comment}{// non-leaves will get ICVs piggybacked with b\_go via NGO store}
949         \}
950         \textcolor{keywordflow}{else} \{ \textcolor{comment}{// blocktime is not infinite; pull ICVs from parent's fixed ICVs}
951             \textcolor{keywordflow}{if} (thr\_bar->my\_level) \textcolor{comment}{// not a leaf; copy ICVs to my fixed ICVs child can access}
952                 \hyperlink{kmp_8h_a87574bd68566bdaab6ba1cd63223ab46}{copy\_icvs}(&thr\_bar->th\_fixed\_icvs, &thr\_bar->parent\_bar->th\_fixed\_icvs);
953             \textcolor{keywordflow}{else} \textcolor{comment}{// leaves copy parent's fixed ICVs directly to local ICV store}
954                 \hyperlink{kmp_8h_a87574bd68566bdaab6ba1cd63223ab46}{copy\_icvs}(&team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_implicit\_task\_taskdata[tid].td\_icvs,
955                           &thr\_bar->parent\_bar->th\_fixed\_icvs);
956         \}
957     \}
958 \textcolor{preprocessor}{#endif // KMP\_BARRIER\_ICV\_PUSH}
959 \textcolor{preprocessor}{}
960     \textcolor{comment}{// Now, release my children}
961     \textcolor{keywordflow}{if} (thr\_bar->my\_level) \{ \textcolor{comment}{// not a leaf}
962         \textcolor{keyword}{register} kmp\_int32 child\_tid;
963         kmp\_uint32 last;
964         \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a3b56e2e90e1539c0b794e4137724bc1c}{\_\_kmp\_dflt\_blocktime} == \hyperlink{kmp_8h_a1ca6c6ce04115f143dc5df627de57958}{KMP\_MAX\_BLOCKTIME} && thr\_bar->
      use\_oncore\_barrier) \{
965             \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a7a4e2494d803bbee99f23af2117f6dd8}{KMP\_MASTER\_TID}(tid)) \{ \textcolor{comment}{// do a flat release}
966                 \textcolor{comment}{// Set local b\_go to bump children via NGO store of the cache line containing IVCs and
       b\_go.}
967                 thr\_bar->b\_go = \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP};
968                 \textcolor{comment}{// Use ngo stores if available; b\_go piggybacks in the last 8 bytes of the cache line}
969                 \hyperlink{kmp__barrier_8cpp_a041fcfa491f1f402a50d53fb23c915bb}{ngo\_load}(&thr\_bar->th\_fixed\_icvs);
970                 \textcolor{comment}{// This loops over all the threads skipping only the leaf nodes in the hierarchy}
971                 \textcolor{keywordflow}{for} (child\_tid=thr\_bar->skip\_per\_level[1]; child\_tid<(\textcolor{keywordtype}{int})nproc; child\_tid+=thr\_bar->
      skip\_per\_level[1]) \{
972                     \textcolor{keyword}{register} \hyperlink{kmp_8h_a1493aa680c299d09746e1edfc9116b24}{kmp\_bstate\_t} *child\_bar = &team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads[child\_tid]->th.
      th\_bar[bt].bb;
973                     \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_hierarchical\_barrier\_release: T#%d(%d:%d) releasing
       T#%d(%d:%d)"}
974                                   \textcolor{stringliteral}{" go(%p): %u => %u\(\backslash\)n"},
975                                   gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, \hyperlink{kmp_8h_a66d8a210d86c996e250ea9971fe3cd3a}{\_\_kmp\_gtid\_from\_tid}(
      child\_tid, team),
976                                   team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, child\_tid, &child\_bar->b\_go, child\_bar->b\_go,
977                                   child\_bar->b\_go + \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP}));
978                     \textcolor{comment}{// Use ngo store (if available) to both store ICVs and release child via child's b\_go}
979                     \hyperlink{kmp__barrier_8cpp_a25d24e5f9e2808df3b1cb08d2850704c}{ngo\_store\_go}(&child\_bar->th\_fixed\_icvs, &thr\_bar->th\_fixed\_icvs);
980                 \}
981                 \hyperlink{kmp__barrier_8cpp_a303ca33adc792fd05f7da5d34b75aa4c}{ngo\_sync}();
982             \}
983             \hyperlink{kmp__os_8h_a087c18a4f2ad54d4d1ab3105b2deebbf}{TCW\_8}(thr\_bar->b\_go, \hyperlink{kmp_8h_abf682c7f66b0baa7f7184ac388224569}{KMP\_INIT\_BARRIER\_STATE}); \textcolor{comment}{// Reset my b\_go flag
       for next time}
984             \textcolor{comment}{// Now, release leaf children}
985             \textcolor{keywordflow}{if} (thr\_bar->leaf\_kids) \{ \textcolor{comment}{// if there are any}
986                 \textcolor{comment}{// We test team\_change on the off-chance that the level 1 team changed.}
987                 \textcolor{keywordflow}{if} (team\_change || old\_leaf\_kids < thr\_bar->leaf\_kids) \{ \textcolor{comment}{// some old leaf\_kids, some new}
988                     \textcolor{keywordflow}{if} (old\_leaf\_kids) \{ \textcolor{comment}{// release old leaf kids}
989                         thr\_bar->b\_go |= old\_leaf\_state;
990                     \}
991                     \textcolor{comment}{// Release new leaf kids}
992                     last = tid+thr\_bar->skip\_per\_level[1];
993                     \textcolor{keywordflow}{if} (last > nproc) last = nproc;
994                     \textcolor{keywordflow}{for} (child\_tid=tid+1+old\_leaf\_kids; child\_tid<(\hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int})last; ++child\_tid) \{ \textcolor{comment}{//
       skip\_per\_level[0]=1}
995                         \textcolor{keyword}{register} \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\_info\_t}   *child\_thr = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads[child\_tid];
996                         \textcolor{keyword}{register} \hyperlink{kmp_8h_a1493aa680c299d09746e1edfc9116b24}{kmp\_bstate\_t} *child\_bar = &child\_thr->th.th\_bar[bt].bb;
997                         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_hierarchical\_barrier\_release: T#%d(%d:%d) releasing"}
998                                       \textcolor{stringliteral}{" T#%d(%d:%d) go(%p): %u => %u\(\backslash\)n"},
999                                       gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, 
      \hyperlink{kmp_8h_a66d8a210d86c996e250ea9971fe3cd3a}{\_\_kmp\_gtid\_from\_tid}(child\_tid, team),
1000                                       team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, child\_tid, &child\_bar->b\_go, child\_bar->b\_go,
1001                                       child\_bar->b\_go + \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP}));
1002                         \textcolor{comment}{// Release child using child's b\_go flag}
1003                         \hyperlink{classkmp__flag__64}{kmp\_flag\_64} flag(&child\_bar->b\_go, child\_thr);
1004                         flag.release();
1005                     \}
1006                 \}
1007                 \textcolor{keywordflow}{else} \{ \textcolor{comment}{// Release all children at once with leaf\_state bits on my own b\_go flag}
1008                     thr\_bar->b\_go |= thr\_bar->leaf\_state;
1009                 \}
1010             \}
1011         \}
1012         \textcolor{keywordflow}{else} \{ \textcolor{comment}{// Blocktime is not infinite; do a simple hierarchical release}
1013             \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} \hyperlink{ittnotify__static_8h_a6b8793c3e5dd8bb67b04141713a65d2d}{d}=thr\_bar->my\_level-1; \hyperlink{ittnotify__static_8h_a6b8793c3e5dd8bb67b04141713a65d2d}{d}>=0; --\hyperlink{ittnotify__static_8h_a6b8793c3e5dd8bb67b04141713a65d2d}{d}) \{ \textcolor{comment}{// Release highest level threads first}
1014                 last = tid+thr\_bar->skip\_per\_level[\hyperlink{ittnotify__static_8h_a6b8793c3e5dd8bb67b04141713a65d2d}{d}+1];
1015                 kmp\_uint32 skip = thr\_bar->skip\_per\_level[\hyperlink{ittnotify__static_8h_a6b8793c3e5dd8bb67b04141713a65d2d}{d}];
1016                 \textcolor{keywordflow}{if} (last > nproc) last = nproc;
1017                 \textcolor{keywordflow}{for} (child\_tid=tid+skip; child\_tid<(\hyperlink{ittnotify__static_8h_a8b8dcd723308a8cb5d84277c7a3fff70}{int})last; child\_tid+=skip) \{
1018                     \textcolor{keyword}{register} \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\_info\_t}   *child\_thr = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads[child\_tid];
1019                     \textcolor{keyword}{register} \hyperlink{kmp_8h_a1493aa680c299d09746e1edfc9116b24}{kmp\_bstate\_t} *child\_bar = &child\_thr->th.th\_bar[bt].bb;
1020                     \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_hierarchical\_barrier\_release: T#%d(%d:%d) releasing
       T#%d(%d:%d)"}
1021                                   \textcolor{stringliteral}{" go(%p): %u => %u\(\backslash\)n"},
1022                                   gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, \hyperlink{kmp_8h_a66d8a210d86c996e250ea9971fe3cd3a}{\_\_kmp\_gtid\_from\_tid}(
      child\_tid, team),
1023                                   team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, child\_tid, &child\_bar->b\_go, child\_bar->b\_go,
1024                                   child\_bar->b\_go + \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP}));
1025                     \textcolor{comment}{// Release child using child's b\_go flag}
1026                     \hyperlink{classkmp__flag__64}{kmp\_flag\_64} flag(&child\_bar->b\_go, child\_thr);
1027                     flag.release();
1028                 \}
1029             \}
1030         \}
1031 \textcolor{preprocessor}{#if KMP\_BARRIER\_ICV\_PUSH}
1032 \textcolor{preprocessor}{}        \textcolor{keywordflow}{if} (propagate\_icvs && !\hyperlink{kmp_8h_a7a4e2494d803bbee99f23af2117f6dd8}{KMP\_MASTER\_TID}(tid)) \textcolor{comment}{// non-leaves copy ICVs from fixed ICVs
       to local dest}
1033             \hyperlink{kmp_8h_a87574bd68566bdaab6ba1cd63223ab46}{copy\_icvs}(&team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_implicit\_task\_taskdata[tid].td\_icvs, &thr\_bar->th\_fixed\_icvs);
1034 \textcolor{preprocessor}{#endif // KMP\_BARRIER\_ICV\_PUSH}
1035 \textcolor{preprocessor}{}    \}
1036     \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_hierarchical\_barrier\_release: T#%d(%d:%d) exit for barrier type %d\(\backslash\)n"},
1037                   gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, bt));
1038 \}
\end{DoxyCode}
\hypertarget{kmp__barrier_8cpp_a53561cb5f3b4a1b71eb128e83ac2a4b0}{\index{kmp\-\_\-barrier.\-cpp@{kmp\-\_\-barrier.\-cpp}!\-\_\-\-\_\-kmp\-\_\-hyper\-\_\-barrier\-\_\-gather@{\-\_\-\-\_\-kmp\-\_\-hyper\-\_\-barrier\-\_\-gather}}
\index{\-\_\-\-\_\-kmp\-\_\-hyper\-\_\-barrier\-\_\-gather@{\-\_\-\-\_\-kmp\-\_\-hyper\-\_\-barrier\-\_\-gather}!kmp_barrier.cpp@{kmp\-\_\-barrier.\-cpp}}
\subsubsection[{\-\_\-\-\_\-kmp\-\_\-hyper\-\_\-barrier\-\_\-gather}]{\setlength{\rightskip}{0pt plus 5cm}static {\bf void} \-\_\-\-\_\-kmp\-\_\-hyper\-\_\-barrier\-\_\-gather (
\begin{DoxyParamCaption}
\item[{enum {\bf barrier\-\_\-type}}]{bt, }
\item[{{\bf kmp\-\_\-info\-\_\-t} $\ast$}]{this\-\_\-thr, }
\item[{{\bf int}}]{gtid, }
\item[{{\bf int}}]{tid, }
\item[{{\bf void}($\ast$)({\bf void} $\ast$, {\bf void} $\ast$) {\bf U\-S\-E\-\_\-\-I\-T\-T\-\_\-\-B\-U\-I\-L\-D\-\_\-\-A\-R\-G} reduce({\bf void} $\ast$itt\-\_\-sync\-\_\-obj)}]{}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{kmp__barrier_8cpp_a53561cb5f3b4a1b71eb128e83ac2a4b0}


Definition at line 417 of file kmp\-\_\-barrier.\-cpp.



Referenced by \-\_\-\-\_\-kmp\-\_\-barrier(), and \-\_\-\-\_\-kmp\-\_\-join\-\_\-barrier().


\begin{DoxyCode}
420 \{
421     \hyperlink{kmp__stats_8h_a340afca3214165ed1920481f0e8fa67c}{KMP\_TIME\_DEVELOPER\_BLOCK}(KMP\_hyper\_gather);
422     \textcolor{keyword}{register} \hyperlink{unionkmp__team}{kmp\_team\_t} *team = this\_thr->th.th\_team;
423     \textcolor{keyword}{register} \hyperlink{kmp_8h_a1493aa680c299d09746e1edfc9116b24}{kmp\_bstate\_t} *thr\_bar = &this\_thr->th.th\_bar[bt].bb;
424     \textcolor{keyword}{register} \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\_info\_t} **other\_threads = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads;
425     \textcolor{keyword}{register} kmp\_uint64 new\_state = \hyperlink{kmp_8h_a4a45030334d67f70e8dbf47acb7c1248}{KMP\_BARRIER\_UNUSED\_STATE};
426     \textcolor{keyword}{register} kmp\_uint32 num\_threads = this\_thr->th.th\_team\_nproc;
427     \textcolor{keyword}{register} kmp\_uint32 branch\_bits = \hyperlink{kmp_8h_ac686c46b38f93904467b30f15ec1c15e}{\_\_kmp\_barrier\_gather\_branch\_bits}[bt];
428     \textcolor{keyword}{register} kmp\_uint32 branch\_factor = 1 << branch\_bits;
429     \textcolor{keyword}{register} kmp\_uint32 offset;
430     \textcolor{keyword}{register} kmp\_uint32 level;
431 
432     \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_hyper\_barrier\_gather: T#%d(%d:%d) enter for barrier type %d\(\backslash\)n"},
433                   gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, bt));
434 
435     \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(this\_thr == other\_threads[this\_thr->th.th\_info.ds.ds\_tid]);
436 
437 \textcolor{preprocessor}{#if USE\_ITT\_BUILD && USE\_ITT\_NOTIFY}
438 \textcolor{preprocessor}{}    \textcolor{comment}{// Barrier imbalance - save arrive time to the thread}
439     \textcolor{keywordflow}{if}(\_\_kmp\_forkjoin\_frames\_mode == 3 || \_\_kmp\_forkjoin\_frames\_mode == 2) \{
440         this\_thr->th.th\_bar\_arrive\_time = this\_thr->th.th\_bar\_min\_time = \_\_itt\_get\_timestamp();
441     \}
442 \textcolor{preprocessor}{#endif}
443 \textcolor{preprocessor}{}    \textcolor{comment}{/* Perform a hypercube-embedded tree gather to wait until all of the threads have}
444 \textcolor{comment}{       arrived, and reduce any required data as we go.  */}
445     \hyperlink{classkmp__flag__64}{kmp\_flag\_64} p\_flag(&thr\_bar->b\_arrived);
446     \textcolor{keywordflow}{for} (level=0, offset=1; offset<num\_threads; level+=branch\_bits, offset<<=branch\_bits)
447     \{
448         \textcolor{keyword}{register} kmp\_uint32 child;
449         \textcolor{keyword}{register} kmp\_uint32 child\_tid;
450 
451         \textcolor{keywordflow}{if} (((tid >> level) & (branch\_factor - 1)) != 0) \{
452             \textcolor{keyword}{register} kmp\_int32 parent\_tid = tid & ~((1 << (level + branch\_bits)) -1);
453 
454             \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_hyper\_barrier\_gather: T#%d(%d:%d) releasing T#%d(%d:%d) "}
455                           \textcolor{stringliteral}{"arrived(%p): %llu => %llu\(\backslash\)n"}, gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid,
456                           \hyperlink{kmp_8h_a66d8a210d86c996e250ea9971fe3cd3a}{\_\_kmp\_gtid\_from\_tid}(parent\_tid, team), team->
      \hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, parent\_tid,
457                           &thr\_bar->b\_arrived, thr\_bar->b\_arrived,
458                           thr\_bar->b\_arrived + \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP}));
459             \textcolor{comment}{// Mark arrival to parent thread}
460             \textcolor{comment}{/* After performing this write (in the last iteration of the enclosing for loop),}
461 \textcolor{comment}{               a worker thread may not assume that the team is valid any more - it could be}
462 \textcolor{comment}{               deallocated by the master thread at any time.  */}
463             p\_flag.set\_waiter(other\_threads[parent\_tid]);
464             p\_flag.release();
465             \textcolor{keywordflow}{break};
466         \}
467 
468         \textcolor{comment}{// Parent threads wait for children to arrive}
469         \textcolor{keywordflow}{if} (new\_state == \hyperlink{kmp_8h_a4a45030334d67f70e8dbf47acb7c1248}{KMP\_BARRIER\_UNUSED\_STATE})
470             new\_state = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_bar[bt].b\_arrived + \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP};
471         \textcolor{keywordflow}{for} (child=1, child\_tid=tid+(1 << level); child<branch\_factor && child\_tid<num\_threads;
472              child++, child\_tid+=(1 << level))
473         \{
474             \textcolor{keyword}{register} \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\_info\_t} *child\_thr = other\_threads[child\_tid];
475             \textcolor{keyword}{register} \hyperlink{kmp_8h_a1493aa680c299d09746e1edfc9116b24}{kmp\_bstate\_t} *child\_bar = &child\_thr->th.th\_bar[bt].bb;
476 \textcolor{preprocessor}{#if KMP\_CACHE\_MANAGE}
477 \textcolor{preprocessor}{}            \textcolor{keyword}{register} kmp\_uint32 next\_child\_tid = child\_tid + (1 << level);
478             \textcolor{comment}{// Prefetch next thread's arrived count}
479             \textcolor{keywordflow}{if} (child+1 < branch\_factor && next\_child\_tid < num\_threads)
480                 \hyperlink{kmp__os_8h_a936407f18975a175fbff4bddca4ff389}{KMP\_CACHE\_PREFETCH}(&other\_threads[next\_child\_tid]->th.th\_bar[bt].bb.
      b\_arrived);
481 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* KMP\_CACHE\_MANAGE */}\textcolor{preprocessor}{}
482 \textcolor{preprocessor}{}            \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_hyper\_barrier\_gather: T#%d(%d:%d) wait T#%d(%d:%u) "}
483                           \textcolor{stringliteral}{"arrived(%p) == %llu\(\backslash\)n"}, gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid,
484                           \hyperlink{kmp_8h_a66d8a210d86c996e250ea9971fe3cd3a}{\_\_kmp\_gtid\_from\_tid}(child\_tid, team), team->
      \hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, child\_tid,
485                           &child\_bar->b\_arrived, new\_state));
486             \textcolor{comment}{// Wait for child to arrive}
487             \hyperlink{classkmp__flag__64}{kmp\_flag\_64} c\_flag(&child\_bar->b\_arrived, new\_state);
488             c\_flag.wait(this\_thr, \hyperlink{kmp_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE}
489                         \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
490 \textcolor{preprocessor}{#if USE\_ITT\_BUILD && USE\_ITT\_NOTIFY}
491 \textcolor{preprocessor}{}            \textcolor{comment}{// Barrier imbalance - write min of the thread time and a child time to the thread.}
492             \textcolor{keywordflow}{if} (\_\_kmp\_forkjoin\_frames\_mode == 2) \{
493                 this\_thr->th.th\_bar\_min\_time = \hyperlink{kmp_8h_a635727f200be45c0c7cdc13c991284bf}{KMP\_MIN}(this\_thr->th.th\_bar\_min\_time,
494                                                           child\_thr->th.th\_bar\_min\_time);
495             \}
496 \textcolor{preprocessor}{#endif}
497 \textcolor{preprocessor}{}            \textcolor{keywordflow}{if} (reduce) \{
498                 \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(100, (\textcolor{stringliteral}{"\_\_kmp\_hyper\_barrier\_gather: T#%d(%d:%d) += T#%d(%d:%u)\(\backslash\)n"},
499                                gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, \hyperlink{kmp_8h_a66d8a210d86c996e250ea9971fe3cd3a}{\_\_kmp\_gtid\_from\_tid}(child\_tid, 
      team),
500                                team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, child\_tid));
501                 (*reduce)(this\_thr->th.th\_local.reduce\_data, child\_thr->th.th\_local.reduce\_data);
502             \}
503         \}
504     \}
505 
506     \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a7a4e2494d803bbee99f23af2117f6dd8}{KMP\_MASTER\_TID}(tid)) \{
507         \textcolor{comment}{// Need to update the team arrived pointer if we are the master thread}
508         \textcolor{keywordflow}{if} (new\_state == \hyperlink{kmp_8h_a4a45030334d67f70e8dbf47acb7c1248}{KMP\_BARRIER\_UNUSED\_STATE})
509             team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_bar[bt].b\_arrived += \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP};
510         \textcolor{keywordflow}{else}
511             team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_bar[bt].b\_arrived = new\_state;
512         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_hyper\_barrier\_gather: T#%d(%d:%d) set team %d arrived(%p) = %llu\(\backslash\)n"},
513                       gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id,
514                       &team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_bar[bt].b\_arrived, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_bar[bt].b\_arrived));
515     \}
516     \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_hyper\_barrier\_gather: T#%d(%d:%d) exit for barrier type %d\(\backslash\)n"},
517                   gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, bt));
518 \}
\end{DoxyCode}
\hypertarget{kmp__barrier_8cpp_a9bfd86466cb84b77a7bff00f0f1015b6}{\index{kmp\-\_\-barrier.\-cpp@{kmp\-\_\-barrier.\-cpp}!\-\_\-\-\_\-kmp\-\_\-hyper\-\_\-barrier\-\_\-release@{\-\_\-\-\_\-kmp\-\_\-hyper\-\_\-barrier\-\_\-release}}
\index{\-\_\-\-\_\-kmp\-\_\-hyper\-\_\-barrier\-\_\-release@{\-\_\-\-\_\-kmp\-\_\-hyper\-\_\-barrier\-\_\-release}!kmp_barrier.cpp@{kmp\-\_\-barrier.\-cpp}}
\subsubsection[{\-\_\-\-\_\-kmp\-\_\-hyper\-\_\-barrier\-\_\-release}]{\setlength{\rightskip}{0pt plus 5cm}static {\bf void} \-\_\-\-\_\-kmp\-\_\-hyper\-\_\-barrier\-\_\-release (
\begin{DoxyParamCaption}
\item[{enum {\bf barrier\-\_\-type}}]{bt, }
\item[{{\bf kmp\-\_\-info\-\_\-t} $\ast$}]{this\-\_\-thr, }
\item[{{\bf int}}]{gtid, }
\item[{{\bf int}}]{tid, }
\item[{{\bf int} propagate\-\_\-icvs }]{U\-S\-E\-\_\-\-I\-T\-T\-\_\-\-B\-U\-I\-L\-D\-\_\-\-A\-R\-Gvoid $\ast$itt\-\_\-sync\-\_\-obj}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{kmp__barrier_8cpp_a9bfd86466cb84b77a7bff00f0f1015b6}


Definition at line 523 of file kmp\-\_\-barrier.\-cpp.



Referenced by \-\_\-\-\_\-kmp\-\_\-barrier(), \-\_\-\-\_\-kmp\-\_\-end\-\_\-split\-\_\-barrier(), and \-\_\-\-\_\-kmp\-\_\-fork\-\_\-barrier().


\begin{DoxyCode}
526 \{
527     \hyperlink{kmp__stats_8h_a340afca3214165ed1920481f0e8fa67c}{KMP\_TIME\_DEVELOPER\_BLOCK}(KMP\_hyper\_release);
528     \textcolor{keyword}{register} \hyperlink{unionkmp__team}{kmp\_team\_t}    *team;
529     \textcolor{keyword}{register} \hyperlink{kmp_8h_a1493aa680c299d09746e1edfc9116b24}{kmp\_bstate\_t}  *thr\_bar       = & this\_thr -> th.th\_bar[ bt ].bb;
530     \textcolor{keyword}{register} \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\_info\_t}   **other\_threads;
531     \textcolor{keyword}{register} kmp\_uint32     num\_threads;
532     \textcolor{keyword}{register} kmp\_uint32     branch\_bits   = \hyperlink{kmp_8h_a80498c680499eb06d890901bada7c2ca}{\_\_kmp\_barrier\_release\_branch\_bits}
      [ bt ];
533     \textcolor{keyword}{register} kmp\_uint32     branch\_factor = 1 << branch\_bits;
534     \textcolor{keyword}{register} kmp\_uint32     child;
535     \textcolor{keyword}{register} kmp\_uint32     child\_tid;
536     \textcolor{keyword}{register} kmp\_uint32     offset;
537     \textcolor{keyword}{register} kmp\_uint32     level;
538 
539     \textcolor{comment}{/* Perform a hypercube-embedded tree release for all of the threads that have been gathered.}
540 \textcolor{comment}{       If KMP\_REVERSE\_HYPER\_BAR is defined (default) the threads are released in the reverse}
541 \textcolor{comment}{       order of the corresponding gather, otherwise threads are released in the same order. */}
542     \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a7a4e2494d803bbee99f23af2117f6dd8}{KMP\_MASTER\_TID}(tid)) \{ \textcolor{comment}{// master}
543         team = \hyperlink{kmp_8h_a8ba907eb5a2568ff55a49a1504cd3624}{\_\_kmp\_threads}[gtid]->th.th\_team;
544         \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(team != NULL);
545         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_hyper\_barrier\_release: T#%d(%d:%d) master enter for barrier type %d\(\backslash\)n"}
      ,
546                       gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, bt));
547 \textcolor{preprocessor}{#if KMP\_BARRIER\_ICV\_PUSH}
548 \textcolor{preprocessor}{}        \textcolor{keywordflow}{if} (propagate\_icvs) \{ \textcolor{comment}{// master already has ICVs in final destination; copy}
549             \hyperlink{kmp_8h_a87574bd68566bdaab6ba1cd63223ab46}{copy\_icvs}(&thr\_bar->th\_fixed\_icvs, &team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_implicit\_task\_taskdata[tid].td\_icvs);
550         \}
551 \textcolor{preprocessor}{#endif}
552 \textcolor{preprocessor}{}    \}
553     \textcolor{keywordflow}{else}  \{ \textcolor{comment}{// Handle fork barrier workers who aren't part of a team yet}
554         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_hyper\_barrier\_release: T#%d wait go(%p) == %u\(\backslash\)n"},
555                       gtid, &thr\_bar->b\_go, \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP}));
556         \textcolor{comment}{// Wait for parent thread to release us}
557         \hyperlink{classkmp__flag__64}{kmp\_flag\_64} flag(&thr\_bar->b\_go, \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP});
558         flag.wait(this\_thr, \hyperlink{kmp_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE}
559                   \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
560 \textcolor{preprocessor}{#if USE\_ITT\_BUILD && USE\_ITT\_NOTIFY}
561 \textcolor{preprocessor}{}        \textcolor{keywordflow}{if} ((\hyperlink{group__sync_gab7f1ba7abf5c98e0e0e0ea53d0e34661}{\_\_itt\_sync\_create\_ptr} && itt\_sync\_obj == NULL) || KMP\_ITT\_DEBUG) \{
562             \textcolor{comment}{// In fork barrier where we could not get the object reliably}
563             itt\_sync\_obj = \_\_kmp\_itt\_barrier\_object(gtid, \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cfab7dbfe1300085e4a7825c809112aaf7c}{bs\_forkjoin\_barrier}, 0, -1);
564             \textcolor{comment}{// Cancel wait on previous parallel region...}
565             \_\_kmp\_itt\_task\_starting(itt\_sync\_obj);
566 
567             \textcolor{keywordflow}{if} (bt == \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cfab7dbfe1300085e4a7825c809112aaf7c}{bs\_forkjoin\_barrier} && \hyperlink{kmp__os_8h_acd6256e4afba32d90997235fc0a38a74}{TCR\_4}(
      \hyperlink{kmp_8h_a11b71922a4df46ff9e8dbc68693e8d67}{\_\_kmp\_global}.g.g\_done))
568                 \textcolor{keywordflow}{return};
569 
570             itt\_sync\_obj = \_\_kmp\_itt\_barrier\_object(gtid, \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cfab7dbfe1300085e4a7825c809112aaf7c}{bs\_forkjoin\_barrier});
571             \textcolor{keywordflow}{if} (itt\_sync\_obj != NULL)
572                 \textcolor{comment}{// Call prepare as early as possible for "new" barrier}
573                 \_\_kmp\_itt\_task\_finished(itt\_sync\_obj);
574         \} \textcolor{keywordflow}{else}
575 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* USE\_ITT\_BUILD && USE\_ITT\_NOTIFY */}\textcolor{preprocessor}{}
576 \textcolor{preprocessor}{}        \textcolor{comment}{// Early exit for reaping threads releasing forkjoin barrier}
577         \textcolor{keywordflow}{if} (bt == \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cfab7dbfe1300085e4a7825c809112aaf7c}{bs\_forkjoin\_barrier} && \hyperlink{kmp__os_8h_acd6256e4afba32d90997235fc0a38a74}{TCR\_4}(
      \hyperlink{kmp_8h_a11b71922a4df46ff9e8dbc68693e8d67}{\_\_kmp\_global}.g.g\_done))
578             \textcolor{keywordflow}{return};
579 
580         \textcolor{comment}{// The worker thread may now assume that the team is valid.}
581         team = \hyperlink{kmp_8h_a8ba907eb5a2568ff55a49a1504cd3624}{\_\_kmp\_threads}[gtid]->th.th\_team;
582         \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(team != NULL);
583         tid = \hyperlink{kmp_8h_afb8f84fff9682417eb1c484ffbfdc6ee}{\_\_kmp\_tid\_from\_gtid}(gtid);
584 
585         \hyperlink{kmp__os_8h_ae67779cc7794b5dd7eee4c7f2c7789d4}{TCW\_4}(thr\_bar->b\_go, \hyperlink{kmp_8h_abf682c7f66b0baa7f7184ac388224569}{KMP\_INIT\_BARRIER\_STATE});
586         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_hyper\_barrier\_release: T#%d(%d:%d) set go(%p) = %u\(\backslash\)n"},
587                       gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, &thr\_bar->b\_go, 
      \hyperlink{kmp_8h_abf682c7f66b0baa7f7184ac388224569}{KMP\_INIT\_BARRIER\_STATE}));
588         \hyperlink{kmp__os_8h_ab19ae0836bf2f1ac24e5cfc97c6d7d41}{KMP\_MB}();  \textcolor{comment}{// Flush all pending memory write invalidates.}
589     \}
590     num\_threads = this\_thr->th.th\_team\_nproc;
591     other\_threads = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads;
592 
593 \textcolor{preprocessor}{#ifdef KMP\_REVERSE\_HYPER\_BAR}
594 \textcolor{preprocessor}{}    \textcolor{comment}{// Count up to correct level for parent}
595     \textcolor{keywordflow}{for} (level=0, offset=1; offset<num\_threads && (((tid>>level) & (branch\_factor-1)) == 0);
596          level+=branch\_bits, offset<<=branch\_bits);
597 
598     \textcolor{comment}{// Now go down from there}
599     \textcolor{keywordflow}{for} (level-=branch\_bits, offset>>=branch\_bits; offset != 0;
600          level-=branch\_bits, offset>>=branch\_bits)
601 #\textcolor{keywordflow}{else}
602     \textcolor{comment}{// Go down the tree, level by level}
603     \textcolor{keywordflow}{for} (level=0, offset=1; offset<num\_threads; level+=branch\_bits, offset<<=branch\_bits)
604 #endif \textcolor{comment}{// KMP\_REVERSE\_HYPER\_BAR}
605     \{
606 \textcolor{preprocessor}{#ifdef KMP\_REVERSE\_HYPER\_BAR}
607 \textcolor{preprocessor}{}        \textcolor{comment}{/* Now go in reverse order through the children, highest to lowest.}
608 \textcolor{comment}{           Initial setting of child is conservative here. */}
609         child = num\_threads >> ((level==0)?level:level-1);
610         \textcolor{keywordflow}{for} (child=(child<branch\_factor-1) ? child : branch\_factor-1, child\_tid=tid+(child<<level);
611              child>=1; child--, child\_tid-=(1<<level))
612 \textcolor{preprocessor}{#else}
613 \textcolor{preprocessor}{}        \textcolor{keywordflow}{if} (((tid >> level) & (branch\_factor - 1)) != 0)
614             \textcolor{comment}{// No need to go lower than this, since this is the level parent would be notified}
615             \textcolor{keywordflow}{break};
616         \textcolor{comment}{// Iterate through children on this level of the tree}
617         \textcolor{keywordflow}{for} (child=1, child\_tid=tid+(1<<level); child<branch\_factor && child\_tid<num\_threads;
618              child++, child\_tid+=(1<<level))
619 \textcolor{preprocessor}{#endif // KMP\_REVERSE\_HYPER\_BAR}
620 \textcolor{preprocessor}{}        \{
621             \textcolor{keywordflow}{if} (child\_tid >= num\_threads) \textcolor{keywordflow}{continue};  \textcolor{comment}{// Child doesn't exist so keep going}
622             \textcolor{keywordflow}{else} \{
623                 \textcolor{keyword}{register} \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\_info\_t} *child\_thr = other\_threads[child\_tid];
624                 \textcolor{keyword}{register} \hyperlink{kmp_8h_a1493aa680c299d09746e1edfc9116b24}{kmp\_bstate\_t} *child\_bar = &child\_thr->th.th\_bar[bt].bb;
625 \textcolor{preprocessor}{#if KMP\_CACHE\_MANAGE}
626 \textcolor{preprocessor}{}                \textcolor{keyword}{register} kmp\_uint32 next\_child\_tid = child\_tid - (1 << level);
627                 \textcolor{comment}{// Prefetch next thread's go count}
628 \textcolor{preprocessor}{# ifdef KMP\_REVERSE\_HYPER\_BAR}
629 \textcolor{preprocessor}{}                \textcolor{keywordflow}{if} (child-1 >= 1 && next\_child\_tid < num\_threads)
630 \textcolor{preprocessor}{# else}
631 \textcolor{preprocessor}{}                \textcolor{keywordflow}{if} (child+1 < branch\_factor && next\_child\_tid < num\_threads)
632 \textcolor{preprocessor}{# endif // KMP\_REVERSE\_HYPER\_BAR}
633 \textcolor{preprocessor}{}                    \hyperlink{kmp__os_8h_a936407f18975a175fbff4bddca4ff389}{KMP\_CACHE\_PREFETCH}(&other\_threads[next\_child\_tid]->th.th\_bar[bt].bb.
      b\_go);
634 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* KMP\_CACHE\_MANAGE */}\textcolor{preprocessor}{}
635 \textcolor{preprocessor}{}
636 \textcolor{preprocessor}{#if KMP\_BARRIER\_ICV\_PUSH}
637 \textcolor{preprocessor}{}                \textcolor{keywordflow}{if} (propagate\_icvs) \textcolor{comment}{// push my fixed ICVs to my child}
638                     \hyperlink{kmp_8h_a87574bd68566bdaab6ba1cd63223ab46}{copy\_icvs}(&child\_bar->th\_fixed\_icvs, &thr\_bar->th\_fixed\_icvs);
639 \textcolor{preprocessor}{#endif // KMP\_BARRIER\_ICV\_PUSH}
640 \textcolor{preprocessor}{}
641                 \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_hyper\_barrier\_release: T#%d(%d:%d) releasing T#%d(%d:%u)"}
642                               \textcolor{stringliteral}{"go(%p): %u => %u\(\backslash\)n"}, gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid,
643                               \hyperlink{kmp_8h_a66d8a210d86c996e250ea9971fe3cd3a}{\_\_kmp\_gtid\_from\_tid}(child\_tid, team), team->
      \hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id,
644                               child\_tid, &child\_bar->b\_go, child\_bar->b\_go,
645                               child\_bar->b\_go + \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP}));
646                 \textcolor{comment}{// Release child from barrier}
647                 \hyperlink{classkmp__flag__64}{kmp\_flag\_64} flag(&child\_bar->b\_go, child\_thr);
648                 flag.release();
649             \}
650         \}
651     \}
652 \textcolor{preprocessor}{#if KMP\_BARRIER\_ICV\_PUSH}
653 \textcolor{preprocessor}{}    \textcolor{keywordflow}{if} (propagate\_icvs && !\hyperlink{kmp_8h_a7a4e2494d803bbee99f23af2117f6dd8}{KMP\_MASTER\_TID}(tid)) \{ \textcolor{comment}{// copy ICVs locally to final dest}
654         \hyperlink{kmp_8h_a8387c1b95f3b497a14fc3916515ad4c3}{\_\_kmp\_init\_implicit\_task}(team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_ident, team->
      \hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads[tid], team, tid, \hyperlink{kmp_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE});
655         \hyperlink{kmp_8h_a87574bd68566bdaab6ba1cd63223ab46}{copy\_icvs}(&team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_implicit\_task\_taskdata[tid].td\_icvs, &thr\_bar->th\_fixed\_icvs);
656     \}
657 \textcolor{preprocessor}{#endif}
658 \textcolor{preprocessor}{}    \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_hyper\_barrier\_release: T#%d(%d:%d) exit for barrier type %d\(\backslash\)n"},
659                   gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, bt));
660 \}
\end{DoxyCode}
\hypertarget{kmp__barrier_8cpp_ade2d153827dde70455637c2763ff361b}{\index{kmp\-\_\-barrier.\-cpp@{kmp\-\_\-barrier.\-cpp}!\-\_\-\-\_\-kmp\-\_\-init\-\_\-hierarchical\-\_\-barrier\-\_\-thread@{\-\_\-\-\_\-kmp\-\_\-init\-\_\-hierarchical\-\_\-barrier\-\_\-thread}}
\index{\-\_\-\-\_\-kmp\-\_\-init\-\_\-hierarchical\-\_\-barrier\-\_\-thread@{\-\_\-\-\_\-kmp\-\_\-init\-\_\-hierarchical\-\_\-barrier\-\_\-thread}!kmp_barrier.cpp@{kmp\-\_\-barrier.\-cpp}}
\subsubsection[{\-\_\-\-\_\-kmp\-\_\-init\-\_\-hierarchical\-\_\-barrier\-\_\-thread}]{\setlength{\rightskip}{0pt plus 5cm}static bool \-\_\-\-\_\-kmp\-\_\-init\-\_\-hierarchical\-\_\-barrier\-\_\-thread (
\begin{DoxyParamCaption}
\item[{enum {\bf barrier\-\_\-type}}]{bt, }
\item[{{\bf kmp\-\_\-bstate\-\_\-t} $\ast$}]{thr\-\_\-bar, }
\item[{kmp\-\_\-uint32}]{nproc, }
\item[{{\bf int}}]{gtid, }
\item[{{\bf int}}]{tid, }
\item[{{\bf kmp\-\_\-team\-\_\-t} $\ast$}]{team}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{kmp__barrier_8cpp_ade2d153827dde70455637c2763ff361b}


Definition at line 671 of file kmp\-\_\-barrier.\-cpp.



Referenced by \-\_\-\-\_\-kmp\-\_\-hierarchical\-\_\-barrier\-\_\-gather(), and \-\_\-\-\_\-kmp\-\_\-hierarchical\-\_\-barrier\-\_\-release().


\begin{DoxyCode}
673 \{
674     \textcolor{comment}{// Checks to determine if (re-)initialization is needed}
675     \textcolor{keywordtype}{bool} uninitialized = thr\_bar->team == NULL;
676     \textcolor{keywordtype}{bool} team\_changed = team != thr\_bar->team;
677     \textcolor{keywordtype}{bool} team\_sz\_changed = nproc != thr\_bar->nproc;
678     \textcolor{keywordtype}{bool} tid\_changed = tid != thr\_bar->old\_tid;
679     \textcolor{keywordtype}{bool} retval = \textcolor{keyword}{false};
680 
681     \textcolor{keywordflow}{if} (uninitialized || team\_sz\_changed) \{
682         \hyperlink{kmp_8h_a3e762a8f344dc00cf1b1d9026919d3cb}{\_\_kmp\_get\_hierarchy}(nproc, thr\_bar);
683     \}
684 
685     \textcolor{keywordflow}{if} (uninitialized || team\_sz\_changed || tid\_changed) \{
686         thr\_bar->my\_level = thr\_bar->depth-1; \textcolor{comment}{// default for master}
687         thr\_bar->parent\_tid = -1; \textcolor{comment}{// default for master}
688         \textcolor{keywordflow}{if} (!\hyperlink{kmp_8h_a7a4e2494d803bbee99f23af2117f6dd8}{KMP\_MASTER\_TID}(tid)) \{ \textcolor{comment}{// if not master, find parent thread in hierarchy}
689             kmp\_uint32 \hyperlink{ittnotify__static_8h_a6b8793c3e5dd8bb67b04141713a65d2d}{d}=0;
690             \textcolor{keywordflow}{while} (d<thr\_bar->depth) \{ \textcolor{comment}{// find parent based on level of thread in hierarchy, and note level}
691                 kmp\_uint32 rem;
692                 \textcolor{keywordflow}{if} (d == thr\_bar->depth-2) \{ \textcolor{comment}{// reached level right below the master}
693                     thr\_bar->parent\_tid = 0;
694                     thr\_bar->my\_level = \hyperlink{ittnotify__static_8h_a6b8793c3e5dd8bb67b04141713a65d2d}{d};
695                     \textcolor{keywordflow}{break};
696                 \}
697                 \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} ((rem = tid%thr\_bar->skip\_per\_level[d+1]) != 0) \{ \textcolor{comment}{// TODO: can we make this op
       faster?}
698                     \textcolor{comment}{// thread is not a subtree root at next level, so this is max}
699                     thr\_bar->parent\_tid = tid - rem;
700                     thr\_bar->my\_level = \hyperlink{ittnotify__static_8h_a6b8793c3e5dd8bb67b04141713a65d2d}{d};
701                     \textcolor{keywordflow}{break};
702                 \}
703                 ++\hyperlink{ittnotify__static_8h_a6b8793c3e5dd8bb67b04141713a65d2d}{d};
704             \}
705         \}
706         thr\_bar->offset = 7-(tid-thr\_bar->parent\_tid-1);
707         thr\_bar->old\_tid = tid;
708         thr\_bar->wait\_flag = \hyperlink{kmp_8h_ac784262f4d5effc56b1cf3a205a7c8c1}{KMP\_BARRIER\_NOT\_WAITING};
709         thr\_bar->team = team;
710         thr\_bar->parent\_bar = &team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads[thr\_bar->parent\_tid]->th.th\_bar[bt].bb;
711     \}
712     \textcolor{keywordflow}{if} (uninitialized || team\_changed || tid\_changed) \{
713         thr\_bar->team = team;
714         thr\_bar->parent\_bar = &team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads[thr\_bar->parent\_tid]->th.th\_bar[bt].bb;
715         retval = \textcolor{keyword}{true};
716     \}
717     \textcolor{keywordflow}{if} (uninitialized || team\_sz\_changed || tid\_changed) \{
718         thr\_bar->nproc = nproc;
719         thr\_bar->leaf\_kids = thr\_bar->base\_leaf\_kids;
720         \textcolor{keywordflow}{if} (thr\_bar->my\_level == 0) thr\_bar->leaf\_kids=0;
721         \textcolor{keywordflow}{if} (thr\_bar->leaf\_kids && (kmp\_uint32)tid+thr\_bar->leaf\_kids+1 > nproc)
722             thr\_bar->leaf\_kids = nproc - tid - 1;
723         thr\_bar->leaf\_state = 0;
724         for (\textcolor{keywordtype}{int} \hyperlink{kmp__stub_8c_a08582ce460e3d5e1cf0b7fea017d608e}{i}=0; \hyperlink{kmp__stub_8c_a08582ce460e3d5e1cf0b7fea017d608e}{i}<thr\_bar->leaf\_kids; ++\hyperlink{kmp__stub_8c_a08582ce460e3d5e1cf0b7fea017d608e}{i}) ((\textcolor{keywordtype}{char} *)&(thr\_bar->leaf\_state))[7-
      \hyperlink{kmp__stub_8c_a08582ce460e3d5e1cf0b7fea017d608e}{i}] = 1;
725     \}
726     \textcolor{keywordflow}{return} retval;
727 \}
\end{DoxyCode}
\hypertarget{kmp__barrier_8cpp_a5e8f7c63d5e652f73e8998922edf14a4}{\index{kmp\-\_\-barrier.\-cpp@{kmp\-\_\-barrier.\-cpp}!\-\_\-\-\_\-kmp\-\_\-join\-\_\-barrier@{\-\_\-\-\_\-kmp\-\_\-join\-\_\-barrier}}
\index{\-\_\-\-\_\-kmp\-\_\-join\-\_\-barrier@{\-\_\-\-\_\-kmp\-\_\-join\-\_\-barrier}!kmp_barrier.cpp@{kmp\-\_\-barrier.\-cpp}}
\subsubsection[{\-\_\-\-\_\-kmp\-\_\-join\-\_\-barrier}]{\setlength{\rightskip}{0pt plus 5cm}{\bf void} \-\_\-\-\_\-kmp\-\_\-join\-\_\-barrier (
\begin{DoxyParamCaption}
\item[{{\bf int}}]{gtid}
\end{DoxyParamCaption}
)}}\label{kmp__barrier_8cpp_a5e8f7c63d5e652f73e8998922edf14a4}


Definition at line 1346 of file kmp\-\_\-barrier.\-cpp.



Referenced by \-\_\-\-\_\-kmp\-\_\-internal\-\_\-join(), and \-\_\-\-\_\-kmp\-\_\-launch\-\_\-thread().


\begin{DoxyCode}
1347 \{
1348     \hyperlink{kmp__stats_8h_a340afca3214165ed1920481f0e8fa67c}{KMP\_TIME\_DEVELOPER\_BLOCK}(KMP\_join\_barrier);
1349     \textcolor{keyword}{register} \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\_info\_t} *this\_thr = \hyperlink{kmp_8h_a8ba907eb5a2568ff55a49a1504cd3624}{\_\_kmp\_threads}[gtid];
1350     \textcolor{keyword}{register} \hyperlink{unionkmp__team}{kmp\_team\_t} *team;
1351     \textcolor{keyword}{register} \hyperlink{kmp__os_8h_a2bced771303068eeaf1ba0bcfa6f85de}{kmp\_uint} nproc;
1352     \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\_info\_t} *master\_thread;
1353     \textcolor{keywordtype}{int} tid;
1354 \textcolor{preprocessor}{#ifdef KMP\_DEBUG}
1355 \textcolor{preprocessor}{}    \textcolor{keywordtype}{int} team\_id;
1356 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* KMP\_DEBUG */}\textcolor{preprocessor}{}
1357 \textcolor{preprocessor}{}\textcolor{preprocessor}{#if USE\_ITT\_BUILD}
1358 \textcolor{preprocessor}{}    \textcolor{keywordtype}{void} *itt\_sync\_obj = NULL;
1359 \textcolor{preprocessor}{# if USE\_ITT\_NOTIFY}
1360 \textcolor{preprocessor}{}    \textcolor{keywordflow}{if} (\hyperlink{group__sync_gab7f1ba7abf5c98e0e0e0ea53d0e34661}{\_\_itt\_sync\_create\_ptr} || KMP\_ITT\_DEBUG) \textcolor{comment}{// Don't call routine without need}
1361         \textcolor{comment}{// Get object created at fork\_barrier}
1362         itt\_sync\_obj = \_\_kmp\_itt\_barrier\_object(gtid, \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cfab7dbfe1300085e4a7825c809112aaf7c}{bs\_forkjoin\_barrier});
1363 \textcolor{preprocessor}{# endif}
1364 \textcolor{preprocessor}{}\textcolor{preprocessor}{#endif }\textcolor{comment}{/* USE\_ITT\_BUILD */}\textcolor{preprocessor}{}
1365 \textcolor{preprocessor}{}    \hyperlink{kmp__os_8h_ab19ae0836bf2f1ac24e5cfc97c6d7d41}{KMP\_MB}();
1366 
1367     \textcolor{comment}{// Get current info}
1368     team = this\_thr->th.th\_team;
1369     nproc = this\_thr->th.th\_team\_nproc;
1370     \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}((\textcolor{keywordtype}{int})nproc == team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_nproc);
1371     tid = \hyperlink{kmp_8h_afb8f84fff9682417eb1c484ffbfdc6ee}{\_\_kmp\_tid\_from\_gtid}(gtid);
1372 \textcolor{preprocessor}{#ifdef KMP\_DEBUG}
1373 \textcolor{preprocessor}{}    team\_id = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id;
1374 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* KMP\_DEBUG */}\textcolor{preprocessor}{}
1375 \textcolor{preprocessor}{}    master\_thread = this\_thr->th.th\_team\_master;
1376 \textcolor{preprocessor}{#ifdef KMP\_DEBUG}
1377 \textcolor{preprocessor}{}    \textcolor{keywordflow}{if} (master\_thread != team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads[0]) \{
1378         \hyperlink{kmp__barrier_8cpp_a8c4e5bfa41738c5f588746983ee491a9}{\_\_kmp\_print\_structure}();
1379     \}
1380 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* KMP\_DEBUG */}\textcolor{preprocessor}{}
1381 \textcolor{preprocessor}{}    \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(master\_thread == team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads[0]);
1382     \hyperlink{kmp__os_8h_ab19ae0836bf2f1ac24e5cfc97c6d7d41}{KMP\_MB}();
1383 
1384     \textcolor{comment}{// Verify state}
1385     \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(\hyperlink{kmp_8h_a8ba907eb5a2568ff55a49a1504cd3624}{\_\_kmp\_threads} && \hyperlink{kmp_8h_a8ba907eb5a2568ff55a49a1504cd3624}{\_\_kmp\_threads}[gtid]);
1386     \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(\hyperlink{kmp__os_8h_a6e40f65c18c7b47fb612607b9bf8fdfc}{TCR\_PTR}(this\_thr->th.th\_team));
1387     \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(\hyperlink{kmp__os_8h_a6e40f65c18c7b47fb612607b9bf8fdfc}{TCR\_PTR}(this\_thr->th.th\_root));
1388     \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(this\_thr == team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads[tid]);
1389     \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(10, (\textcolor{stringliteral}{"\_\_kmp\_join\_barrier: T#%d(%d:%d) arrived at join barrier\(\backslash\)n"}, gtid, team\_id, tid))
      ;
1390 
1391 \textcolor{preprocessor}{#if OMPT\_SUPPORT }
1392 \textcolor{preprocessor}{}\textcolor{preprocessor}{#if OMPT\_TRACE}
1393 \textcolor{preprocessor}{}    \textcolor{keywordflow}{if} (\hyperlink{ompt-general_8c_a966b31b6d05f79f5495f8d8e71732f68}{ompt\_enabled} &&
1394         \hyperlink{ompt-general_8c_a84a29d89cef82c7c38e1ee1f70ec994f}{ompt\_callbacks}.ompt\_callback(ompt\_event\_barrier\_begin)) \{
1395         \hyperlink{ompt-general_8c_a84a29d89cef82c7c38e1ee1f70ec994f}{ompt\_callbacks}.ompt\_callback(ompt\_event\_barrier\_begin)(
1396             team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.ompt\_team\_info.parallel\_id,
1397             team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_implicit\_task\_taskdata[tid].ompt\_task\_info.task\_id);
1398     \}
1399 \textcolor{preprocessor}{#endif}
1400 \textcolor{preprocessor}{}    this\_thr->th.ompt\_thread\_info.state = ompt\_state\_wait\_barrier;
1401 \textcolor{preprocessor}{#endif}
1402 \textcolor{preprocessor}{}
1403     \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a39e87c52fb75a615c2564a822a013a5a}{\_\_kmp\_tasking\_mode} == \hyperlink{kmp_8h_aad1bdfbfac136cfd92611bcee79ca3f2a001d1f241bf760fd902d3fccc21918d3}{tskm\_extra\_barrier}) \{
1404         \hyperlink{kmp_8h_aaada49301d2ae62b774b7d55dd220b5a}{\_\_kmp\_tasking\_barrier}(team, this\_thr, gtid);
1405         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(10, (\textcolor{stringliteral}{"\_\_kmp\_join\_barrier: T#%d(%d:%d) past taking barrier\(\backslash\)n"}, gtid, team\_id, tid))
      ;
1406     \}
1407 \textcolor{preprocessor}{# ifdef KMP\_DEBUG}
1408 \textcolor{preprocessor}{}    \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a39e87c52fb75a615c2564a822a013a5a}{\_\_kmp\_tasking\_mode} != \hyperlink{kmp_8h_aad1bdfbfac136cfd92611bcee79ca3f2af827998cf4eb3f61723edc4943b86c98}{tskm\_immediate\_exec}) \{
1409         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, ( \textcolor{stringliteral}{"\_\_kmp\_join\_barrier: T#%d, old team = %d, old task\_team = %p, th\_task\_team =
       %p\(\backslash\)n"},
1410                        \hyperlink{kmp_8h_a31d799169fae2285dc2703faf7f7c258}{\_\_kmp\_gtid\_from\_thread}(this\_thr), team\_id, team->
      \hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_task\_team[this\_thr->th.th\_task\_state],
1411                        this\_thr->th.th\_task\_team));
1412         \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(this\_thr->th.th\_task\_team == team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_task\_team[this\_thr->th.
      th\_task\_state]);
1413     \}
1414 \textcolor{preprocessor}{# endif }\textcolor{comment}{/* KMP\_DEBUG */}\textcolor{preprocessor}{}
1415 \textcolor{preprocessor}{}
1416     \textcolor{comment}{/* Copy the blocktime info to the thread, where \_\_kmp\_wait\_template() can access it when the}
1417 \textcolor{comment}{       team struct is not guaranteed to exist. Doing these loads causes a cache miss slows}
1418 \textcolor{comment}{       down EPCC parallel by 2x. As a workaround, we do not perform the copy if blocktime=infinite,}
1419 \textcolor{comment}{       since the values are not used by \_\_kmp\_wait\_template() in that case. */}
1420     \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a3b56e2e90e1539c0b794e4137724bc1c}{\_\_kmp\_dflt\_blocktime} != \hyperlink{kmp_8h_a1ca6c6ce04115f143dc5df627de57958}{KMP\_MAX\_BLOCKTIME}) \{
1421         this\_thr->th.th\_team\_bt\_intervals = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_implicit\_task\_taskdata[tid].td\_icvs.bt\_intervals;
1422         this\_thr->th.th\_team\_bt\_set = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_implicit\_task\_taskdata[tid].td\_icvs.bt\_set;
1423     \}
1424 
1425 \textcolor{preprocessor}{#if USE\_ITT\_BUILD}
1426 \textcolor{preprocessor}{}    \textcolor{keywordflow}{if} (\hyperlink{group__sync_gab7f1ba7abf5c98e0e0e0ea53d0e34661}{\_\_itt\_sync\_create\_ptr} || KMP\_ITT\_DEBUG)
1427         \_\_kmp\_itt\_barrier\_starting(gtid, itt\_sync\_obj);
1428 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* USE\_ITT\_BUILD */}\textcolor{preprocessor}{}
1429 \textcolor{preprocessor}{}
1430     \textcolor{keywordflow}{switch} (\hyperlink{kmp_8h_a3919081570d178345aff3877da7dbd8a}{\_\_kmp\_barrier\_gather\_pattern}[
      \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cfab7dbfe1300085e4a7825c809112aaf7c}{bs\_forkjoin\_barrier}]) \{
1431     \textcolor{keywordflow}{case} \hyperlink{kmp_8h_afa95b644d435d20b66b1b5a7302dd86aad01aaab58a5ceeebbf8f9d5a170afa33}{bp\_hyper\_bar}: \{
1432         \hyperlink{kmp__debug_8h_a5323a368e8ba273b17c46906dd9ec78c}{KMP\_ASSERT}(\hyperlink{kmp_8h_ac686c46b38f93904467b30f15ec1c15e}{\_\_kmp\_barrier\_gather\_branch\_bits}[
      bs\_forkjoin\_barrier]);
1433         \hyperlink{kmp__barrier_8cpp_a53561cb5f3b4a1b71eb128e83ac2a4b0}{\_\_kmp\_hyper\_barrier\_gather}(bs\_forkjoin\_barrier, this\_thr, gtid, tid, NULL
1434                                    \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
1435         \textcolor{keywordflow}{break};
1436     \}
1437     \textcolor{keywordflow}{case} \hyperlink{kmp_8h_afa95b644d435d20b66b1b5a7302dd86aab0183e6c51993f58d4f0af1fb6298c82}{bp\_hierarchical\_bar}: \{
1438         \hyperlink{kmp__barrier_8cpp_af7a9e6ac2476553d1fb94039fde53b75}{\_\_kmp\_hierarchical\_barrier\_gather}(bs\_forkjoin\_barrier, this\_thr, 
      gtid, tid, NULL
1439                                           \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
1440         \textcolor{keywordflow}{break};
1441     \}
1442     \textcolor{keywordflow}{case} \hyperlink{kmp_8h_afa95b644d435d20b66b1b5a7302dd86aa64f2941fea2d51b943240075d1db0d64}{bp\_tree\_bar}: \{
1443         \hyperlink{kmp__debug_8h_a5323a368e8ba273b17c46906dd9ec78c}{KMP\_ASSERT}(\hyperlink{kmp_8h_ac686c46b38f93904467b30f15ec1c15e}{\_\_kmp\_barrier\_gather\_branch\_bits}[
      bs\_forkjoin\_barrier]);
1444         \hyperlink{kmp__barrier_8cpp_a7055b9bc973e4cab4e2b3144d0da2e6d}{\_\_kmp\_tree\_barrier\_gather}(bs\_forkjoin\_barrier, this\_thr, gtid, tid, NULL
1445                                   \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
1446         \textcolor{keywordflow}{break};
1447     \}
1448     \textcolor{keywordflow}{default}: \{
1449         \hyperlink{kmp__barrier_8cpp_a86dab93f80bfcc456e2cd2c5608962f6}{\_\_kmp\_linear\_barrier\_gather}(bs\_forkjoin\_barrier, this\_thr, gtid, tid, 
      NULL
1450                                     \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
1451     \}
1452     \}
1453 
1454     \textcolor{comment}{/* From this point on, the team data structure may be deallocated at any time by the}
1455 \textcolor{comment}{       master thread - it is unsafe to reference it in any of the worker threads. Any per-team}
1456 \textcolor{comment}{       data items that need to be referenced before the end of the barrier should be moved to}
1457 \textcolor{comment}{       the kmp\_task\_team\_t structs.  */}
1458     \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a7a4e2494d803bbee99f23af2117f6dd8}{KMP\_MASTER\_TID}(tid)) \{
1459         \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a39e87c52fb75a615c2564a822a013a5a}{\_\_kmp\_tasking\_mode} != \hyperlink{kmp_8h_aad1bdfbfac136cfd92611bcee79ca3f2af827998cf4eb3f61723edc4943b86c98}{tskm\_immediate\_exec}) \{
1460             \hyperlink{kmp_8h_afd36f17a7257b41ac1c0ac640225e292}{\_\_kmp\_task\_team\_wait}(this\_thr, team
1461                                  \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
1462         \}
1463 \textcolor{preprocessor}{#if USE\_ITT\_BUILD}
1464 \textcolor{preprocessor}{}        \textcolor{keywordflow}{if} (\hyperlink{group__sync_gab7f1ba7abf5c98e0e0e0ea53d0e34661}{\_\_itt\_sync\_create\_ptr} || KMP\_ITT\_DEBUG)
1465             \_\_kmp\_itt\_barrier\_middle(gtid, itt\_sync\_obj);
1466 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* USE\_ITT\_BUILD */}\textcolor{preprocessor}{}
1467 \textcolor{preprocessor}{}
1468 \textcolor{preprocessor}{# if USE\_ITT\_BUILD && USE\_ITT\_NOTIFY}
1469 \textcolor{preprocessor}{}        \textcolor{comment}{// Join barrier - report frame end}
1470         \textcolor{keywordflow}{if} ((\_\_itt\_frame\_submit\_v3\_ptr || KMP\_ITT\_DEBUG) && \_\_kmp\_forkjoin\_frames\_mode &&
1471 #\textcolor{keywordflow}{if} OMP\_40\_ENABLED
1472             this\_thr->th.th\_teams\_microtask == NULL &&
1473 #endif
1474             team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_active\_level == 1)
1475         \{
1476             kmp\_uint64 cur\_time = \_\_itt\_get\_timestamp();
1477             \hyperlink{structident}{ident\_t} * loc = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_ident;
1478             \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\_info\_t} **other\_threads = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads;
1479             \textcolor{keywordtype}{int} nproc = this\_thr->th.th\_team\_nproc;
1480             \textcolor{keywordtype}{int} \hyperlink{kmp__stub_8c_a08582ce460e3d5e1cf0b7fea017d608e}{i};
1481             \textcolor{keywordflow}{switch}(\_\_kmp\_forkjoin\_frames\_mode) \{
1482             \textcolor{keywordflow}{case} 1:
1483                 \_\_kmp\_itt\_frame\_submit(gtid, this\_thr->th.th\_frame\_time, cur\_time, 0, loc, nproc);
1484                 \textcolor{keywordflow}{break};
1485             \textcolor{keywordflow}{case} 2:
1486                 \_\_kmp\_itt\_frame\_submit(gtid, this\_thr->th.th\_bar\_min\_time, cur\_time, 1, loc, nproc);
1487                 \textcolor{keywordflow}{break};
1488             \textcolor{keywordflow}{case} 3:
1489                 \textcolor{keywordflow}{if}( \_\_itt\_metadata\_add\_ptr ) \{
1490                     \textcolor{comment}{// Initialize with master's wait time}
1491                     kmp\_uint64 delta = cur\_time - this\_thr->th.th\_bar\_arrive\_time;
1492                     \textcolor{keywordflow}{for} (i=1; i<nproc; ++\hyperlink{kmp__stub_8c_a08582ce460e3d5e1cf0b7fea017d608e}{i}) \{
1493                         delta += ( cur\_time - other\_threads[\hyperlink{kmp__stub_8c_a08582ce460e3d5e1cf0b7fea017d608e}{i}]->th.th\_bar\_arrive\_time );
1494                     \}
1495                     \_\_kmp\_itt\_metadata\_imbalance(gtid, this\_thr->th.th\_frame\_time, cur\_time, delta, 0);
1496                 \}
1497                 \_\_kmp\_itt\_frame\_submit(gtid, this\_thr->th.th\_frame\_time, cur\_time, 0, loc, nproc);
1498                 this\_thr->th.th\_frame\_time = cur\_time;
1499                 \textcolor{keywordflow}{break};
1500             \}
1501         \}
1502 \textcolor{preprocessor}{# endif }\textcolor{comment}{/* USE\_ITT\_BUILD */}\textcolor{preprocessor}{}
1503 \textcolor{preprocessor}{}    \}
1504 \textcolor{preprocessor}{#if USE\_ITT\_BUILD}
1505 \textcolor{preprocessor}{}    \textcolor{keywordflow}{else} \{
1506         \textcolor{keywordflow}{if} (\hyperlink{group__sync_gab7f1ba7abf5c98e0e0e0ea53d0e34661}{\_\_itt\_sync\_create\_ptr} || KMP\_ITT\_DEBUG)
1507             \_\_kmp\_itt\_barrier\_middle(gtid, itt\_sync\_obj);
1508     \}
1509 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* USE\_ITT\_BUILD */}\textcolor{preprocessor}{}
1510 \textcolor{preprocessor}{}
1511 \textcolor{preprocessor}{#if KMP\_DEBUG}
1512 \textcolor{preprocessor}{}    \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a7a4e2494d803bbee99f23af2117f6dd8}{KMP\_MASTER\_TID}(tid)) \{
1513         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(15, (\textcolor{stringliteral}{"\_\_kmp\_join\_barrier: T#%d(%d:%d) says all %d team threads arrived\(\backslash\)n"},
1514                       gtid, team\_id, tid, nproc));
1515     \}
1516 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* KMP\_DEBUG */}\textcolor{preprocessor}{}
1517 \textcolor{preprocessor}{}
1518     \textcolor{comment}{// TODO now, mark worker threads as done so they may be disbanded}
1519     \hyperlink{kmp__os_8h_ab19ae0836bf2f1ac24e5cfc97c6d7d41}{KMP\_MB}(); \textcolor{comment}{// Flush all pending memory write invalidates.}
1520     \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(10, (\textcolor{stringliteral}{"\_\_kmp\_join\_barrier: T#%d(%d:%d) leaving\(\backslash\)n"}, gtid, team\_id, tid));
1521 
1522 \textcolor{preprocessor}{#if OMPT\_SUPPORT}
1523 \textcolor{preprocessor}{}    \textcolor{keywordflow}{if} (\hyperlink{ompt-general_8c_a966b31b6d05f79f5495f8d8e71732f68}{ompt\_enabled}) \{
1524 \textcolor{preprocessor}{#if OMPT\_BLAME}
1525 \textcolor{preprocessor}{}        \textcolor{keywordflow}{if} (\hyperlink{ompt-general_8c_a84a29d89cef82c7c38e1ee1f70ec994f}{ompt\_callbacks}.ompt\_callback(ompt\_event\_barrier\_end)) \{
1526             \hyperlink{ompt-general_8c_a84a29d89cef82c7c38e1ee1f70ec994f}{ompt\_callbacks}.ompt\_callback(ompt\_event\_barrier\_end)(
1527                 team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.ompt\_team\_info.parallel\_id,
1528                 team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_implicit\_task\_taskdata[tid].ompt\_task\_info.task\_id);
1529         \}
1530 \textcolor{preprocessor}{#endif}
1531 \textcolor{preprocessor}{}
1532         \textcolor{comment}{// return to default state}
1533         this\_thr->th.ompt\_thread\_info.state = ompt\_state\_overhead;
1534     \}
1535 \textcolor{preprocessor}{#endif}
1536 \textcolor{preprocessor}{}\}
\end{DoxyCode}
\hypertarget{kmp__barrier_8cpp_a86dab93f80bfcc456e2cd2c5608962f6}{\index{kmp\-\_\-barrier.\-cpp@{kmp\-\_\-barrier.\-cpp}!\-\_\-\-\_\-kmp\-\_\-linear\-\_\-barrier\-\_\-gather@{\-\_\-\-\_\-kmp\-\_\-linear\-\_\-barrier\-\_\-gather}}
\index{\-\_\-\-\_\-kmp\-\_\-linear\-\_\-barrier\-\_\-gather@{\-\_\-\-\_\-kmp\-\_\-linear\-\_\-barrier\-\_\-gather}!kmp_barrier.cpp@{kmp\-\_\-barrier.\-cpp}}
\subsubsection[{\-\_\-\-\_\-kmp\-\_\-linear\-\_\-barrier\-\_\-gather}]{\setlength{\rightskip}{0pt plus 5cm}static {\bf void} \-\_\-\-\_\-kmp\-\_\-linear\-\_\-barrier\-\_\-gather (
\begin{DoxyParamCaption}
\item[{enum {\bf barrier\-\_\-type}}]{bt, }
\item[{{\bf kmp\-\_\-info\-\_\-t} $\ast$}]{this\-\_\-thr, }
\item[{{\bf int}}]{gtid, }
\item[{{\bf int}}]{tid, }
\item[{{\bf void}($\ast$)({\bf void} $\ast$, {\bf void} $\ast$) {\bf U\-S\-E\-\_\-\-I\-T\-T\-\_\-\-B\-U\-I\-L\-D\-\_\-\-A\-R\-G} reduce({\bf void} $\ast$itt\-\_\-sync\-\_\-obj)}]{}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{kmp__barrier_8cpp_a86dab93f80bfcc456e2cd2c5608962f6}


Definition at line 47 of file kmp\-\_\-barrier.\-cpp.



Referenced by \-\_\-\-\_\-kmp\-\_\-barrier(), and \-\_\-\-\_\-kmp\-\_\-join\-\_\-barrier().


\begin{DoxyCode}
50 \{
51     \hyperlink{kmp__stats_8h_a340afca3214165ed1920481f0e8fa67c}{KMP\_TIME\_DEVELOPER\_BLOCK}(KMP\_linear\_gather);
52     \textcolor{keyword}{register} \hyperlink{unionkmp__team}{kmp\_team\_t} *team = this\_thr->th.th\_team;
53     \textcolor{keyword}{register} \hyperlink{kmp_8h_a1493aa680c299d09746e1edfc9116b24}{kmp\_bstate\_t} *thr\_bar = & this\_thr->th.th\_bar[bt].bb;
54     \textcolor{keyword}{register} \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\_info\_t} **other\_threads = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads;
55 
56     \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_linear\_barrier\_gather: T#%d(%d:%d) enter for barrier type %d\(\backslash\)n"},
57                   gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, bt));
58     \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(this\_thr == other\_threads[this\_thr->th.th\_info.ds.ds\_tid]);
59 
60 \textcolor{preprocessor}{#if USE\_ITT\_BUILD && USE\_ITT\_NOTIFY}
61 \textcolor{preprocessor}{}    \textcolor{comment}{// Barrier imbalance - save arrive time to the thread}
62     \textcolor{keywordflow}{if}(\_\_kmp\_forkjoin\_frames\_mode == 3 || \_\_kmp\_forkjoin\_frames\_mode == 2) \{
63         this\_thr->th.th\_bar\_arrive\_time = this\_thr->th.th\_bar\_min\_time = \_\_itt\_get\_timestamp();
64     \}
65 \textcolor{preprocessor}{#endif}
66 \textcolor{preprocessor}{}    \textcolor{comment}{// We now perform a linear reduction to signal that all of the threads have arrived.}
67     \textcolor{keywordflow}{if} (!\hyperlink{kmp_8h_a7a4e2494d803bbee99f23af2117f6dd8}{KMP\_MASTER\_TID}(tid)) \{
68         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_linear\_barrier\_gather: T#%d(%d:%d) releasing T#%d(%d:%d)"}
69                       \textcolor{stringliteral}{"arrived(%p): %llu => %llu\(\backslash\)n"}, gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid,
70                       \hyperlink{kmp_8h_a66d8a210d86c996e250ea9971fe3cd3a}{\_\_kmp\_gtid\_from\_tid}(0, team), team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, 0, &thr\_bar->
      b\_arrived,
71                       thr\_bar->b\_arrived, thr\_bar->b\_arrived + 
      \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP}));
72         \textcolor{comment}{// Mark arrival to master thread}
73         \textcolor{comment}{/* After performing this write, a worker thread may not assume that the team is valid}
74 \textcolor{comment}{           any more - it could be deallocated by the master thread at any time. */}
75         \hyperlink{classkmp__flag__64}{kmp\_flag\_64} flag(&thr\_bar->b\_arrived, other\_threads[0]);
76         flag.release();
77     \} \textcolor{keywordflow}{else} \{
78         \textcolor{keyword}{register} \hyperlink{unionkmp__barrier__team__union}{kmp\_balign\_team\_t} *team\_bar = &team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_bar[bt];
79         \textcolor{keyword}{register} \textcolor{keywordtype}{int} nproc = this\_thr->th.th\_team\_nproc;
80         \textcolor{keyword}{register} \textcolor{keywordtype}{int} \hyperlink{kmp__stub_8c_a08582ce460e3d5e1cf0b7fea017d608e}{i};
81         \textcolor{comment}{// Don't have to worry about sleep bit here or atomic since team setting}
82         \textcolor{keyword}{register} kmp\_uint64 new\_state = team\_bar->\hyperlink{unionkmp__barrier__team__union_a469318ad3a602e49e4a77b26af50d120}{b\_arrived} + 
      \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP};
83 
84         \textcolor{comment}{// Collect all the worker team member threads.}
85         \textcolor{keywordflow}{for} (i=1; i<nproc; ++\hyperlink{kmp__stub_8c_a08582ce460e3d5e1cf0b7fea017d608e}{i}) \{
86 \textcolor{preprocessor}{#if KMP\_CACHE\_MANAGE}
87 \textcolor{preprocessor}{}            \textcolor{comment}{// Prefetch next thread's arrived count}
88             \textcolor{keywordflow}{if} (i+1 < nproc)
89                 \hyperlink{kmp__os_8h_a936407f18975a175fbff4bddca4ff389}{KMP\_CACHE\_PREFETCH}(&other\_threads[i+1]->th.th\_bar[bt].bb.b\_arrived);
90 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* KMP\_CACHE\_MANAGE */}\textcolor{preprocessor}{}
91 \textcolor{preprocessor}{}            \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_linear\_barrier\_gather: T#%d(%d:%d) wait T#%d(%d:%d) "}
92                           \textcolor{stringliteral}{"arrived(%p) == %llu\(\backslash\)n"}, gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid,
93                             \hyperlink{kmp_8h_a66d8a210d86c996e250ea9971fe3cd3a}{\_\_kmp\_gtid\_from\_tid}(i, team), team->
      \hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, i,
94                             &other\_threads[i]->th.th\_bar[bt].bb.b\_arrived, new\_state));
95 
96             \textcolor{comment}{// Wait for worker thread to arrive}
97             \hyperlink{classkmp__flag__64}{kmp\_flag\_64} flag(&other\_threads[i]->th.th\_bar[bt].bb.b\_arrived, new\_state);
98             flag.wait(this\_thr, \hyperlink{kmp_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE}
99                       \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
100 \textcolor{preprocessor}{#if USE\_ITT\_BUILD && USE\_ITT\_NOTIFY}
101 \textcolor{preprocessor}{}            \textcolor{comment}{// Barrier imbalance - write min of the thread time and the other thread time to the thread.}
102             \textcolor{keywordflow}{if} (\_\_kmp\_forkjoin\_frames\_mode == 2) \{
103                 this\_thr->th.th\_bar\_min\_time = \hyperlink{kmp_8h_a635727f200be45c0c7cdc13c991284bf}{KMP\_MIN}(this\_thr->th.th\_bar\_min\_time,
104                                                           other\_threads[i]->th.th\_bar\_min\_time);
105             \}
106 \textcolor{preprocessor}{#endif}
107 \textcolor{preprocessor}{}            \textcolor{keywordflow}{if} (reduce) \{
108                 \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(100, (\textcolor{stringliteral}{"\_\_kmp\_linear\_barrier\_gather: T#%d(%d:%d) += T#%d(%d:%d)\(\backslash\)n"}, gtid,
109                                team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, \hyperlink{kmp_8h_a66d8a210d86c996e250ea9971fe3cd3a}{\_\_kmp\_gtid\_from\_tid}(i, team), team->
      \hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, i));
110                 (*reduce)(this\_thr->th.th\_local.reduce\_data,
111                           other\_threads[\hyperlink{kmp__stub_8c_a08582ce460e3d5e1cf0b7fea017d608e}{i}]->th.th\_local.reduce\_data);
112             \}
113         \}
114         \textcolor{comment}{// Don't have to worry about sleep bit here or atomic since team setting}
115         team\_bar->\hyperlink{unionkmp__barrier__team__union_a469318ad3a602e49e4a77b26af50d120}{b\_arrived} = new\_state;
116         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_linear\_barrier\_gather: T#%d(%d:%d) set team %d arrived(%p) = %llu\(\backslash\)n"},
117                       gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, &team\_bar->
      \hyperlink{unionkmp__barrier__team__union_a469318ad3a602e49e4a77b26af50d120}{b\_arrived}, new\_state));
118     \}
119     \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_linear\_barrier\_gather: T#%d(%d:%d) exit for barrier type %d\(\backslash\)n"},
120                   gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, bt));
121 \}
\end{DoxyCode}
\hypertarget{kmp__barrier_8cpp_afccbeffe4e07fbe7ccf6b622b5bea2f4}{\index{kmp\-\_\-barrier.\-cpp@{kmp\-\_\-barrier.\-cpp}!\-\_\-\-\_\-kmp\-\_\-linear\-\_\-barrier\-\_\-release@{\-\_\-\-\_\-kmp\-\_\-linear\-\_\-barrier\-\_\-release}}
\index{\-\_\-\-\_\-kmp\-\_\-linear\-\_\-barrier\-\_\-release@{\-\_\-\-\_\-kmp\-\_\-linear\-\_\-barrier\-\_\-release}!kmp_barrier.cpp@{kmp\-\_\-barrier.\-cpp}}
\subsubsection[{\-\_\-\-\_\-kmp\-\_\-linear\-\_\-barrier\-\_\-release}]{\setlength{\rightskip}{0pt plus 5cm}static {\bf void} \-\_\-\-\_\-kmp\-\_\-linear\-\_\-barrier\-\_\-release (
\begin{DoxyParamCaption}
\item[{enum {\bf barrier\-\_\-type}}]{bt, }
\item[{{\bf kmp\-\_\-info\-\_\-t} $\ast$}]{this\-\_\-thr, }
\item[{{\bf int}}]{gtid, }
\item[{{\bf int}}]{tid, }
\item[{{\bf int} propagate\-\_\-icvs }]{U\-S\-E\-\_\-\-I\-T\-T\-\_\-\-B\-U\-I\-L\-D\-\_\-\-A\-R\-Gvoid $\ast$itt\-\_\-sync\-\_\-obj}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{kmp__barrier_8cpp_afccbeffe4e07fbe7ccf6b622b5bea2f4}


Definition at line 124 of file kmp\-\_\-barrier.\-cpp.



Referenced by \-\_\-\-\_\-kmp\-\_\-barrier(), \-\_\-\-\_\-kmp\-\_\-end\-\_\-split\-\_\-barrier(), and \-\_\-\-\_\-kmp\-\_\-fork\-\_\-barrier().


\begin{DoxyCode}
127 \{
128     \hyperlink{kmp__stats_8h_a340afca3214165ed1920481f0e8fa67c}{KMP\_TIME\_DEVELOPER\_BLOCK}(KMP\_linear\_release);
129     \textcolor{keyword}{register} \hyperlink{kmp_8h_a1493aa680c299d09746e1edfc9116b24}{kmp\_bstate\_t} *thr\_bar = &this\_thr->th.th\_bar[bt].bb;
130     \textcolor{keyword}{register} \hyperlink{unionkmp__team}{kmp\_team\_t} *team;
131 
132     \textcolor{keywordflow}{if} (\hyperlink{kmp_8h_a7a4e2494d803bbee99f23af2117f6dd8}{KMP\_MASTER\_TID}(tid)) \{
133         \textcolor{keyword}{register} \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} \hyperlink{kmp__stub_8c_a08582ce460e3d5e1cf0b7fea017d608e}{i};
134         \textcolor{keyword}{register} kmp\_uint32 nproc = this\_thr->th.th\_team\_nproc;
135         \textcolor{keyword}{register} \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\_info\_t} **other\_threads;
136 
137         team = \hyperlink{kmp_8h_a8ba907eb5a2568ff55a49a1504cd3624}{\_\_kmp\_threads}[gtid]->th.th\_team;
138         \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(team != NULL);
139         other\_threads = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads;
140 
141         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_linear\_barrier\_release: T#%d(%d:%d) master enter for barrier type %d\(\backslash\)n
      "},
142                       gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, bt));
143 
144         \textcolor{keywordflow}{if} (nproc > 1) \{
145 \textcolor{preprocessor}{#if KMP\_BARRIER\_ICV\_PUSH}
146 \textcolor{preprocessor}{}            \{
147                 \hyperlink{kmp__stats_8h_a340afca3214165ed1920481f0e8fa67c}{KMP\_TIME\_DEVELOPER\_BLOCK}(USER\_icv\_copy);
148                 \textcolor{keywordflow}{if} (propagate\_icvs) \{
149                     \hyperlink{kmp__barrier_8cpp_a041fcfa491f1f402a50d53fb23c915bb}{ngo\_load}(&team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_implicit\_task\_taskdata[0].td\_icvs);
150                     \textcolor{keywordflow}{for} (i=1; i<nproc; ++\hyperlink{kmp__stub_8c_a08582ce460e3d5e1cf0b7fea017d608e}{i}) \{
151                         \hyperlink{kmp_8h_a8387c1b95f3b497a14fc3916515ad4c3}{\_\_kmp\_init\_implicit\_task}(team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_ident, team->
      \hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads[i], team, i, \hyperlink{kmp_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE});
152                         \hyperlink{kmp__barrier_8cpp_a12530abe295809b23e5f414fa302448b}{ngo\_store\_icvs}(&team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_implicit\_task\_taskdata[i].td\_icvs,
153                                        &team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_implicit\_task\_taskdata[0].td\_icvs);
154                     \}
155                     \hyperlink{kmp__barrier_8cpp_a303ca33adc792fd05f7da5d34b75aa4c}{ngo\_sync}();
156                 \}
157             \}
158 \textcolor{preprocessor}{#endif // KMP\_BARRIER\_ICV\_PUSH}
159 \textcolor{preprocessor}{}
160             \textcolor{comment}{// Now, release all of the worker threads}
161             \textcolor{keywordflow}{for} (i=1; i<nproc; ++\hyperlink{kmp__stub_8c_a08582ce460e3d5e1cf0b7fea017d608e}{i}) \{
162 \textcolor{preprocessor}{#if KMP\_CACHE\_MANAGE}
163 \textcolor{preprocessor}{}                \textcolor{comment}{// Prefetch next thread's go flag}
164                 \textcolor{keywordflow}{if} (i+1 < nproc)
165                     \hyperlink{kmp__os_8h_a936407f18975a175fbff4bddca4ff389}{KMP\_CACHE\_PREFETCH}(&other\_threads[i+1]->th.th\_bar[bt].bb.b\_go);
166 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* KMP\_CACHE\_MANAGE */}\textcolor{preprocessor}{}
167 \textcolor{preprocessor}{}                \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_linear\_barrier\_release: T#%d(%d:%d) releasing T#%d(%d:%d) "}
168                               \textcolor{stringliteral}{"go(%p): %u => %u\(\backslash\)n"}, gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid,
169                               other\_threads[i]->th.th\_info.ds.ds\_gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, i,
170                               &other\_threads[i]->th.th\_bar[bt].bb.b\_go,
171                               other\_threads[i]->th.th\_bar[bt].bb.b\_go,
172                               other\_threads[i]->th.th\_bar[bt].bb.b\_go + 
      \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP}));
173                 \hyperlink{classkmp__flag__64}{kmp\_flag\_64} flag(&other\_threads[i]->th.th\_bar[bt].bb.b\_go, other\_threads[i]);
174                 flag.release();
175             \}
176         \}
177     \} \textcolor{keywordflow}{else} \{ \textcolor{comment}{// Wait for the MASTER thread to release us}
178         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_linear\_barrier\_release: T#%d wait go(%p) == %u\(\backslash\)n"},
179                       gtid, &thr\_bar->b\_go, \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP}));
180         \hyperlink{classkmp__flag__64}{kmp\_flag\_64} flag(&thr\_bar->b\_go, \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP});
181         flag.wait(this\_thr, \hyperlink{kmp_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE}
182                   \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
183 \textcolor{preprocessor}{#if USE\_ITT\_BUILD && USE\_ITT\_NOTIFY}
184 \textcolor{preprocessor}{}        \textcolor{keywordflow}{if} ((\hyperlink{group__sync_gab7f1ba7abf5c98e0e0e0ea53d0e34661}{\_\_itt\_sync\_create\_ptr} && itt\_sync\_obj == NULL) || KMP\_ITT\_DEBUG) \{
185             \textcolor{comment}{// In a fork barrier; cannot get the object reliably (or ITTNOTIFY is disabled)}
186             itt\_sync\_obj = \_\_kmp\_itt\_barrier\_object(gtid, \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cfab7dbfe1300085e4a7825c809112aaf7c}{bs\_forkjoin\_barrier}, 0, -1);
187             \textcolor{comment}{// Cancel wait on previous parallel region...}
188             \_\_kmp\_itt\_task\_starting(itt\_sync\_obj);
189 
190             \textcolor{keywordflow}{if} (bt == \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cfab7dbfe1300085e4a7825c809112aaf7c}{bs\_forkjoin\_barrier} && \hyperlink{kmp__os_8h_acd6256e4afba32d90997235fc0a38a74}{TCR\_4}(
      \hyperlink{kmp_8h_a11b71922a4df46ff9e8dbc68693e8d67}{\_\_kmp\_global}.g.g\_done))
191                 \textcolor{keywordflow}{return};
192 
193             itt\_sync\_obj = \_\_kmp\_itt\_barrier\_object(gtid, \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cfab7dbfe1300085e4a7825c809112aaf7c}{bs\_forkjoin\_barrier});
194             \textcolor{keywordflow}{if} (itt\_sync\_obj != NULL)
195                 \textcolor{comment}{// Call prepare as early as possible for "new" barrier}
196                 \_\_kmp\_itt\_task\_finished(itt\_sync\_obj);
197         \} \textcolor{keywordflow}{else}
198 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* USE\_ITT\_BUILD && USE\_ITT\_NOTIFY */}\textcolor{preprocessor}{}
199 \textcolor{preprocessor}{}        \textcolor{comment}{// Early exit for reaping threads releasing forkjoin barrier}
200         \textcolor{keywordflow}{if} ( bt == \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cfab7dbfe1300085e4a7825c809112aaf7c}{bs\_forkjoin\_barrier} && \hyperlink{kmp__os_8h_acd6256e4afba32d90997235fc0a38a74}{TCR\_4}(
      \hyperlink{kmp_8h_a11b71922a4df46ff9e8dbc68693e8d67}{\_\_kmp\_global}.g.g\_done) )
201             \textcolor{keywordflow}{return};
202         \textcolor{comment}{// The worker thread may now assume that the team is valid.}
203 \textcolor{preprocessor}{#ifdef KMP\_DEBUG}
204 \textcolor{preprocessor}{}        tid = \hyperlink{kmp_8h_afb8f84fff9682417eb1c484ffbfdc6ee}{\_\_kmp\_tid\_from\_gtid}(gtid);
205         team = \hyperlink{kmp_8h_a8ba907eb5a2568ff55a49a1504cd3624}{\_\_kmp\_threads}[gtid]->th.th\_team;
206 \textcolor{preprocessor}{#endif}
207 \textcolor{preprocessor}{}        \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(team != NULL);
208         \hyperlink{kmp__os_8h_ae67779cc7794b5dd7eee4c7f2c7789d4}{TCW\_4}(thr\_bar->b\_go, \hyperlink{kmp_8h_abf682c7f66b0baa7f7184ac388224569}{KMP\_INIT\_BARRIER\_STATE});
209         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_linear\_barrier\_release: T#%d(%d:%d) set go(%p) = %u\(\backslash\)n"},
210                       gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, &thr\_bar->b\_go, 
      \hyperlink{kmp_8h_abf682c7f66b0baa7f7184ac388224569}{KMP\_INIT\_BARRIER\_STATE}));
211         \hyperlink{kmp__os_8h_ab19ae0836bf2f1ac24e5cfc97c6d7d41}{KMP\_MB}();  \textcolor{comment}{// Flush all pending memory write invalidates.}
212     \}
213     \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_linear\_barrier\_release: T#%d(%d:%d) exit for barrier type %d\(\backslash\)n"},
214                   gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, bt));
215 \}
\end{DoxyCode}
\hypertarget{kmp__barrier_8cpp_a8c4e5bfa41738c5f588746983ee491a9}{\index{kmp\-\_\-barrier.\-cpp@{kmp\-\_\-barrier.\-cpp}!\-\_\-\-\_\-kmp\-\_\-print\-\_\-structure@{\-\_\-\-\_\-kmp\-\_\-print\-\_\-structure}}
\index{\-\_\-\-\_\-kmp\-\_\-print\-\_\-structure@{\-\_\-\-\_\-kmp\-\_\-print\-\_\-structure}!kmp_barrier.cpp@{kmp\-\_\-barrier.\-cpp}}
\subsubsection[{\-\_\-\-\_\-kmp\-\_\-print\-\_\-structure}]{\setlength{\rightskip}{0pt plus 5cm}{\bf void} \-\_\-\-\_\-kmp\-\_\-print\-\_\-structure (
\begin{DoxyParamCaption}
\item[{{\bf void}}]{}
\end{DoxyParamCaption}
)}}\label{kmp__barrier_8cpp_a8c4e5bfa41738c5f588746983ee491a9}


Referenced by \-\_\-\-\_\-kmp\-\_\-internal\-\_\-join(), and \-\_\-\-\_\-kmp\-\_\-join\-\_\-barrier().

\hypertarget{kmp__barrier_8cpp_a3cb36a9e9ab38ef825b47442b4f78bc7}{\index{kmp\-\_\-barrier.\-cpp@{kmp\-\_\-barrier.\-cpp}!\-\_\-\-\_\-kmp\-\_\-setup\-\_\-icv\-\_\-copy@{\-\_\-\-\_\-kmp\-\_\-setup\-\_\-icv\-\_\-copy}}
\index{\-\_\-\-\_\-kmp\-\_\-setup\-\_\-icv\-\_\-copy@{\-\_\-\-\_\-kmp\-\_\-setup\-\_\-icv\-\_\-copy}!kmp_barrier.cpp@{kmp\-\_\-barrier.\-cpp}}
\subsubsection[{\-\_\-\-\_\-kmp\-\_\-setup\-\_\-icv\-\_\-copy}]{\setlength{\rightskip}{0pt plus 5cm}{\bf void} \-\_\-\-\_\-kmp\-\_\-setup\-\_\-icv\-\_\-copy (
\begin{DoxyParamCaption}
\item[{{\bf kmp\-\_\-team\-\_\-t} $\ast$}]{team, }
\item[{{\bf int}}]{new\-\_\-nproc, }
\item[{{\bf kmp\-\_\-internal\-\_\-control\-\_\-t} $\ast$}]{new\-\_\-icvs, }
\item[{{\bf ident\-\_\-t} $\ast$}]{loc}
\end{DoxyParamCaption}
)}}\label{kmp__barrier_8cpp_a3cb36a9e9ab38ef825b47442b4f78bc7}


Definition at line 1708 of file kmp\-\_\-barrier.\-cpp.



Referenced by \-\_\-\-\_\-kmp\-\_\-fork\-\_\-call().


\begin{DoxyCode}
1709 \{
1710     \hyperlink{kmp__stats_8h_a340afca3214165ed1920481f0e8fa67c}{KMP\_TIME\_DEVELOPER\_BLOCK}(KMP\_setup\_icv\_copy);
1711 
1712     \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(team && new\_nproc && new\_icvs);
1713     \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}((!\hyperlink{kmp__os_8h_acd6256e4afba32d90997235fc0a38a74}{TCR\_4}(\hyperlink{kmp_8h_aa23ece0d05f38387c8a8441aaad368df}{\_\_kmp\_init\_parallel})) || new\_icvs->
      \hyperlink{structkmp__internal__control_a807067319fd06b644c3aecefadac01e6}{nproc});
1714 
1715     \textcolor{comment}{/* Master thread's copy of the ICVs was set up on the implicit taskdata in}
1716 \textcolor{comment}{       \_\_kmp\_reinitialize\_team. \_\_kmp\_fork\_call() assumes the master thread's implicit task has}
1717 \textcolor{comment}{       this data before this function is called. */}
1718 \textcolor{preprocessor}{#if KMP\_BARRIER\_ICV\_PULL}
1719 \textcolor{preprocessor}{}    \textcolor{comment}{/* Copy ICVs to master's thread structure into th\_fixed\_icvs (which remains untouched), where}
1720 \textcolor{comment}{       all of the worker threads can access them and make their own copies after the barrier. */}
1721     \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads[0]);  \textcolor{comment}{// The threads arrays should be allocated at
       this point}
1722     \hyperlink{kmp_8h_a87574bd68566bdaab6ba1cd63223ab46}{copy\_icvs}(&team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads[0]->th.th\_bar[\hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cfab7dbfe1300085e4a7825c809112aaf7c}{bs\_forkjoin\_barrier}].bb.
      th\_fixed\_icvs, new\_icvs);
1723     \hyperlink{kmp__debug_8h_aa77d06a01f304e7b70fe1f4b052a1b57}{KF\_TRACE}(10, (\textcolor{stringliteral}{"\_\_kmp\_setup\_icv\_copy: PULL: T#%d this\_thread=%p team=%p\(\backslash\)n"},
1724                   0, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads[0], team));
1725 \textcolor{preprocessor}{#elif KMP\_BARRIER\_ICV\_PUSH}
1726 \textcolor{preprocessor}{}    \textcolor{comment}{// The ICVs will be propagated in the fork barrier, so nothing needs to be done here.}
1727     \hyperlink{kmp__debug_8h_aa77d06a01f304e7b70fe1f4b052a1b57}{KF\_TRACE}(10, (\textcolor{stringliteral}{"\_\_kmp\_setup\_icv\_copy: PUSH: T#%d this\_thread=%p team=%p\(\backslash\)n"},
1728                   0, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads[0], team));
1729 \textcolor{preprocessor}{#else}
1730 \textcolor{preprocessor}{}    \textcolor{comment}{// Copy the ICVs to each of the non-master threads.  This takes O(nthreads) time.}
1731     \hyperlink{kmp__barrier_8cpp_a041fcfa491f1f402a50d53fb23c915bb}{ngo\_load}(new\_icvs);
1732     \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads[0]);  \textcolor{comment}{// The threads arrays should be allocated at
       this point}
1733     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} f=1; f<new\_nproc; ++f) \{ \textcolor{comment}{// Skip the master thread}
1734         \textcolor{comment}{// TODO: GEH - pass in better source location info since usually NULL here}
1735         \hyperlink{kmp__debug_8h_aa77d06a01f304e7b70fe1f4b052a1b57}{KF\_TRACE}(10, (\textcolor{stringliteral}{"\_\_kmp\_setup\_icv\_copy: LINEAR: T#%d this\_thread=%p team=%p\(\backslash\)n"},
1736                       f, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads[f], team));
1737         \hyperlink{kmp_8h_a8387c1b95f3b497a14fc3916515ad4c3}{\_\_kmp\_init\_implicit\_task}(loc, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads[f], team, f, 
      \hyperlink{kmp_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE});
1738         \hyperlink{kmp__barrier_8cpp_a12530abe295809b23e5f414fa302448b}{ngo\_store\_icvs}(&team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_implicit\_task\_taskdata[f].td\_icvs, new\_icvs);
1739         \hyperlink{kmp__debug_8h_aa77d06a01f304e7b70fe1f4b052a1b57}{KF\_TRACE}(10, (\textcolor{stringliteral}{"\_\_kmp\_setup\_icv\_copy: LINEAR: T#%d this\_thread=%p team=%p\(\backslash\)n"},
1740                       f, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads[f], team));
1741     \}
1742     \hyperlink{kmp__barrier_8cpp_a303ca33adc792fd05f7da5d34b75aa4c}{ngo\_sync}();
1743 \textcolor{preprocessor}{#endif // KMP\_BARRIER\_ICV\_PULL}
1744 \textcolor{preprocessor}{}\}
\end{DoxyCode}
\hypertarget{kmp__barrier_8cpp_a7055b9bc973e4cab4e2b3144d0da2e6d}{\index{kmp\-\_\-barrier.\-cpp@{kmp\-\_\-barrier.\-cpp}!\-\_\-\-\_\-kmp\-\_\-tree\-\_\-barrier\-\_\-gather@{\-\_\-\-\_\-kmp\-\_\-tree\-\_\-barrier\-\_\-gather}}
\index{\-\_\-\-\_\-kmp\-\_\-tree\-\_\-barrier\-\_\-gather@{\-\_\-\-\_\-kmp\-\_\-tree\-\_\-barrier\-\_\-gather}!kmp_barrier.cpp@{kmp\-\_\-barrier.\-cpp}}
\subsubsection[{\-\_\-\-\_\-kmp\-\_\-tree\-\_\-barrier\-\_\-gather}]{\setlength{\rightskip}{0pt plus 5cm}static {\bf void} \-\_\-\-\_\-kmp\-\_\-tree\-\_\-barrier\-\_\-gather (
\begin{DoxyParamCaption}
\item[{enum {\bf barrier\-\_\-type}}]{bt, }
\item[{{\bf kmp\-\_\-info\-\_\-t} $\ast$}]{this\-\_\-thr, }
\item[{{\bf int}}]{gtid, }
\item[{{\bf int}}]{tid, }
\item[{{\bf void}($\ast$)({\bf void} $\ast$, {\bf void} $\ast$) {\bf U\-S\-E\-\_\-\-I\-T\-T\-\_\-\-B\-U\-I\-L\-D\-\_\-\-A\-R\-G} reduce({\bf void} $\ast$itt\-\_\-sync\-\_\-obj)}]{}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{kmp__barrier_8cpp_a7055b9bc973e4cab4e2b3144d0da2e6d}


Definition at line 219 of file kmp\-\_\-barrier.\-cpp.



Referenced by \-\_\-\-\_\-kmp\-\_\-barrier(), and \-\_\-\-\_\-kmp\-\_\-join\-\_\-barrier().


\begin{DoxyCode}
222 \{
223     \hyperlink{kmp__stats_8h_a340afca3214165ed1920481f0e8fa67c}{KMP\_TIME\_DEVELOPER\_BLOCK}(KMP\_tree\_gather);
224     \textcolor{keyword}{register} \hyperlink{unionkmp__team}{kmp\_team\_t} *team = this\_thr->th.th\_team;
225     \textcolor{keyword}{register} \hyperlink{kmp_8h_a1493aa680c299d09746e1edfc9116b24}{kmp\_bstate\_t} *thr\_bar = &this\_thr->th.th\_bar[bt].bb;
226     \textcolor{keyword}{register} \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\_info\_t} **other\_threads = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads;
227     \textcolor{keyword}{register} kmp\_uint32 nproc = this\_thr->th.th\_team\_nproc;
228     \textcolor{keyword}{register} kmp\_uint32 branch\_bits = \hyperlink{kmp_8h_ac686c46b38f93904467b30f15ec1c15e}{\_\_kmp\_barrier\_gather\_branch\_bits}[bt];
229     \textcolor{keyword}{register} kmp\_uint32 branch\_factor = 1 << branch\_bits;
230     \textcolor{keyword}{register} kmp\_uint32 child;
231     \textcolor{keyword}{register} kmp\_uint32 child\_tid;
232     \textcolor{keyword}{register} kmp\_uint64 new\_state;
233 
234     \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_tree\_barrier\_gather: T#%d(%d:%d) enter for barrier type %d\(\backslash\)n"},
235                   gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, bt));
236     \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(this\_thr == other\_threads[this\_thr->th.th\_info.ds.ds\_tid]);
237 
238 \textcolor{preprocessor}{#if USE\_ITT\_BUILD && USE\_ITT\_NOTIFY}
239 \textcolor{preprocessor}{}    \textcolor{comment}{// Barrier imbalance - save arrive time to the thread}
240     \textcolor{keywordflow}{if}(\_\_kmp\_forkjoin\_frames\_mode == 3 || \_\_kmp\_forkjoin\_frames\_mode == 2) \{
241         this\_thr->th.th\_bar\_arrive\_time = this\_thr->th.th\_bar\_min\_time = \_\_itt\_get\_timestamp();
242     \}
243 \textcolor{preprocessor}{#endif}
244 \textcolor{preprocessor}{}    \textcolor{comment}{// Perform tree gather to wait until all threads have arrived; reduce any required data as we go}
245     child\_tid = (tid << branch\_bits) + 1;
246     \textcolor{keywordflow}{if} (child\_tid < nproc) \{
247         \textcolor{comment}{// Parent threads wait for all their children to arrive}
248         new\_state = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_bar[bt].b\_arrived + \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP};
249         child = 1;
250         \textcolor{keywordflow}{do} \{
251             \textcolor{keyword}{register} \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\_info\_t} *child\_thr = other\_threads[child\_tid];
252             \textcolor{keyword}{register} \hyperlink{kmp_8h_a1493aa680c299d09746e1edfc9116b24}{kmp\_bstate\_t} *child\_bar = &child\_thr->th.th\_bar[bt].bb;
253 \textcolor{preprocessor}{#if KMP\_CACHE\_MANAGE}
254 \textcolor{preprocessor}{}            \textcolor{comment}{// Prefetch next thread's arrived count}
255             \textcolor{keywordflow}{if} (child+1 <= branch\_factor && child\_tid+1 < nproc)
256                 \hyperlink{kmp__os_8h_a936407f18975a175fbff4bddca4ff389}{KMP\_CACHE\_PREFETCH}(&other\_threads[child\_tid+1]->th.th\_bar[bt].bb.
      b\_arrived);
257 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* KMP\_CACHE\_MANAGE */}\textcolor{preprocessor}{}
258 \textcolor{preprocessor}{}            \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_tree\_barrier\_gather: T#%d(%d:%d) wait T#%d(%d:%u) "}
259                           \textcolor{stringliteral}{"arrived(%p) == %llu\(\backslash\)n"}, gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid,
260                             \hyperlink{kmp_8h_a66d8a210d86c996e250ea9971fe3cd3a}{\_\_kmp\_gtid\_from\_tid}(child\_tid, team), team->
      \hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, child\_tid,
261                             &child\_bar->b\_arrived, new\_state));
262             \textcolor{comment}{// Wait for child to arrive}
263             \hyperlink{classkmp__flag__64}{kmp\_flag\_64} flag(&child\_bar->b\_arrived, new\_state);
264             flag.wait(this\_thr, \hyperlink{kmp_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE}
265                       \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
266 \textcolor{preprocessor}{#if USE\_ITT\_BUILD && USE\_ITT\_NOTIFY}
267 \textcolor{preprocessor}{}            \textcolor{comment}{// Barrier imbalance - write min of the thread time and a child time to the thread.}
268             \textcolor{keywordflow}{if} (\_\_kmp\_forkjoin\_frames\_mode == 2) \{
269                 this\_thr->th.th\_bar\_min\_time = \hyperlink{kmp_8h_a635727f200be45c0c7cdc13c991284bf}{KMP\_MIN}(this\_thr->th.th\_bar\_min\_time,
270                                                           child\_thr->th.th\_bar\_min\_time);
271             \}
272 \textcolor{preprocessor}{#endif}
273 \textcolor{preprocessor}{}            \textcolor{keywordflow}{if} (reduce) \{
274                 \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(100, (\textcolor{stringliteral}{"\_\_kmp\_tree\_barrier\_gather: T#%d(%d:%d) += T#%d(%d:%u)\(\backslash\)n"},
275                                gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, \hyperlink{kmp_8h_a66d8a210d86c996e250ea9971fe3cd3a}{\_\_kmp\_gtid\_from\_tid}(child\_tid, 
      team),
276                                team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, child\_tid));
277                 (*reduce)(this\_thr->th.th\_local.reduce\_data, child\_thr->th.th\_local.reduce\_data);
278             \}
279             child++;
280             child\_tid++;
281         \}
282         \textcolor{keywordflow}{while} (child <= branch\_factor && child\_tid < nproc);
283     \}
284 
285     \textcolor{keywordflow}{if} (!\hyperlink{kmp_8h_a7a4e2494d803bbee99f23af2117f6dd8}{KMP\_MASTER\_TID}(tid)) \{ \textcolor{comment}{// Worker threads}
286         \textcolor{keyword}{register} kmp\_int32 parent\_tid = (tid - 1) >> branch\_bits;
287 
288         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_tree\_barrier\_gather: T#%d(%d:%d) releasing T#%d(%d:%d) "}
289                       \textcolor{stringliteral}{"arrived(%p): %llu => %llu\(\backslash\)n"}, gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid,
290                       \hyperlink{kmp_8h_a66d8a210d86c996e250ea9971fe3cd3a}{\_\_kmp\_gtid\_from\_tid}(parent\_tid, team), team->
      \hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, parent\_tid,
291                       &thr\_bar->b\_arrived, thr\_bar->b\_arrived,
292                       thr\_bar->b\_arrived + \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP}));
293 
294         \textcolor{comment}{// Mark arrival to parent thread}
295         \textcolor{comment}{/* After performing this write, a worker thread may not assume that the team is valid}
296 \textcolor{comment}{           any more - it could be deallocated by the master thread at any time.  */}
297         \hyperlink{classkmp__flag__64}{kmp\_flag\_64} flag(&thr\_bar->b\_arrived, other\_threads[parent\_tid]);
298         flag.release();
299     \} \textcolor{keywordflow}{else} \{
300         \textcolor{comment}{// Need to update the team arrived pointer if we are the master thread}
301         \textcolor{keywordflow}{if} (nproc > 1) \textcolor{comment}{// New value was already computed above}
302             team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_bar[bt].b\_arrived = new\_state;
303         \textcolor{keywordflow}{else}
304             team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_bar[bt].b\_arrived += \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP};
305         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_tree\_barrier\_gather: T#%d(%d:%d) set team %d arrived(%p) = %llu\(\backslash\)n"},
306                       gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id,
307                       &team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_bar[bt].b\_arrived, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_bar[bt].b\_arrived));
308     \}
309     \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_tree\_barrier\_gather: T#%d(%d:%d) exit for barrier type %d\(\backslash\)n"},
310                   gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, bt));
311 \}
\end{DoxyCode}
\hypertarget{kmp__barrier_8cpp_a077185278bc81fb20a160dbeb7419e8c}{\index{kmp\-\_\-barrier.\-cpp@{kmp\-\_\-barrier.\-cpp}!\-\_\-\-\_\-kmp\-\_\-tree\-\_\-barrier\-\_\-release@{\-\_\-\-\_\-kmp\-\_\-tree\-\_\-barrier\-\_\-release}}
\index{\-\_\-\-\_\-kmp\-\_\-tree\-\_\-barrier\-\_\-release@{\-\_\-\-\_\-kmp\-\_\-tree\-\_\-barrier\-\_\-release}!kmp_barrier.cpp@{kmp\-\_\-barrier.\-cpp}}
\subsubsection[{\-\_\-\-\_\-kmp\-\_\-tree\-\_\-barrier\-\_\-release}]{\setlength{\rightskip}{0pt plus 5cm}static {\bf void} \-\_\-\-\_\-kmp\-\_\-tree\-\_\-barrier\-\_\-release (
\begin{DoxyParamCaption}
\item[{enum {\bf barrier\-\_\-type}}]{bt, }
\item[{{\bf kmp\-\_\-info\-\_\-t} $\ast$}]{this\-\_\-thr, }
\item[{{\bf int}}]{gtid, }
\item[{{\bf int}}]{tid, }
\item[{{\bf int} propagate\-\_\-icvs }]{U\-S\-E\-\_\-\-I\-T\-T\-\_\-\-B\-U\-I\-L\-D\-\_\-\-A\-R\-Gvoid $\ast$itt\-\_\-sync\-\_\-obj}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{kmp__barrier_8cpp_a077185278bc81fb20a160dbeb7419e8c}


Definition at line 314 of file kmp\-\_\-barrier.\-cpp.



Referenced by \-\_\-\-\_\-kmp\-\_\-barrier(), \-\_\-\-\_\-kmp\-\_\-end\-\_\-split\-\_\-barrier(), and \-\_\-\-\_\-kmp\-\_\-fork\-\_\-barrier().


\begin{DoxyCode}
317 \{
318     \hyperlink{kmp__stats_8h_a340afca3214165ed1920481f0e8fa67c}{KMP\_TIME\_DEVELOPER\_BLOCK}(KMP\_tree\_release);
319     \textcolor{keyword}{register} \hyperlink{unionkmp__team}{kmp\_team\_t} *team;
320     \textcolor{keyword}{register} \hyperlink{kmp_8h_a1493aa680c299d09746e1edfc9116b24}{kmp\_bstate\_t} *thr\_bar = &this\_thr->th.th\_bar[bt].bb;
321     \textcolor{keyword}{register} kmp\_uint32 nproc;
322     \textcolor{keyword}{register} kmp\_uint32 branch\_bits = \hyperlink{kmp_8h_a80498c680499eb06d890901bada7c2ca}{\_\_kmp\_barrier\_release\_branch\_bits}[bt
      ];
323     \textcolor{keyword}{register} kmp\_uint32 branch\_factor = 1 << branch\_bits;
324     \textcolor{keyword}{register} kmp\_uint32 child;
325     \textcolor{keyword}{register} kmp\_uint32 child\_tid;
326 
327     \textcolor{comment}{// Perform a tree release for all of the threads that have been gathered}
328     \textcolor{keywordflow}{if} (!\hyperlink{kmp_8h_a7a4e2494d803bbee99f23af2117f6dd8}{KMP\_MASTER\_TID}(tid)) \{ \textcolor{comment}{// Handle fork barrier workers who aren't part of a team yet}
329         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_tree\_barrier\_release: T#%d wait go(%p) == %u\(\backslash\)n"},
330                       gtid, &thr\_bar->b\_go, \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP}));
331         \textcolor{comment}{// Wait for parent thread to release us}
332         \hyperlink{classkmp__flag__64}{kmp\_flag\_64} flag(&thr\_bar->b\_go, \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP});
333         flag.wait(this\_thr, \hyperlink{kmp_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE}
334                   \hyperlink{kmp__itt_8h_ac31864b9b5b30f5dcac5ab285ee97ae0}{USE\_ITT\_BUILD\_ARG}(itt\_sync\_obj) );
335 \textcolor{preprocessor}{#if USE\_ITT\_BUILD && USE\_ITT\_NOTIFY}
336 \textcolor{preprocessor}{}        \textcolor{keywordflow}{if} ((\hyperlink{group__sync_gab7f1ba7abf5c98e0e0e0ea53d0e34661}{\_\_itt\_sync\_create\_ptr} && itt\_sync\_obj == NULL) || KMP\_ITT\_DEBUG) \{
337             \textcolor{comment}{// In fork barrier where we could not get the object reliably (or ITTNOTIFY is disabled)}
338             itt\_sync\_obj = \_\_kmp\_itt\_barrier\_object(gtid, \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cfab7dbfe1300085e4a7825c809112aaf7c}{bs\_forkjoin\_barrier}, 0, -1);
339             \textcolor{comment}{// Cancel wait on previous parallel region...}
340             \_\_kmp\_itt\_task\_starting(itt\_sync\_obj);
341 
342             \textcolor{keywordflow}{if} (bt == \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cfab7dbfe1300085e4a7825c809112aaf7c}{bs\_forkjoin\_barrier} && \hyperlink{kmp__os_8h_acd6256e4afba32d90997235fc0a38a74}{TCR\_4}(
      \hyperlink{kmp_8h_a11b71922a4df46ff9e8dbc68693e8d67}{\_\_kmp\_global}.g.g\_done))
343                 \textcolor{keywordflow}{return};
344 
345             itt\_sync\_obj = \_\_kmp\_itt\_barrier\_object(gtid, \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cfab7dbfe1300085e4a7825c809112aaf7c}{bs\_forkjoin\_barrier});
346             \textcolor{keywordflow}{if} (itt\_sync\_obj != NULL)
347                 \textcolor{comment}{// Call prepare as early as possible for "new" barrier}
348                 \_\_kmp\_itt\_task\_finished(itt\_sync\_obj);
349         \} \textcolor{keywordflow}{else}
350 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* USE\_ITT\_BUILD && USE\_ITT\_NOTIFY */}\textcolor{preprocessor}{}
351 \textcolor{preprocessor}{}        \textcolor{comment}{// Early exit for reaping threads releasing forkjoin barrier}
352         \textcolor{keywordflow}{if} (bt == \hyperlink{kmp_8h_ad0f7c21f2f1d446087ef5714eb0fd8cfab7dbfe1300085e4a7825c809112aaf7c}{bs\_forkjoin\_barrier} && \hyperlink{kmp__os_8h_acd6256e4afba32d90997235fc0a38a74}{TCR\_4}(
      \hyperlink{kmp_8h_a11b71922a4df46ff9e8dbc68693e8d67}{\_\_kmp\_global}.g.g\_done))
353             \textcolor{keywordflow}{return};
354 
355         \textcolor{comment}{// The worker thread may now assume that the team is valid.}
356         team = \hyperlink{kmp_8h_a8ba907eb5a2568ff55a49a1504cd3624}{\_\_kmp\_threads}[gtid]->th.th\_team;
357         \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(team != NULL);
358         tid = \hyperlink{kmp_8h_afb8f84fff9682417eb1c484ffbfdc6ee}{\_\_kmp\_tid\_from\_gtid}(gtid);
359 
360         \hyperlink{kmp__os_8h_ae67779cc7794b5dd7eee4c7f2c7789d4}{TCW\_4}(thr\_bar->b\_go, \hyperlink{kmp_8h_abf682c7f66b0baa7f7184ac388224569}{KMP\_INIT\_BARRIER\_STATE});
361         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_tree\_barrier\_release: T#%d(%d:%d) set go(%p) = %u\(\backslash\)n"},
362                       gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, &thr\_bar->b\_go, 
      \hyperlink{kmp_8h_abf682c7f66b0baa7f7184ac388224569}{KMP\_INIT\_BARRIER\_STATE}));
363         \hyperlink{kmp__os_8h_ab19ae0836bf2f1ac24e5cfc97c6d7d41}{KMP\_MB}();  \textcolor{comment}{// Flush all pending memory write invalidates.}
364     \} \textcolor{keywordflow}{else} \{
365         team = \hyperlink{kmp_8h_a8ba907eb5a2568ff55a49a1504cd3624}{\_\_kmp\_threads}[gtid]->th.th\_team;
366         \hyperlink{kmp__debug_8h_ad766efc30e33e28634691088e80cdf08}{KMP\_DEBUG\_ASSERT}(team != NULL);
367         \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_tree\_barrier\_release: T#%d(%d:%d) master enter for barrier type %d\(\backslash\)n"},
368                       gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, bt));
369     \}
370     nproc = this\_thr->th.th\_team\_nproc;
371     child\_tid = (tid << branch\_bits) + 1;
372 
373     \textcolor{keywordflow}{if} (child\_tid < nproc) \{
374         \textcolor{keyword}{register} \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\_info\_t} **other\_threads = team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads;
375         child = 1;
376         \textcolor{comment}{// Parent threads release all their children}
377         \textcolor{keywordflow}{do} \{
378             \textcolor{keyword}{register} \hyperlink{kmp_8h_a194859801fe16b326efe34501a37c30a}{kmp\_info\_t} *child\_thr = other\_threads[child\_tid];
379             \textcolor{keyword}{register} \hyperlink{kmp_8h_a1493aa680c299d09746e1edfc9116b24}{kmp\_bstate\_t} *child\_bar = &child\_thr->th.th\_bar[bt].bb;
380 \textcolor{preprocessor}{#if KMP\_CACHE\_MANAGE}
381 \textcolor{preprocessor}{}            \textcolor{comment}{// Prefetch next thread's go count}
382             \textcolor{keywordflow}{if} (child+1 <= branch\_factor && child\_tid+1 < nproc)
383                 \hyperlink{kmp__os_8h_a936407f18975a175fbff4bddca4ff389}{KMP\_CACHE\_PREFETCH}(&other\_threads[child\_tid+1]->th.th\_bar[bt].bb.b\_go);
384 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* KMP\_CACHE\_MANAGE */}\textcolor{preprocessor}{}
385 \textcolor{preprocessor}{}
386 \textcolor{preprocessor}{#if KMP\_BARRIER\_ICV\_PUSH}
387 \textcolor{preprocessor}{}            \{
388                 \hyperlink{kmp__stats_8h_a340afca3214165ed1920481f0e8fa67c}{KMP\_TIME\_DEVELOPER\_BLOCK}(USER\_icv\_copy);
389                 \textcolor{keywordflow}{if} (propagate\_icvs) \{
390                     \hyperlink{kmp_8h_a8387c1b95f3b497a14fc3916515ad4c3}{\_\_kmp\_init\_implicit\_task}(team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_ident, team->
      \hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_threads[child\_tid],
391                                              team, child\_tid, \hyperlink{kmp_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE});
392                     \hyperlink{kmp_8h_a87574bd68566bdaab6ba1cd63223ab46}{copy\_icvs}(&team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_implicit\_task\_taskdata[child\_tid].td\_icvs,
393                               &team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_implicit\_task\_taskdata[0].td\_icvs);
394                 \}
395             \}
396 \textcolor{preprocessor}{#endif // KMP\_BARRIER\_ICV\_PUSH}
397 \textcolor{preprocessor}{}            \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_tree\_barrier\_release: T#%d(%d:%d) releasing T#%d(%d:%u)"}
398                           \textcolor{stringliteral}{"go(%p): %u => %u\(\backslash\)n"}, gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid,
399                           \hyperlink{kmp_8h_a66d8a210d86c996e250ea9971fe3cd3a}{\_\_kmp\_gtid\_from\_tid}(child\_tid, team), team->
      \hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id,
400                           child\_tid, &child\_bar->b\_go, child\_bar->b\_go,
401                           child\_bar->b\_go + \hyperlink{kmp_8h_ae7c48b0e6ec41f1300d964344915b7d5}{KMP\_BARRIER\_STATE\_BUMP}));
402             \textcolor{comment}{// Release child from barrier}
403             \hyperlink{classkmp__flag__64}{kmp\_flag\_64} flag(&child\_bar->b\_go, child\_thr);
404             flag.release();
405             child++;
406             child\_tid++;
407         \}
408         \textcolor{keywordflow}{while} (child <= branch\_factor && child\_tid < nproc);
409     \}
410     \hyperlink{kmp__debug_8h_a21d51f37cb197aca5ffe737531678830}{KA\_TRACE}(20, (\textcolor{stringliteral}{"\_\_kmp\_tree\_barrier\_release: T#%d(%d:%d) exit for barrier type %d\(\backslash\)n"},
411                   gtid, team->\hyperlink{unionkmp__team_a87cf4571108a61b446e809094f8c0362}{t}.t\_id, tid, bt));
412 \}
\end{DoxyCode}
