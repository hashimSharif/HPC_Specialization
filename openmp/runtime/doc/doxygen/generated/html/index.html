<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>LLVM OpenMP* Runtime Library: LLVM&nbsp; OpenMP* Runtime Library Interface</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">LLVM OpenMP* Runtime Library
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">LLVM&#160; OpenMP* Runtime Library Interface </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="sec_intro"></a>
Introduction</h1>
<p>This document describes the interface provided by the LLVM &#160;OpenMP<sup>*</sup> runtime library to the compiler. Routines that are directly called as simple functions by user code are not currently described here, since their definition is in the OpenMP specification available from <a href="http://openmp.org">http://openmp.org</a></p>
<p>The aim here is to explain the interface from the compiler to the runtime.</p>
<p>The overall design is described, and each function in the interface has its own description. (At least, that's the ambition, we may not be there yet).</p>
<h1><a class="anchor" id="sec_building"></a>
Quickly Building the Runtime</h1>
<p>For the impatient, we cover building the runtime as the first topic here.</p>
<p>CMake is used to build the OpenMP runtime. For details and a full list of options for the CMake build system, see <code>Build_With_CMake.txt</code> inside the <code>runtime/</code> subdirectory. These instructions will provide the most typical build.</p>
<p>In-LLVM-tree build:. </p>
<div class="fragment"><div class="line">$ cd where-you-want-to-live</div>
<div class="line">Check out openmp into llvm/projects</div>
<div class="line">$ cd where-you-want-to-build</div>
<div class="line">$ mkdir build &amp;&amp; cd build</div>
<div class="line">$ cmake path/to/llvm -DCMAKE_C_COMPILER=&lt;C compiler&gt; -DCMAKE_CXX_COMPILER=&lt;C++ compiler&gt;</div>
<div class="line">$ make omp</div>
</div><!-- fragment --><p> Out-of-LLVM-tree build: </p>
<div class="fragment"><div class="line">$ cd where-you-want-to-live</div>
<div class="line">Check out openmp</div>
<div class="line">$ cd where-you-want-to-live/openmp/runtime</div>
<div class="line">$ mkdir build &amp;&amp; cd build</div>
<div class="line">$ cmake path/to/openmp -DCMAKE_C_COMPILER=&lt;C compiler&gt; -DCMAKE_CXX_COMPILER=&lt;C++ compiler&gt;</div>
<div class="line">$ make</div>
</div><!-- fragment --><h1><a class="anchor" id="sec_supported"></a>
Supported RTL Build Configurations</h1>
<p>The architectures supported are IA-32 architecture, Intel&reg;&#160; 64, and Intel&reg;&#160; Many Integrated Core Architecture. The build configurations supported are shown in the table below.</p>
<table  border="1">
<tr>
<th></th><th>icc/icl</th><th>gcc</th><th>clang </th></tr>
<tr>
<td>Linux<sup>*</sup> OS</td><td>Yes(1,5)</td><td>Yes(2,4)</td><td>Yes(4,6,7) </td></tr>
<tr>
<td>FreeBSD<sup>*</sup></td><td>Yes(1,5)</td><td>Yes(2,4)</td><td>Yes(4,6,7,8) </td></tr>
<tr>
<td>OS X<sup>*</sup></td><td>Yes(1,3,4)</td><td>No</td><td>Yes(4,6,7) </td></tr>
<tr>
<td>Windows<sup>*</sup> OS</td><td>Yes(1,4)</td><td>No</td><td>No </td></tr>
</table>
<p>(1) On IA-32 architecture and Intel&reg;&#160; 64, icc/icl versions 12.x are supported (12.1 is recommended).<br/>
 (2) gcc version 4.7 is supported.<br/>
 (3) For icc on OS X<sup>*</sup>, OS X<sup>*</sup> version 10.5.8 is supported.<br/>
 (4) Intel&reg;&#160; Many Integrated Core Architecture not supported.<br/>
 (5) On Intel&reg;&#160; Many Integrated Core Architecture, icc/icl versions 13.0 or later are required.<br/>
 (6) Clang<sup>*</sup> version 3.3 is supported.<br/>
 (7) Clang<sup>*</sup> currently does not offer a software-implemented 128 bit extended precision type. Thus, all entry points reliant on this type are removed from the library and cannot be called in the user program. The following functions are not available: </p>
<div class="fragment"><div class="line">__kmpc_atomic_cmplx16_*</div>
<div class="line">__kmpc_atomic_float16_*</div>
<div class="line">__kmpc_atomic_*_fp</div>
</div><!-- fragment --><p> (8) Community contribution provided AS IS, not tested by Intel.</p>
<p>Supported Architectures: IBM(R) Power 7 and Power 8 </p>
<table  border="1">
<tr>
<th></th><th>gcc</th><th>clang </th></tr>
<tr>
<td>Linux<sup>*</sup> OS</td><td>Yes(1,2)</td><td>Yes(3,4) </td></tr>
</table>
<p>(1) On Power 7, gcc version 4.8.2 is supported.<br/>
 (2) On Power 8, gcc version 4.8.2 is supported.<br/>
 (3) On Power 7, clang version 3.7 is supported.<br/>
 (4) On Power 8, clang version 3.7 is supported.<br/>
</p>
<h1><a class="anchor" id="sec_frontend"></a>
Front-end Compilers that work with this RTL</h1>
<p>The following compilers are known to do compatible code generation for this RTL: icc/icl, gcc. Code generation is discussed in more detail later in this document.</p>
<h1><a class="anchor" id="sec_outlining"></a>
Outlining</h1>
<p>The runtime interface is based on the idea that the compiler "outlines" sections of code that are to run in parallel into separate functions that can then be invoked in multiple threads. For instance, simple code like this</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> foo()</div>
<div class="line">{</div>
<div class="line"><span class="preprocessor">#pragma omp parallel</span></div>
<div class="line"><span class="preprocessor"></span>    {</div>
<div class="line">        ... <span class="keywordflow">do</span> something ...</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p> is converted into something that looks conceptually like this (where the names used are merely illustrative; the real library function names will be used later after we've discussed some more issues...)</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> outlinedFooBody()</div>
<div class="line">{</div>
<div class="line">    ... <span class="keywordflow">do</span> something ...</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> foo()</div>
<div class="line">{</div>
<div class="line">    __OMP_runtime_fork(outlinedFooBody, (<span class="keywordtype">void</span>*)0);   <span class="comment">// Not the real function name!</span></div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="SEC_SHAREDVARS"></a>
Addressing shared variables</h2>
<p>In real uses of the OpenMP<sup>*</sup> API there are normally references from the outlined code to shared variables that are in scope in the containing function. Therefore the containing function must be able to address these variables. The runtime supports two alternate ways of doing this.</p>
<h3><a class="anchor" id="SEC_SEC_OT"></a>
Current Technique</h3>
<p>The technique currently supported by the runtime library is to receive a separate pointer to each shared variable that can be accessed from the outlined function. This is what is shown in the example below.</p>
<p>We hope soon to provide an alternative interface to support the alternate implementation described in the next section. The alternative implementation has performance advantages for small parallel regions that have many shared variables.</p>
<h3><a class="anchor" id="SEC_SEC_PT"></a>
Future Technique</h3>
<p>The idea is to treat the outlined function as though it were a lexically nested function, and pass it a single argument which is the pointer to the parent's stack frame. Provided that the compiler knows the layout of the parent frame when it is generating the outlined function it can then access the up-level variables at appropriate offsets from the parent frame. This is a classical compiler technique from the 1960s to support languages like Algol (and its descendants) that support lexically nested functions.</p>
<p>The main benefit of this technique is that there is no code required at the fork point to marshal the arguments to the outlined function. Since the runtime knows statically how many arguments must be passed to the outlined function, it can easily copy them to the thread's stack frame. Therefore the performance of the fork code is independent of the number of shared variables that are accessed by the outlined function.</p>
<p>If it is hard to determine the stack layout of the parent while generating the outlined code, it is still possible to use this approach by collecting all of the variables in the parent that are accessed from outlined functions into a single <code>struct</code> which is placed on the stack, and whose address is passed to the outlined functions. In this way the offsets of the shared variables are known (since they are inside the struct) without needing to know the complete layout of the parent stack-frame. From the point of view of the runtime either of these techniques is equivalent, since in either case it only has to pass a single argument to the outlined function to allow it to access shared variables.</p>
<p>A scheme like this is how gcc<sup>*</sup> generates outlined functions.</p>
<h1><a class="anchor" id="SEC_INTERFACES"></a>
Library Interfaces</h1>
<p>The library functions used for specific parts of the OpenMP<sup>*</sup> language implementation are documented in different modules.</p>
<ul>
<li><a class="el" href="group__BASIC__TYPES.html">Basic Types</a> fundamental types used by the runtime in many places</li>
<li><a class="el" href="group__DEPRECATED.html">Deprecated Functions</a> functions that are in the library but are no longer required</li>
<li><a class="el" href="group__STARTUP__SHUTDOWN.html">Startup and Shutdown</a> functions for initializing and finalizing the runtime</li>
<li><a class="el" href="group__PARALLEL.html">Parallel (fork/join)</a> functions for implementing <code>omp parallel</code></li>
<li><a class="el" href="group__THREAD__STATES.html">Thread Information</a> functions for supporting thread state inquiries</li>
<li><a class="el" href="group__WORK__SHARING.html">Work Sharing</a> functions for work sharing constructs such as <code>omp for</code>, <code>omp sections</code></li>
<li><a class="el" href="group__THREADPRIVATE.html">Thread private data support</a> functions to support thread private data, copyin etc</li>
<li><a class="el" href="group__SYNCHRONIZATION.html">Synchronization</a> functions to support <code>omp critical</code>, <code>omp barrier</code>, <code>omp master</code>, reductions etc</li>
<li><a class="el" href="group__ATOMIC__OPS.html">Atomic Operations</a> functions to support atomic operations</li>
<li><a class="el" href="group__STATS__GATHERING.html">Statistics Gathering from OMPTB</a> macros to support developer profiling of libomp</li>
<li>Documentation on tasking has still to be written...</li>
</ul>
<h1><a class="anchor" id="SEC_EXAMPLES"></a>
Examples</h1>
<h2><a class="anchor" id="SEC_WORKSHARING_EXAMPLE"></a>
Work Sharing Example</h2>
<p>This example shows the code generated for a parallel for with reduction and dynamic scheduling.</p>
<div class="fragment"><div class="line"><span class="keyword">extern</span> <span class="keywordtype">float</span> foo( <span class="keywordtype">void</span> );</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main () {</div>
<div class="line">    <span class="keywordtype">int</span> i; </div>
<div class="line">    <span class="keywordtype">float</span> r = 0.0; </div>
<div class="line"><span class="preprocessor">    #pragma omp parallel for schedule(dynamic) reduction(+:r) </span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">for</span> ( i = 0; i &lt; 10; i ++ ) {</div>
<div class="line">        r += foo(); </div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>The transformed code looks like this. </p>
<div class="fragment"><div class="line"><span class="keyword">extern</span> <span class="keywordtype">float</span> foo( <span class="keywordtype">void</span> ); </div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main () {</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">int</span> zero = 0; </div>
<div class="line">    <span class="keyword">auto</span> <span class="keywordtype">int</span> gtid; </div>
<div class="line">    <span class="keyword">auto</span> <span class="keywordtype">float</span> r = 0.0; </div>
<div class="line">    <a class="code" href="group__STARTUP__SHUTDOWN.html#ga53f4ef16321f42eeb3b8dd463b51f112">__kmpc_begin</a>( &amp; loc3, 0 ); </div>
<div class="line">    <span class="comment">// The gtid is not actually required in this example so could be omitted;</span></div>
<div class="line">    <span class="comment">// We show its initialization here because it is often required for calls into</span></div>
<div class="line">    <span class="comment">// the runtime and should be locally cached like this.</span></div>
<div class="line">    gtid = __kmpc_global thread num( &amp; loc3 ); </div>
<div class="line">    __kmpc_fork call( &amp; loc7, 1, main_7_parallel_3, &amp; r ); </div>
<div class="line">    <a class="code" href="group__STARTUP__SHUTDOWN.html#gacdedfb2c01fe256ad6c75507644bdfed">__kmpc_end</a>( &amp; loc0 ); </div>
<div class="line">    <span class="keywordflow">return</span> 0; </div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>main_10_reduction_t_5 { <span class="keywordtype">float</span> r_10_rpr; }; </div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> kmp_critical_name lck = { 0 };</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structident.html">ident_t</a> loc10; <span class="comment">// loc10.flags should contain KMP_IDENT_ATOMIC_REDUCE bit set </span></div>
<div class="line">                      <span class="comment">// if compiler has generated an atomic reduction.</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> main_7_parallel_3( <span class="keywordtype">int</span> *gtid, <span class="keywordtype">int</span> *btid, <span class="keywordtype">float</span> *r_7_shp ) {</div>
<div class="line">    <span class="keyword">auto</span> <span class="keywordtype">int</span> i_7_pr; </div>
<div class="line">    <span class="keyword">auto</span> <span class="keywordtype">int</span> lower, upper, liter, incr; </div>
<div class="line">    <span class="keyword">auto</span> <span class="keyword">struct </span>main_10_reduction_t_5 reduce; </div>
<div class="line">    reduce.r_10_rpr = 0.F; </div>
<div class="line">    liter = 0; </div>
<div class="line">    <a class="code" href="group__WORK__SHARING.html#gae991c61cbe8e2942fe1f757a65442b26">__kmpc_dispatch_init_4</a>( &amp; loc7,*gtid, 35, 0, 9, 1, 1 ); </div>
<div class="line">    <span class="keywordflow">while</span> ( <a class="code" href="group__WORK__SHARING.html#ga5671ff45051907f76cc3d214e1de854b">__kmpc_dispatch_next_4</a>( &amp; loc7, *gtid, &amp; liter, &amp; lower, &amp; upper, &amp; incr ) ) {</div>
<div class="line">        <span class="keywordflow">for</span>( i_7_pr = lower; upper &gt;= i_7_pr; i_7_pr ++ ) </div>
<div class="line">          reduce.r_10_rpr += foo(); </div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">switch</span>( <a class="code" href="group__SYNCHRONIZATION.html#gafc5438d4c4f01dcd347d9bfde27f68e1">__kmpc_reduce_nowait</a>( &amp; loc10, *gtid, 1, 4, &amp; reduce, main_10_reduce_5, &amp; lck ) ) {</div>
<div class="line">        <span class="keywordflow">case</span> 1:</div>
<div class="line">            r_7_shp += reduce.r_10_rpr;</div>
<div class="line">           <a class="code" href="group__SYNCHRONIZATION.html#ga5c40184c6babbe35c50d43a47573c5c5">__kmpc_end_reduce_nowait</a>( &amp; loc10, *gtid, &amp; lck );</div>
<div class="line">           <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 2:</div>
<div class="line">           __kmpc_atomic_float4_add( &amp; loc10, *gtid, r_7_shp, reduce.r_10_rpr );</div>
<div class="line">           <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:;</div>
<div class="line">    }</div>
<div class="line">} </div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> main_10_reduce_5( <span class="keyword">struct</span> main_10_reduction_t_5 *reduce_lhs, </div>
<div class="line">                       <span class="keyword">struct</span> main_10_reduction_t_5 *reduce_rhs ) </div>
<div class="line">{ </div>
<div class="line">    reduce_lhs-&gt;r_10_rpr += reduce_rhs-&gt;r_10_rpr; </div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Mar 24 2016 21:30:31 for LLVM OpenMP* Runtime Library by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
